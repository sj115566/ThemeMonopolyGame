<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å¯Œç¿ä¸»é¡Œç”¢ç”Ÿå™¨ V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; background-color: #f3f4f6; }
        .step-card { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 2rem; }
        .map-container { position: relative; width: 100%; max-width: 800px; margin: 0 auto; border: 2px dashed #cbd5e1; border-radius: 1rem; overflow: hidden; cursor: crosshair; }
        .map-point { position: absolute; width: 24px; height: 24px; background-color: rgba(239, 68, 68, 0.8); border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; font-weight: bold; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        .file-item { display: flex; align-items: center; padding: 8px 12px; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 6px; transition: all 0.2s; }
        .file-item:hover { background: #f8fafc; }
        .file-item.checked { background: #f1f5f9; opacity: 0.6; }
        .file-item.checked span.filename { text-decoration: line-through; }
        .file-required { color: #dc2626; font-size: 0.75rem; font-weight: bold; margin-left: auto; background: #fee2e2; padding: 2px 6px; border-radius: 4px; }
        .file-optional { color: #64748b; font-size: 0.75rem; margin-left: auto; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; }
        .input-group label { display: block; font-size: 0.875rem; font-weight: 700; color: #374151; margin-bottom: 0.25rem; }
        .input-group input, .input-group textarea { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.9rem; }
        .section-title { font-size: 1.125rem; font-weight: 800; color: #1f2937; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb; }
    </style>
</head>
<body class="p-8">
    <div class="max-w-5xl mx-auto">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-2">ğŸ¨ ä¸»é¡Œæ¨¡çµ„ç”¢ç”Ÿå™¨ V2</h1>
        <p class="text-gray-600 mb-8">å®Œå…¨å®¢è£½åŒ–æ‚¨çš„éŠæˆ²ä¸»é¡Œã€è³‡æºèˆ‡å°è©±ï¼</p>

        <!-- æ­¥é©Ÿ 1: åŸºæœ¬è³‡è¨Š -->
        <div class="step-card">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">1. åŸºæœ¬è³‡è¨Š</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="input-group">
                    <label>ä¸»é¡Œ ID (è‹±æ–‡è³‡æ–™å¤¾å)</label>
                    <input type="text" id="theme-id" placeholder="ä¾‹å¦‚: solar_system" value="new_theme">
                </div>
                <div class="input-group">
                    <label>ä¸»é¡Œåç¨± (é¸å–®é¡¯ç¤º)</label>
                    <input type="text" id="theme-name" placeholder="ä¾‹å¦‚: ğŸš€ å¤ªé™½ç³»å¤§å†’éšª" value="æ–°ä¸»é¡Œ">
                </div>
                <div class="input-group md:col-span-2">
                    <label>ä¸»é¡Œæè¿°</label>
                    <input type="text" id="theme-desc" placeholder="ç°¡çŸ­ä»‹ç´¹..." value="é€™æ˜¯ä¸€å€‹å…¨æ–°çš„å†’éšªï¼">
                </div>
                <div class="input-group md:col-span-2">
                    <label>Google App Script (GAS) ç¶²å€</label>
                    <input type="text" id="gas-url" placeholder="https://script.google.com/..." value="è«‹è²¼ä¸Šæ‚¨çš„ GAS ç¶²å€">
                </div>
            </div>
        </div>

        <!-- æ­¥é©Ÿ 2: åœ°åœ–åº§æ¨™ -->
        <div class="step-card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">2. åœ°åœ–åº§æ¨™è¨­å®š</h2>
                <div class="text-sm">å·²è¨­å®š: <span id="point-count" class="font-bold text-blue-600 text-xl">0</span> / 20</div>
            </div>
            <input type="file" id="map-upload" accept="image/*" class="mb-4 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
            <div id="map-preview-container" class="map-container bg-gray-100 hidden">
                <img id="map-preview" class="w-full" style="display: block;">
                <div id="map-points-layer" class="absolute inset-0"></div>
            </div>
            <button id="undo-point" class="mt-4 px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50" disabled>â†©ï¸ å¤åŸä¸Šä¸€é»</button>
        </div>

        <!-- æ­¥é©Ÿ 3: è³‡æºèˆ‡æ–‡å­—è¨­å®š (å…¨æ–°) -->
        <div class="step-card bg-gray-50">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">3. è³‡æºèˆ‡æ–‡å­—è¨­å®š</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- 3.1 æ ¸å¿ƒåœ–ç‰‡ -->
                <div>
                    <h3 class="section-title">ğŸ–¼ï¸ æ ¸å¿ƒåœ–ç‰‡æª”å (img/)</h3>
                    <div class="space-y-3">
                        <div class="input-group"><label>åœ°åœ–èƒŒæ™¯åœ–</label><input type="text" id="img-mapBg" value="map_background.png"></div>
                        <div class="input-group"><label>åš®å° NPC</label><input type="text" id="img-guideNPC" value="guide_bear.png"></div>
                        <div class="input-group"><label>è¼‰å…¥å‹•ç•« (GIF)</label><input type="text" id="img-loadingGif" value="loading_bear.gif"></div>
                    </div>
                </div>

                <!-- 3.2 éŸ³æ•ˆè¨­å®š -->
                <div>
                    <h3 class="section-title">ğŸµ éŸ³æ•ˆæª”å (sound/) (ç•™ç©ºå‰‡ä½¿ç”¨é è¨­)</h3>
                    <div class="space-y-2 grid grid-cols-2 gap-2">
                        <div class="input-group"><label>èƒŒæ™¯éŸ³æ¨‚ (BGM)</label><input type="text" id="sfx-bgm" placeholder="é è¨­ (backgroundMusic.mp3)"></div>
                        <div class="input-group"><label>é»æ“Š (Click)</label><input type="text" id="sfx-click" placeholder="é è¨­ (click.mp3)"></div>
                        <div class="input-group"><label>æ“²éª° (Dice)</label><input type="text" id="sfx-dice" placeholder="é è¨­ (dice.mp3)"></div>
                        <div class="input-group"><label>ç§»å‹• (Move)</label><input type="text" id="sfx-move" placeholder="é è¨­ (move.mp3)"></div>
                        <div class="input-group"><label>ç­”å° (Success)</label><input type="text" id="sfx-success" placeholder="é è¨­ (success.mp3)"></div>
                        <div class="input-group"><label>ç­”éŒ¯ (Fail)</label><input type="text" id="sfx-fail" placeholder="é è¨­ (fail.mp3)"></div>
                        <div class="input-group col-span-2"><label>é€šé—œ (Complete)</label><input type="text" id="sfx-complete" placeholder="é è¨­ (complete.mp3)"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">* è‹¥è¦ä½¿ç”¨å¤šå€‹éš¨æ©ŸéŸ³æ•ˆï¼Œè«‹ç”¨é€—è™Ÿåˆ†éš”</p>
                </div>
            </div>

            <!-- 3.3 é ­åƒè¨­å®š -->
            <div class="mt-8">
                <div class="flex justify-between items-center border-b-2 border-e5e7eb mb-4 pb-2">
                     <h3 class="text-lg font-extrabold text-gray-800">ğŸ‘¤ é ­åƒè¨­å®š (img/)</h3>
                     <button onclick="addAvatarRow()" class="px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600">+ æ–°å¢é ­åƒ</button>
                </div>
                <div id="avatar-list" class="space-y-2 mb-4">
                    <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- 3.4 æ–‡å­—è¨­å®š -->
            <div class="mt-8">
                <h3 class="section-title">ğŸ’¬ æ–‡å­—èˆ‡å°è©±è¨­å®š</h3>
                <div class="space-y-4">
                    <div class="input-group">
                        <label>NPC æ­¡è¿è©</label>
                        <input type="text" id="txt-welcome" value="æ­¡è¿ä¾†åˆ°å¯¶å³¶ï¼æº–å‚™å¥½å†’éšªäº†å—ï¼Ÿ">
                    </div>
                    <div class="input-group">
                        <label>NPC é–’èŠå°è© (ä¸€è¡Œä¸€å¥)</label>
                        <textarea id="txt-idle" rows="4" class="font-mono text-sm">åŠ æ²¹ï¼
åˆ¥æ”¾æ£„ï¼
ä½ èªè­˜å¤šå°‘å°ç£ç‰¹æœ‰ç¨®å‘¢ï¼Ÿ
è¨˜å¾—å¤šå–æ°´å–”ï¼</textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                         <div class="input-group">
                            <label>Mii æš±ç¨± - å½¢å®¹è© (ä¸€è¡Œä¸€å€‹)</label>
                            <textarea id="txt-adj" rows="5" class="font-mono text-sm">é–‹æœ—çš„
æ´»æ½‘çš„
ç¥ç§˜çš„
å¯æ„›çš„</textarea>
                        </div>
                        <div class="input-group">
                            <label>Mii æš±ç¨± - åè© (ä¸€è¡Œä¸€å€‹)</label>
                            <textarea id="txt-noun" rows="5" class="font-mono text-sm">æ¢éšªå®¶
å­¸éœ¸
é»‘ç†Š
çŸ³è™</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ­¥é©Ÿ 4: ç”¢ç”Ÿç¨‹å¼ç¢¼ -->
        <div class="step-card">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">4. ç”¢ç”Ÿæ¨¡çµ„ç¨‹å¼ç¢¼</h2>
            <div class="mb-8">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-bold text-blue-800">ğŸ“„ theme.js (å­˜åˆ° modules/[ID]/theme.js)</h3>
                    <button onclick="copyToClipboard('output-theme-js')" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">è¤‡è£½</button>
                </div>
                <textarea id="output-theme-js" class="w-full h-64 p-4 font-mono text-sm bg-gray-800 text-green-400 rounded-xl" readonly></textarea>
            </div>
            <div>
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-bold text-blue-800">ğŸ“‹ theme_list.js (åŠ å…¥åˆ°ç¾æœ‰æ¸…å–®)</h3>
                    <button onclick="copyToClipboard('output-list-js')" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">è¤‡è£½</button>
                </div>
                <textarea id="output-list-js" class="w-full h-32 p-4 font-mono text-sm bg-gray-800 text-green-400 rounded-xl" readonly></textarea>
            </div>
        </div>

        <!-- æ­¥é©Ÿ 5: æª”æ¡ˆæª¢æŸ¥æ¸…å–® -->
        <div class="step-card bg-yellow-50 border-2 border-yellow-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-yellow-900">5. æª”æ¡ˆæº–å‚™æ¸…å–® (Checklist)</h2>
                <button onclick="generateReport()" class="px-4 py-2 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 shadow-sm">ğŸ“‹ ç”Ÿæˆå ±å‘Š</button>
            </div>
            <p class="text-yellow-800 mb-4">è«‹ç¢ºèª <code id="folder-path" class="bg-yellow-100 px-2 py-1 rounded font-bold">modules/???/</code> è³‡æ–™å¤¾ä¸­å·²å…·å‚™ä»¥ä¸‹æª”æ¡ˆï¼š</p>
            <div class="mb-6 bg-white p-4 rounded-xl shadow-sm">
                <div class="flex justify-between text-sm text-gray-600 mb-2"><span>æº–å‚™é€²åº¦: <span id="progress-text" class="font-bold">0/0</span></span><span id="progress-percent">0%</span></div>
                <div class="w-full bg-gray-200 rounded-full h-2.5"><div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><h3 class="font-bold text-gray-700 mb-2">ğŸ“ åœ–ç‰‡è³‡æº (img/)</h3><div id="checklist-img" class="space-y-2"></div></div>
                <div><h3 class="font-bold text-gray-700 mb-2">ğŸ”Š éŸ³æ•ˆè³‡æº (sound/)</h3><div id="checklist-sound" class="space-y-2"></div></div>
            </div>
        </div>
    </div>

    <script>
        let coordinates = [];
        const mapContainer = document.getElementById('map-preview-container'), mapImg = document.getElementById('map-preview'), pointsLayer = document.getElementById('map-points-layer'), pointCountEl = document.getElementById('point-count'), undoBtn = document.getElementById('undo-point');

        // é è¨­é ­åƒåˆ—è¡¨
        const defaultAvatars = [
            { key: 'bear', file: 'avatar_bear.png' }, { key: 'deer', file: 'avatar_deer.png' },
            { key: 'buffalo', file: 'avatar_buffalo.png' }, { key: 'magpie', file: 'avatar_magpie.png' }
        ];

        // åˆå§‹åŒ–
        function init() {
            defaultAvatars.forEach(a => addAvatarRow(a.key, a.file));
            document.getElementById('map-upload').addEventListener('change', e => {
                const f = e.target.files[0]; if (!f) return;
                const r = new FileReader(); r.onload = ev => { mapImg.src = ev.target.result; mapContainer.classList.remove('hidden'); coordinates = []; updatePoints(); generateAll(); }; r.readAsDataURL(f);
            });
            pointsLayer.addEventListener('click', e => { if (coordinates.length>=20) return alert("å·²é”20å€‹ä¸Šé™"); const r = mapContainer.getBoundingClientRect(); coordinates.push({t:((e.clientY-r.top)/r.height*100).toFixed(1)+"%", l:((e.clientX-r.left)/r.width*100).toFixed(1)+"%"}); updatePoints(); generateAll(); });
            undoBtn.onclick = () => { coordinates.pop(); updatePoints(); generateAll(); };
            document.querySelectorAll('input, textarea').forEach(el => el.addEventListener('input', generateAll));
            generateAll();
        }

        function updatePoints() {
            pointsLayer.innerHTML = ''; coordinates.forEach((c, i) => { const p = document.createElement('div'); p.className = 'map-point'; p.style.top = c.t; p.style.left = c.l; p.textContent = i+1; pointsLayer.appendChild(p); });
            pointCountEl.textContent = coordinates.length; undoBtn.disabled = coordinates.length === 0;
        }

        function addAvatarRow(k = '', f = '') {
            const div = document.createElement('div'); div.className = 'flex gap-2 avatar-row';
            div.innerHTML = `<input type="text" placeholder="ä»£ç¢¼ (å¦‚: bear)" class="w-1/3 p-2 border rounded text-sm avatar-key" value="${k}"><input type="text" placeholder="æª”å (å¦‚: bear.png)" class="w-2/3 p-2 border rounded text-sm avatar-file" value="${f}"><button onclick="this.parentElement.remove(); generateAll();" class="px-2 text-red-500 hover:text-red-700">âœ–</button>`;
            div.querySelectorAll('input').forEach(i => i.addEventListener('input', generateAll));
            document.getElementById('avatar-list').appendChild(div);
        }

        function getVal(id) { return document.getElementById(id).value.trim(); }
        function getList(id) { return document.getElementById(id).value.trim().split('\n').filter(x => x.trim()).map(x => `"${x.trim()}"`).join(',\n            '); }
        function getSFX(id) { const v = getVal(id); if(!v) return null; return v.includes(',') ? `[${v.split(',').map(s => `"${"sound/"+s.trim()}"`).join(', ')}]` : `["sound/${v}"]`; }

        function generateAll() {
            const tid = getVal('theme-id') || 'new_theme';
            // ç”¢ç”Ÿ theme.js
            let avStr = []; document.querySelectorAll('.avatar-row').forEach(r => { const k = r.querySelector('.avatar-key').value.trim(), f = r.querySelector('.avatar-file').value.trim(); if(k && f) avStr.push(`"${k}": "img/${f}"`); });
            let coStr = coordinates.map(c => `        { top: "${c.t}", left: "${c.l}" }`).join(',\n');
            if (coordinates.length < 20) coStr += `\n        // ... (é‚„éœ€è¦ ${20 - coordinates.length} å€‹åº§æ¨™)`;

            let sfxStr = [];
            ['click', 'dice', 'move', 'success', 'fail', 'complete', 'bgm'].forEach(k => {
                const val = getSFX('sfx-' + k);
                if (val) sfxStr.push(`"${k}": ${k==='bgm'?val.replace('[','').replace(']',''):val}`);
            });

            document.getElementById('output-theme-js').value = `window.CURRENT_THEME_CONFIG = {
    GAS_URL: "${getVal('gas-url')}",
    BOARD_COORDINATES: [\n${coStr}\n    ],
    ASSETS: {
        AVATARS: {\n            ${avStr.join(',\n            ')}\n        },
        IMAGES: {
            "guideNPC": "img/${getVal('img-guideNPC')}",
            "loadingGif": "img/${getVal('img-loadingGif')}",
            "mapBg": "img/${getVal('img-mapBg')}"
        },
        SFX: {
            ${sfxStr.join(', ')}
        },
        TEXT: {
            NPC_WELCOME: "${getVal('txt-welcome')}",
            NPC_IDLE_CHATS: [\n            ${getList('txt-idle')}\n        ],
            MII_ADJECTIVES: [\n            ${getList('txt-adj')}\n        ],
            MII_NOUNS: [\n            ${getList('txt-noun')}\n        ]
        }
    }
};`;
            document.getElementById('output-list-js').value = `    {\n        id: "${tid}",\n        name: "${getVal('theme-name')}",\n        description: "${getVal('theme-desc')}",\n        cover: "img/${getVal('img-mapBg')}"\n    },`;
            updateChecklist(tid);
        }

        // æª¢æŸ¥æ¸…å–®
        let checklistData = [];
        function updateChecklist(tid) {
            document.getElementById('folder-path').textContent = `modules/${tid}/`;
            // å¦‚æœ TID æ²’è®Šä¸”å·²æœ‰è³‡æ–™ï¼Œä¿ç•™å‹¾é¸ç‹€æ…‹
            if (checklistData.length > 0 && document.getElementById('folder-path').dataset.lastId === tid) return;
            document.getElementById('folder-path').dataset.lastId = tid;

            checklistData = [];
            const add = (f, req, type) => checklistData.push({ file: type + '/' + f.trim(), req, checked: false, type });
            add(getVal('img-mapBg'), true, 'img'); add(getVal('img-guideNPC'), true, 'img'); add(getVal('img-loadingGif'), true, 'img');
            document.querySelectorAll('.avatar-file').forEach(i => { if (i.value.trim()) add(i.value, true, 'img'); });
            
            // éŸ³æ•ˆæª¢æŸ¥ (åªæª¢æŸ¥æœ‰å¡«å¯«çš„)
            if (getVal('sfx-bgm')) add(getVal('sfx-bgm'), true, 'sound');
            ['sfx-click', 'sfx-dice', 'sfx-move', 'sfx-success', 'sfx-fail', 'sfx-complete'].forEach(id => {
                const v = getVal(id);
                if (v) v.split(',').forEach(f => { if (f.trim()) add(f, true, 'sound'); });
            });
            
            renderChecklist();
        }

        function renderChecklist() {
            const ic = document.getElementById('checklist-img'), sc = document.getElementById('checklist-sound'); ic.innerHTML = ''; sc.innerHTML = '';
            // å»é™¤é‡è¤‡æª”æ¡ˆ
            const uniqueList = [...new Map(checklistData.map(item => [item.file, item])).values()];
            uniqueList.forEach((item, i) => {
                const div = document.createElement('div'); div.className = `file-item ${item.checked ? 'checked' : ''}`;
                div.innerHTML = `<input type="checkbox" id="f${i}" class="w-5 h-5 mr-3 accent-blue-500" ${item.checked?'checked':''}><label for="f${i}" class="flex-grow flex items-center cursor-pointer"><span class="filename font-mono text-sm text-gray-700">${item.file}</span><span class="${item.req?'file-required':'file-optional'}">${item.req?'å¿…é ˆ':'é¸ç”¨'}</span></label>`;
                div.querySelector('input').onchange = (e) => { item.checked = e.target.checked; renderChecklist(); };
                (item.type === 'img' ? ic : sc).appendChild(div);
            });
            updateProgress(uniqueList);
        }
        function updateProgress(list) {
            const total = list.filter(i=>i.req).length, done = list.filter(i=>i.req&&i.checked).length, pct = Math.round((done/total)*100)||0;
            document.getElementById('progress-text').textContent = `${done}/${total}`; document.getElementById('progress-percent').textContent = `${pct}%`;
            document.getElementById('progress-bar').style.width = `${pct}%`; document.getElementById('progress-bar').className = `h-2.5 rounded-full transition-all ${pct===100?'bg-green-500':'bg-blue-600'}`;
        }

        window.copyToClipboard = (id) => { document.getElementById(id).select(); document.execCommand('copy'); alert("å·²è¤‡è£½ï¼"); };
        window.generateReport = () => {
            const done = checklistData.filter(i=>i.checked).map(i=>`âœ… ${i.file}`), todo = checklistData.filter(i=>!i.checked).map(i=>`â¬œ ${i.file}`);
            alert(`ã€${getVal('theme-id')} æº–å‚™å ±å‘Šã€‘\n\nå·²å®Œæˆ:\n${done.join('\n')||'(ç„¡)'}\n\nå¾…è™•ç†:\n${todo.join('\n')||'(å·²å®Œæˆï¼)'}`);
        };

        init();
    </script>
</body>
</html>