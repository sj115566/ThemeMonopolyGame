<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å¯Œç¿ä¸»é¡Œç”¢ç”Ÿå™¨ Pro | AI Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --glass: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1f2937;
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .input-stylish {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .input-stylish:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(to right, #6366f1, #8b5cf6);
            color: white;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4);
        }

        .map-container {
            position: relative;
            width: 100%;
            border-radius: 1rem;
            overflow: hidden;
            cursor: crosshair;
            background: #e2e8f0;
            border: 2px dashed #94a3b8;
        }

        .map-point {
            position: absolute;
            width: 28px;
            height: 28px;
            background: var(--primary);
            border: 3px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: 800;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            pointer-events: none;
            transition: all 0.2s;
        }

        .ai-glow {
            position: relative;
        }

        .ai-glow::after {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(45deg, #f06, #9f6, #06f, #f06);
            border-radius: inherit;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s;
            filter: blur(8px);
        }

        .ai-glow:hover::after {
            opacity: 0.6;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
            <div>
                <h1 class="text-5xl font-extrabold text-white drop-shadow-lg tracking-tight">å¤§å¯Œç¿ä¸»é¡Œç”¢ç”Ÿå™¨ <span
                        class="bg-clip-text text-transparent bg-gradient-to-r from-yellow-300 to-orange-400">PRO</span>
                </h1>
                <p class="text-indigo-100 text-lg mt-2 font-light italic">Powered by AI - Create your world in minutes.
                </p>
            </div>
            <div class="flex gap-4">
                <button onclick="document.getElementById('ai-settings-modal').classList.remove('hidden')"
                    class="px-5 py-3 glass-card text-indigo-900 font-bold flex items-center gap-2 hover:bg-white transition-all">
                    âš™ï¸ AI è¨­å®š
                </button>
                <button onclick="publishToCloud()"
                    class="bg-white/90 text-indigo-600 px-6 py-3 rounded-2xl font-bold text-lg shadow-xl flex items-center gap-2 hover:bg-white transition-all border border-indigo-200">
                    â˜ï¸ é›²ç«¯ç™¼ä½ˆ
                </button>
                <button onclick="openCloudThemesModal()"
                    class="px-5 py-3 glass-card text-blue-600 font-bold flex items-center gap-2 hover:bg-white transition-all shadow-lg border-2 border-blue-100">
                    ğŸ“‚ è®€å–é›²ç«¯ä¸»é¡Œ
                </button>
                <a href="./index.html"
                    class="px-5 py-3 glass-card text-gray-600 font-bold flex items-center gap-2 hover:bg-white transition-all text-sm">
                    ğŸ  å›ä¸»é 
                </a>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Side: Config -->
            <div class="lg:col-span-2 space-y-8">

                <section class="glass-card p-8">
                    <div class="flex justify-between items-center mb-6 text-indigo-900 border-b pb-4 border-indigo-100">
                        <h2 class="text-2xl font-bold flex items-center gap-2">âœ¨ 1. ä¸»é¡ŒåŸºå› </h2>
                        <button onclick="aiCompleteInfo()"
                            class="ai-glow px-4 py-2 bg-white rounded-full text-sm font-bold shadow-sm flex items-center gap-2 text-indigo-600">
                            ğŸª„ AI è‡ªå‹•è£œå®Œ
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm font-bold text-gray-700">ä¸»é¡Œ ID (è‹±æ–‡+ä¸‹åº•ç·š)</label>
                            <input type="text" id="theme-id" placeholder="ä¾‹å¦‚: mars_mission"
                                class="w-full p-3 rounded-xl input-stylish" value="new_adventure">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-bold text-gray-700">ä¸»é¡Œåç¨± (é¡¯ç¤ºæ–‡å­—)</label>
                            <input type="text" id="theme-name" placeholder="ä¾‹å¦‚: ğŸš€ ç«æ˜Ÿç™»é™¸è¨ˆåŠƒ"
                                class="w-full p-3 rounded-xl input-stylish" value="æ–°ä¸–ç•Œå†’éšª">
                        </div>
                        <div class="md:col-span-2 space-y-2">
                            <label class="text-sm font-bold text-gray-700">ç°¡çŸ­æè¿°</label>
                            <textarea id="theme-desc" rows="2" class="w-full p-3 rounded-xl input-stylish"
                                placeholder="ä»‹ç´¹æ‚¨çš„æ–°å†’éšª..."></textarea>
                        </div>
                        <div class="md:col-span-2 space-y-2">
                            <label class="text-sm font-bold text-gray-700">NPC æ­¡è¿è© (æ­¡è¿ä¾†åˆ°...)</label>
                            <input type="text" id="txt-welcome" placeholder="ä¾‹å¦‚: å†’éšªè€…ï¼Œæ­¡è¿ä¾†åˆ°ç¥ç¥•çš„ç«æ˜Ÿï¼"
                                class="w-full p-3 rounded-xl input-stylish">
                        </div>
                        <div class="md:col-span-2 space-y-2">
                            <label class="text-sm font-bold text-gray-700">Google App Script (GAS) ç¶²å€</label>
                            <input type="text" id="gas-url" placeholder="https://script.google.com/..."
                                class="w-full p-3 rounded-xl input-stylish font-mono text-xs">
                        </div>
                    </div>
                </section>

                <!-- 2. AI è¦–è¦ºä¸­å¿ƒ -->
                <section class="glass-card p-8 bg-white/40">
                    <div class="flex justify-between items-center mb-6 text-indigo-900 border-b pb-4 border-indigo-100">
                        <h2 class="text-2xl font-bold flex items-center gap-2">ğŸ¨ 2. AI è¦–è¦ºææ¡ˆ</h2>
                    </div>
                    <div class="space-y-6">
                        <div
                            class="bg-purple-50 p-6 rounded-2xl border border-purple-100 flex flex-col md:flex-row gap-6 items-center">
                            <div class="flex-grow">
                                <h3 class="font-bold text-purple-900 mb-1 text-lg">ç”Ÿæˆç¹ªåœ–æç¤ºè©</h3>
                                <p class="text-sm text-purple-600">æ ¹æ“šæ‚¨çš„ä¸»é¡Œåç¨±ï¼Œè‡ªå‹•æ§‹æƒ³è¦–è¦ºå ´æ™¯ã€è§’è‰²é¢¨æ ¼èˆ‡éŸ³æ¨‚èª¿æ€§ã€‚</p>
                            </div>
                            <button onclick="aiGeneratePrompts()"
                                class="w-full md:w-auto px-8 py-4 bg-purple-600 text-white rounded-2xl font-extrabold shadow-lg hover:bg-purple-700 transition-all active:scale-95 flex items-center justify-center gap-2">
                                âœ¨ ç”Ÿæˆ AI æç¤ºè©
                            </button>
                        </div>

                        <div id="ai-prompts-output"
                            class="text-sm text-gray-700 bg-white/80 p-6 rounded-2xl hidden border border-purple-100 leading-relaxed space-y-4 shadow-inner">
                        </div>

                        <div id="prompts-control" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div
                                class="p-4 bg-white/50 rounded-xl border border-indigo-50 flex flex-col items-center gap-3">
                                <span class="text-xs font-bold text-indigo-400 uppercase tracking-widest">åš®å° NPC</span>
                                <button onclick="generateAIImage('prompt-npc', null, 'img-guideNPC')"
                                    class="w-full py-3 bg-indigo-600 text-white rounded-xl text-sm font-bold hover:bg-indigo-700 transition-all shadow-md">ğŸª„
                                    ç”Ÿæˆ NPC åœ–åƒ</button>
                            </div>
                            <div
                                class="p-4 bg-white/50 rounded-xl border border-indigo-50 flex flex-col items-center gap-3">
                                <span class="text-xs font-bold text-indigo-400 uppercase tracking-widest">è¼‰å…¥å‹•ç•«</span>
                                <button onclick="generateAIImage('prompt-loading', null, 'img-loadingGif')"
                                    class="w-full py-3 bg-indigo-600 text-white rounded-xl text-sm font-bold hover:bg-indigo-700 transition-all shadow-md">ğŸª„
                                    ç”Ÿæˆè¼‰å…¥åœ–</button>
                            </div>
                            <div
                                class="p-4 bg-white/50 rounded-xl border border-indigo-50 flex flex-col items-center gap-3">
                                <span class="text-xs font-bold text-indigo-400 uppercase tracking-widest">è§’è‰²é ­åƒ</span>
                                <button onclick="generateAIAvatars()"
                                    class="w-full py-3 bg-indigo-600 text-white rounded-xl text-sm font-bold hover:bg-indigo-700 transition-all shadow-md">ğŸª„
                                    ç”Ÿæˆ 4 çµ„é ­åƒ</button>
                            </div>
                        </div>

                        <!-- éš±è—çš„ Prompt å®¹å™¨ -->
                        <textarea id="prompt-map" class="hidden"></textarea>
                        <textarea id="prompt-npc" class="hidden"></textarea>
                        <textarea id="prompt-loading" class="hidden"></textarea>
                        <textarea id="prompt-avatar" class="hidden"></textarea>
                    </div>
                </section>

                <!-- 3. åœ°åœ–ä½ˆå±€ -->
                <section class="glass-card p-8">
                    <div class="flex justify-between items-center mb-6 text-indigo-900 border-b pb-4 border-indigo-100">
                        <h2 class="text-2xl font-bold flex items-center gap-2">ğŸ—ºï¸ 3. åœ°åœ–å°èˆª</h2>
                        <div class="text-sm px-4 py-1 bg-indigo-100 rounded-full font-bold">
                            ç¯€é»: <span id="point-count" class="text-indigo-600">0</span> / 20 (è‡³å°‘ 1 å€‹)
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mb-6">è«‹å…ˆç”Ÿæˆï¼ˆæˆ–ä¸Šå‚³ï¼‰åœ°åœ–èƒŒæ™¯ï¼Œæ¥è‘—åœ¨åœ°åœ–ä¸Šé»æ“Šä»¥æ¨™è¨˜éŠæˆ²ç¯€é»ä½ç½®ã€‚</p>

                    <div
                        class="mb-6 flex flex-wrap gap-4 items-center p-4 bg-white/40 rounded-2xl border border-indigo-50">
                        <div class="flex-grow">
                            <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-widest">æ–¹æ³• A:
                                ä¸Šå‚³åœ–æª”</label>
                            <input type="file" id="map-upload" accept="image/*"
                                class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-xs file:font-semibold file:bg-white file:text-indigo-700 hover:file:bg-indigo-50" />
                        </div>
                        <div class="hidden md:block w-px h-10 bg-indigo-100"></div>
                        <div class="flex-grow md:flex-grow-0">
                            <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-widest">æ–¹æ³• B: AI
                                ç¹ªåœ–</label>
                            <button onclick="generateAIImage('prompt-map', 'map-preview', 'img-mapBg')"
                                class="w-full md:w-auto px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold shadow-md flex items-center justify-center gap-2 hover:bg-indigo-700 transition-all active:scale-95 disabled:opacity-50"
                                id="btn-gen-map" disabled title="è«‹å…ˆç”Ÿæˆ AI æç¤ºè©">
                                ğŸª„ AI ç”Ÿæˆåœ°åœ–
                            </button>
                        </div>
                        <button id="undo-point"
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 disabled:opacity-50 transition-all font-bold"
                            disabled>â†©ï¸ å¤åŸ</button>
                    </div>

                    <div id="map-preview-container" class="map-container shadow-2xl">
                        <img id="map-preview" class="w-full min-h-[400px] object-cover"
                            src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'><rect width='100%' height='100%' fill='%23f1f5f9'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='20' fill='%2394a3b8'>è«‹ä¸Šå‚³åœ°åœ–èƒŒæ™¯æˆ–è¼¸å…¥ AI æç¤º</text></svg>">
                        <div id="map-points-layer" class="absolute inset-0"></div>
                    </div>
                </section>

                <!-- 4. éŠæˆ²è…³æœ¬èˆ‡é¡Œç›® -->
                <section class="glass-card p-8 bg-white/40">
                    <h2 class="text-2xl font-bold text-indigo-900 mb-6 flex items-center gap-2">ğŸ§  4. éŠæˆ²å…§å®¹ç”Ÿæˆ</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-indigo-900">
                        <!-- AI æ–‡å­— -->
                        <div class="space-y-6">
                            <div class="space-y-3">
                                <label class="block text-sm font-bold">NPC é–’èŠå°è©±</label>
                                <button onclick="aiGenerateChats()"
                                    class="w-full py-2 bg-indigo-50 border border-indigo-200 rounded-xl text-sm font-bold hover:bg-indigo-100 transition-colors">âœ¨
                                    ç”Ÿæˆ AI å°è©±</button>
                                <textarea id="txt-idle" rows="4" class="w-full p-3 rounded-xl input-stylish text-sm"
                                    placeholder="ä¸€è¡Œä¸€å¥..."></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-2">
                                    <label class="block text-sm font-bold">æš±ç¨±å½¢å®¹è©</label>
                                    <button onclick="aiGenerateList('adj')"
                                        class="text-xs text-indigo-600 font-bold hover:underline mb-1">AI ç”Ÿæˆ</button>
                                    <textarea id="txt-adj" rows="4"
                                        class="w-full p-2 rounded-xl input-stylish text-xs font-mono"></textarea>
                                </div>
                                <div class="space-y-2">
                                    <label class="block text-sm font-bold">æš±ç¨±åè©</label>
                                    <button onclick="aiGenerateList('noun')"
                                        class="text-xs text-indigo-600 font-bold hover:underline mb-1">AI ç”Ÿæˆ</button>
                                    <textarea id="txt-noun" rows="4"
                                        class="w-full p-2 rounded-xl input-stylish text-xs font-mono"></textarea>
                                </div>
                            </div>
                        </div>
                        <!-- AI é¡Œç›® -->
                        <div class="space-y-4">
                            <div class="space-y-2 border-l-4 border-orange-400 pl-4 py-1">
                                <h4 class="font-bold text-orange-950">å€åŸŸ A: é¡Œç›®ç”Ÿæˆè¨­å®š</h4>
                                <label class="block text-xs font-bold text-orange-700">è‡ªè¨‚é¡Œç›®ä¸»é¡Œ (é¸å¡«)</label>
                                <textarea id="ai-questions-topic" rows="2"
                                    class="w-full p-2.5 rounded-xl input-stylish text-xs"
                                    placeholder="ä¾‹å¦‚ï¼šé—œæ–¼å‹•ç‰©åç¨±ã€åŸºæœ¬åŠ æ¸›æ³•..."></textarea>
                                <button onclick="aiGenerateQuestions()"
                                    class="w-full py-3 bg-orange-500 text-white rounded-xl text-sm font-extrabold hover:bg-orange-600 shadow-md transition-all active:scale-95 flex items-center justify-center gap-2">
                                    âœ¨ æ ¹æ“šæ¨™è¨˜é»ç”Ÿæˆé¡Œç›®
                                </button>
                                <p class="text-[10px] text-orange-600 mt-1 italic font-medium">â€» å°‡æ ¹æ“šæ‚¨åœ¨ã€Œæ­¥é©Ÿ
                                    3ã€æ¨™è¨˜çš„é»ä½æ•¸é‡é€²è¡Œå–åèˆ‡å‡ºé¡Œã€‚</p>
                            </div>

                            <div class="space-y-2 pt-2">
                                <label class="block text-sm font-bold text-gray-500">éŠæˆ²é¡Œç›® JSON é è¦½</label>
                                <div class="relative group">
                                    <textarea id="output-questions-json" rows="8"
                                        class="w-full p-3 rounded-xl input-stylish text-[10px] font-mono bg-gray-900 text-green-400 shadow-inner"
                                        placeholder='{"map": [...], "questions": {...}}'></textarea>
                                    <button onclick="copyToClipboard('output-questions-json')"
                                        class="absolute top-2 right-2 px-2 py-1 bg-gray-700 text-white text-[10px] rounded opacity-0 group-hover:opacity-100 transition-opacity">è¤‡è£½</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- é€²éšè¨­å®š (åŸæœ¬çš„ç¬¬ 4 æ­¥èˆ‡ç¨‹å¼ç¢¼è¼¸å‡º) -->
                <div class="mt-4">
                    <button onclick="document.getElementById('advanced-area').classList.toggle('hidden')"
                        class="text-indigo-300 text-sm font-bold hover:text-white transition-all flex items-center gap-1">
                        âš™ï¸ é€²éšè¨­å®š (è³‡æºè·¯å¾‘èˆ‡åŸå§‹ç¢¼) <span class="text-[10px]">â–¼</span>
                    </button>

                    <div id="advanced-area" class="hidden mt-4 space-y-6">
                        <section class="glass-card p-6">
                            <h2 class="text-xl font-bold text-indigo-900 mb-6 border-b pb-3 border-indigo-100">ğŸ“¦ è³‡æºé…ç½®è·¯å¾‘
                            </h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <h3 class="text-xs font-extrabold uppercase tracking-widest text-indigo-400">ä¸»è¦è³‡æº
                                        (img/)</h3>
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-2">
                                            <label class="w-16 text-[10px] font-bold text-indigo-800">åœ°åœ–èƒŒæ™¯</label>
                                            <input type="text" id="img-mapBg" value="map_background.png"
                                                class="flex-1 p-1.5 bg-white rounded-lg text-[10px] border border-indigo-100">
                                            <img id="prev-mapBg" class="w-8 h-8 rounded border bg-gray-100 object-cover"
                                                src="">
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <label class="w-16 text-[10px] font-bold text-indigo-800">åš®å° NPC</label>
                                            <input type="text" id="img-guideNPC" value="guide_bear.png"
                                                class="flex-1 p-1.5 bg-white rounded-lg text-[10px] border border-indigo-100">
                                            <img id="prev-guideNPC"
                                                class="w-8 h-8 rounded border bg-gray-100 object-cover" src="">
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <label class="w-16 text-[10px] font-bold text-indigo-800">è¼‰å…¥å‹•ç•«</label>
                                            <input type="text" id="img-loadingGif" value="loading_bear.gif"
                                                class="flex-1 p-1.5 bg-white rounded-lg text-[10px] border border-indigo-100">
                                            <img id="prev-loadingGif"
                                                class="w-8 h-8 rounded border bg-gray-100 object-cover" src="">
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <h3 class="text-xs font-extrabold uppercase tracking-widest text-indigo-400">éŸ³æ•ˆ
                                        (sound/)</h3>
                                    <div class="grid grid-cols-1 gap-2">
                                        <div class="flex items-center gap-2">
                                            <input type="text" id="sfx-bgm" placeholder="èƒŒæ™¯éŸ³æ¨‚ BGM"
                                                class="flex-1 p-1.5 bg-white rounded-lg text-[10px] border border-indigo-100">
                                            <button
                                                onclick="generateAIMusic('sfx-bgm', 'upbeat lo-fi game background music')"
                                                class="w-8 h-8 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 font-bold"
                                                title="AI ç”ŸæˆéŸ³æ¨‚">ğŸª„</button>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="text" id="sfx-click" placeholder="é»æ“ŠéŸ³æ•ˆ Click"
                                                class="flex-1 p-1.5 bg-white rounded-lg text-[10px] border border-indigo-100">
                                            <button
                                                onclick="generateAISFX('sfx-click', 'short subtle interface click sound')"
                                                class="w-8 h-8 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 font-bold"
                                                title="AI ç”Ÿæˆ">ğŸª„</button>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="text" id="sfx-dice" placeholder="éª°å­éŸ³æ•ˆ Dice"
                                                class="flex-1 p-1.5 bg-white rounded-lg text-[10px] border border-indigo-100">
                                            <button
                                                onclick="generateAISFX('sfx-dice', 'rolling dice on wooden table sound')"
                                                class="w-8 h-8 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 font-bold"
                                                title="AI ç”Ÿæˆ">ğŸª„</button>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="text" id="sfx-move" placeholder="ç§»å‹•éŸ³æ•ˆ Move"
                                                class="flex-1 p-1.5 bg-white rounded-lg text-[10px] border border-indigo-100">
                                            <button
                                                onclick="generateAISFX('sfx-move', 'fast magic character whoosh or movement sound')"
                                                class="w-8 h-8 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 font-bold"
                                                title="AI ç”Ÿæˆ">ğŸª„</button>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="text" id="sfx-success" placeholder="æˆåŠŸéŸ³æ•ˆ Success"
                                                class="flex-1 p-1.5 bg-white rounded-lg text-[10px] border border-indigo-100">
                                            <button
                                                onclick="generateAISFX('sfx-success', 'celebratory success fanfare magic sound')"
                                                class="w-8 h-8 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 font-bold"
                                                title="AI ç”Ÿæˆ">ğŸª„</button>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="text" id="sfx-fail" placeholder="å¤±æ•—éŸ³æ•ˆ Fail"
                                                class="flex-1 p-1.5 bg-white rounded-lg text-[10px] border border-indigo-100">
                                            <button
                                                onclick="generateAISFX('sfx-fail', 'funny failure game over sound short')"
                                                class="w-8 h-8 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 font-bold"
                                                title="AI ç”Ÿæˆ">ğŸª„</button>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="text" id="sfx-complete" placeholder="é€šé—œéŸ³æ•ˆ Complete"
                                                class="flex-1 p-1.5 bg-white rounded-lg text-[10px] border border-indigo-100">
                                            <button
                                                onclick="generateAISFX('sfx-complete', 'grand orchestral completion achievement sound')"
                                                class="w-8 h-8 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 font-bold"
                                                title="AI ç”Ÿæˆ">ğŸª„</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="md:col-span-2 space-y-4">
                                    <h3 class="text-xs font-extrabold uppercase tracking-widest text-indigo-400">è§’è‰²é ­åƒ
                                    </h3>
                                    <div id="avatar-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                                    <button onclick="addAvatarRow()"
                                        class="w-full py-1.5 bg-white border border-dashed border-indigo-200 rounded-lg text-[10px] text-indigo-400 font-bold hover:bg-indigo-50 transition-all">ï¼‹
                                        æ–°å¢é ­åƒ</button>
                                </div>
                            </div>
                        </section>

                        <section class="glass-card p-6">
                            <h2 class="text-xl font-bold text-indigo-900 mb-4 border-b pb-3 border-indigo-100">ğŸ“„ åŸå§‹ç¢¼è¼¸å‡º
                            </h2>
                            <div class="space-y-4">
                                <div class="space-y-1">
                                    <span class="text-[10px] font-bold text-gray-500 uppercase">theme.js</span>
                                    <textarea id="output-theme-js"
                                        class="w-full h-40 p-3 bg-gray-900 text-green-400 rounded-xl text-[10px] font-mono"
                                        readonly></textarea>
                                </div>
                                <div class="space-y-1">
                                    <span class="text-[10px] font-bold text-gray-500 uppercase">theme_list.js ç‰‡æ®µ</span>
                                    <textarea id="output-list-js"
                                        class="w-full h-20 p-3 bg-gray-900 text-green-400 rounded-xl text-[10px] font-mono"
                                        readonly></textarea>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- AI è¨­å®š Modal -->
    <div id="ai-settings-modal"
        class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[100] hidden backdrop-blur-sm">
        <div class="glass-card bg-white p-8 w-full max-w-md shadow-2xl">
            <h3 class="text-2xl font-bold text-indigo-900 mb-6 flex items-center gap-2">ğŸ¤– AI è¨­å®š</h3>
            <div class="space-y-4">
                <div class="space-y-2">
                    <label class="text-sm font-bold text-indigo-900 flex items-center gap-2">
                        <img src="https://elevenlabs.io/favicon.ico" class="w-4 h-4"> ElevenLabs API Key (éŸ³æ•ˆèˆ‡éŸ³æ¨‚)
                    </label>
                    <input type="password" id="ai-eleven-key" placeholder="è²¼ä¸Šä½ çš„ ElevenLabs Key"
                        class="w-full p-3 rounded-xl border border-indigo-100 bg-gray-50 focus:bg-white outline-none">
                    <p class="text-[10px] text-gray-400">ç”¨æ–¼ç”Ÿæˆé«˜å“è³ªä¸»é¡ŒéŸ³æ•ˆèˆ‡èƒŒæ™¯éŸ³æ¨‚ï¼ˆé¸å¡«ï¼‰ã€‚</p>
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-bold text-indigo-900 flex items-center gap-2">
                        ğŸ¤– Google Gemini API Key
                    </label>
                    <input type="password" id="ai-api-key" placeholder="è²¼ä¸Šä½ çš„ API Key"
                        class="w-full p-3 rounded-xl border border-indigo-100 bg-gray-50 focus:bg-white outline-none">
                    <p class="text-[10px] text-gray-500">é‡‘é‘°å°‡å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ (LocalStorage)ã€‚</p>
                </div>
                <div class="pt-4 flex gap-3">
                    <button onclick="document.getElementById('ai-settings-modal').classList.add('hidden')"
                        class="flex-1 py-3 bg-gray-100 rounded-xl font-bold hover:bg-gray-200 transition-colors">å–æ¶ˆ</button>
                    <button onclick="saveAISettings()"
                        class="flex-1 py-3 btn-primary rounded-xl font-bold shadow-lg">å„²å­˜è¨­å®š</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loading-overlay"
        class="fixed inset-0 bg-white/50 backdrop-blur-md flex flex-col items-center justify-center z-[200] hidden">
        <div class="w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <div id="loading-text" class="text-indigo-900 font-bold animate-pulse text-lg">AI æ­£åœ¨æ€è€ƒä¸­...</div>
    </div>

    <!-- é›²ç«¯ä¸»é¡Œæ¸…å–® Modal -->
    <div id="cloud-themes-modal"
        class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[100] hidden backdrop-blur-sm">
        <div class="glass-card bg-white p-8 w-full max-w-2xl shadow-2xl flex flex-col max-h-[80vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-indigo-900">ğŸ“‚ é¸æ“‡ç¾æœ‰é›²ç«¯ä¸»é¡Œ</h3>
                <button onclick="document.getElementById('cloud-themes-modal').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-600 text-2xl">âœ–</button>
            </div>
            <div id="cloud-themes-list" class="flex-grow overflow-y-auto space-y-3 pr-2">
                <!-- ç”± JS å‹•æ…‹æ³¨å…¥ -->
                <div class="text-center py-10 text-gray-400">æ­£åœ¨è®€å–æ¸…å–®...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { FIREBASE_CONFIG } from './global_config.js';

        // --- Firebase åˆå§‹åŒ– ---
        firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.database();
        const storage = firebase.storage();
        const auth = firebase.auth();

        // åŒ¿åç™»å…¥ä»¥ç¢ºä¿é›²ç«¯ç™¼ä½ˆæ¬Šé™ (ä¸éœ€è¦ä½¿ç”¨è€…ä»‹å…¥)
        auth.signInAnonymously().catch(err => {
            console.error("Firebase Auth Error:", err);
        });

        // --- å…¨åŸŸè®Šæ•¸ ---
        let coordinates = [];
        const dom = {
            mapContainer: document.getElementById('map-preview-container'),
            mapImg: document.getElementById('map-preview'),
            pointsLayer: document.getElementById('map-points-layer'),
            pointCountEl: document.getElementById('point-count'),
            undoBtn: document.getElementById('undo-point'),
            overlay: document.getElementById('loading-overlay'),
            loadingText: document.getElementById('loading-text')
        };
        const defaultAvatars = [
            { key: 'bear', file: 'avatar_bear.png' }, { key: 'deer', file: 'avatar_deer.png' },
            { key: 'buffalo', file: 'avatar_buffalo.png' }, { key: 'magpie', file: 'avatar_magpie.png' }
        ];


        // --- åœ°åœ–åº§æ¨™ ---
        function updatePoints() {
            dom.pointsLayer.innerHTML = '';
            coordinates.forEach((c, i) => {
                const p = document.createElement('div');
                p.className = 'map-point';
                p.style.top = c.t; p.style.left = c.l;
                p.textContent = i + 1;
                dom.pointsLayer.appendChild(p);
            });
            dom.pointCountEl.textContent = coordinates.length;
            dom.undoBtn.disabled = coordinates.length === 0;
        }

        // --- è³‡æºèˆ‡é ­åƒ ---
        function addAvatarRow(k = '', f = '') {
            const div = document.createElement('div');
            // ä½¿ç”¨ flex æ’åˆ—ï¼ŒèƒŒæ™¯è‰²ç¨å¾®æ·±ä¸€é»ä»¥ä¾¿å€éš”
            div.className = 'flex gap-3 avatar-row p-3 bg-white/60 border border-indigo-50 rounded-2xl items-center shadow-sm hover:shadow-md transition-all relative group';
            div.innerHTML = `
                <div class="flex-shrink-0 relative">
                    <img class="w-12 h-12 rounded-xl border-2 border-white bg-gray-100 object-cover avatar-prev shadow-sm" src="${f.startsWith('http') ? f : 'img/' + f}">
                </div>
                <div class="flex-grow space-y-2">
                    <div class="flex items-center gap-2">
                        <span class="text-[9px] font-bold text-indigo-400 w-12 uppercase flex-shrink-0">ID è­˜åˆ¥ç¢¼</span>
                        <input type="text" placeholder="ä¾‹å¦‚: bear" class="flex-grow p-1.5 bg-white/80 border border-indigo-50 rounded-lg text-[10px] avatar-key focus:ring-1 ring-indigo-300 outline-none" value="${k}">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-[9px] font-bold text-indigo-400 w-12 uppercase flex-shrink-0">åœ–ç‰‡è·¯å¾‘</span>
                        <input type="text" placeholder="ç¶²å€æˆ–æª”å" class="flex-grow p-1.5 bg-white/80 border border-indigo-50 rounded-lg text-[10px] avatar-file focus:ring-1 ring-indigo-300 outline-none" value="${f}">
                    </div>
                </div>
                <button onclick="this.parentElement.remove(); generateAll();" 
                    class="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-red-50 text-red-500 rounded-full hover:bg-red-500 hover:text-white transition-all shadow-sm ml-1"
                    title="åˆªé™¤æ­¤é ­åƒ">âœ–</button>
            `;
            const fileInput = div.querySelector('.avatar-file');
            const prevImg = div.querySelector('.avatar-prev');
            fileInput.addEventListener('input', () => {
                const val = fileInput.value.trim();
                prevImg.src = val.startsWith('http') ? val : (val ? 'img/' + val : '');
                generateAll();
            });
            div.querySelector('.avatar-key').addEventListener('input', generateAll);
            document.getElementById('avatar-list').appendChild(div);
        }

        // --- AI åŠŸèƒ½ ---
        function saveAISettings() {
            const geminiKey = document.getElementById('ai-api-key').value.trim();
            const elevenKey = document.getElementById('ai-eleven-key').value.trim();
            localStorage.setItem('GEMINI_API_KEY', geminiKey);
            localStorage.setItem('ELEVENLABS_API_KEY', elevenKey);
            document.getElementById('ai-settings-modal').classList.add('hidden');
            alert("âœ… AI è¨­å®šå·²å„²å­˜æˆåŠŸï¼");
        }
        window.saveAISettings = saveAISettings; // ç¢ºä¿å¯åœ¨ HTML onclick ä¸­å‘¼å«

        // --- æ ¸å¿ƒ logic ---
        function getVal(id) { return (document.getElementById(id)?.value || '').trim(); }
        function setVal(id, val) {
            const el = document.getElementById(id);
            if (el) { el.value = val; generateAll(); }
        }
        function getList(id) { return getVal(id).split('\n').filter(x => x.trim()).map(x => `"${x.trim().replace(/"/g, '\\"')}"`).join(',\n            '); }
        function getSFX(id) {
            const v = getVal(id); if (!v) return null;
            const fix = (s) => (s.startsWith('http') || s.startsWith('data:')) ? s : "sound/" + s;
            return v.includes(',') ? `[${v.split(',').map(s => `"${fix(s.trim())}"`).join(', ')}]` : `["${fix(v)}"]`;
        }

        function generateAll() {
            const tid = getVal('theme-id') || 'new_theme';

            // æ›´æ–°éé ­åƒè³‡æºé è¦½
            const updatePrev = (id, prevId) => {
                const val = getVal(id);
                const el = document.getElementById(prevId);
                if (el) el.src = val.startsWith('http') ? val : (val ? 'img/' + val : '');
            };
            updatePrev('img-mapBg', 'prev-mapBg');
            updatePrev('img-guideNPC', 'prev-guideNPC');
            updatePrev('img-loadingGif', 'prev-loadingGif');

            // ç”¢ç”Ÿé ­åƒå­—ä¸²
            let avStr = [];
            document.querySelectorAll('.avatar-row').forEach(r => {
                const k = r.querySelector('.avatar-key').value.trim();
                const f = r.querySelector('.avatar-file').value.trim();
                if (k && f) {
                    const path = f.startsWith('http') ? f : `img/${f}`;
                    avStr.push(`        "${k}": "${path}"`);
                }
            });

            // ç”¢ç”Ÿåº§æ¨™å­—ä¸²
            let coStr = coordinates.map(c => `        { top: "${c.t}", left: "${c.l}" }`).join(',\n');
            if (coordinates.length < 20) {
                const remain = 20 - coordinates.length;
                coStr += (coStr ? ',\n' : '') + `        // ... (é‚„éœ€è¦é»æ“Šåœ°åœ–å¢åŠ  ${remain} å€‹é»æ‰èƒ½é–‹å§‹éŠæˆ²)`;
            }

            // ç”¢ç”ŸéŸ³æ•ˆå­—ä¸²
            let sfxArr = [];
            ['click', 'dice', 'move', 'success', 'fail', 'complete', 'bgm'].forEach(k => {
                const val = getSFX('sfx-' + (k === 'bgm' ? 'bgm' : k));
                if (val) sfxArr.push(`        "${k}": ${val}`);
            });

            const themeJs = `window.CURRENT_THEME_CONFIG = {
    GAS_URL: "${getVal('gas-url')}",
    BOARD_COORDINATES: [
${coStr}
    ],
    ASSETS: {
        AVATARS: {
${avStr.join(',\n')}
        },
        IMAGES: {
            "guideNPC": "img/${getVal('img-guideNPC')}",
            "loadingGif": "img/${getVal('img-loadingGif')}",
            "mapBg": "img/${getVal('img-mapBg')}"
        },
        SFX: {
${sfxArr.join(',\n')}
        },
        TEXT: {
            NPC_WELCOME: "${getVal('txt-welcome') || 'æ­¡è¿ä¾†åˆ°æ–°ä¸–ç•Œï¼'}",
            NPC_IDLE_CHATS: [
                ${getList('txt-idle')}
            ],
            MII_ADJECTIVES: [
                ${getList('txt-adj')}
            ],
            MII_NOUNS: [
                ${getList('txt-noun')}
            ]
        }
    }
};`;

            const listEntry = `    {
        id: "${tid}",
        name: "${getVal('theme-name')}",
        description: "${getVal('theme-desc').replace(/\n/g, '\\n')}",
        cover: "img/${getVal('img-mapBg')}"
    },`;

            document.getElementById('output-theme-js').value = themeJs;
            document.getElementById('output-list-js').value = listEntry;
        }

        async function aiCall(prompt) {
            const apiKey = localStorage.getItem('GEMINI_API_KEY');
            if (!apiKey) {
                alert("è«‹å…ˆè¨­å®š Gemini API Keyï¼");
                document.getElementById('ai-settings-modal').classList.remove('hidden');
                return null;
            }

            showLoading(true, "AI æ­£åœ¨ç™¼æƒ³å…§å®¹...");
            try {
                // ä½¿ç”¨ç¶“æ¸¬è©¦è­‰æ˜æœ€ç›¸å®¹çš„ 2.0-flash æ¨¡å‹èˆ‡ v1 ç«¯é»
                const url = `https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt + " \n\nè«‹å‹™å¿…åƒ…ä»¥ç´” JSON æ ¼å¼å›ç­”ï¼Œä¸è¦æœ‰å…¶ä»–è§£é‡‹æ–‡å­—ã€‚" }] }]
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error?.message || `API Error: ${response.status}`);
                }

                if (!data.candidates || data.candidates.length === 0) {
                    // Check if there's a safety filter reason
                    const reason = data.promptFeedback?.blockReason || "æ‰¾ä¸åˆ°å€™é¸ç­”æ¡ˆ (å¯èƒ½æ˜¯è¢«å®‰å…¨éæ¿¾å™¨é˜»æ“‹)";
                    throw new Error(reason);
                }

                let text = data.candidates[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("API å›å‚³å…§å®¹çµæ§‹ä¸æ­£ç¢º");

                // æ¸…ç†å¯èƒ½åŒ…å«çš„ Markdown JSON å€å¡Š
                text = text.replace(/```json\n?/, '').replace(/\n?```/, '').trim();

                try {
                    return JSON.parse(text);
                } catch (parseErr) {
                    console.error("JSON Parse Error. Content:", text);
                    throw new Error("AI å›å‚³çš„æ ¼å¼ä¸ç¬¦åˆ JSONï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚");
                }
            } catch (err) {
                console.error("AI Call Failed:", err);
                alert("ğŸ¤– AI å‘¼å«å¤±æ•—ï¼š\n" + err.message);
                return null;
            } finally {
                showLoading(false);
            }
        }

        async function aiCompleteInfo() {
            const base = getVal('theme-name') || getVal('theme-id');
            const prompt = `ä½ æ˜¯ä¸€å€‹éŠæˆ²è¨­è¨ˆå¸«ã€‚è«‹é‡å°ä¸»é¡Œã€Œ${base}ã€æä¾›ä»¥ä¸‹ JSON è³‡è¨Šï¼š
            {
                "name": "å¸å¼•äººçš„ä¸»é¡Œåç¨±(å« Emoji)",
                "description": "ç°¡çŸ­çš„ä¸»é¡Œä»‹ç´¹(ç´„ 50 å­—)",
                "welcome": "NPC æ­¡è¿è©",
                "id": "é©ç”¨çš„è‹±æ–‡å°å¯« ID"
            } 
            è«‹ç¹é«”ä¸­æ–‡è¼¸å‡ºã€‚`;
            const result = await aiCall(prompt);
            if (result) {
                setVal('theme-name', result.name);
                setVal('theme-desc', result.description);
                setVal('theme-id', result.id);
                setVal('txt-welcome', result.welcome);
            }
        }

        async function aiGenerateChats() {
            const base = getVal('theme-name');
            const prompt = `é‡å°éŠæˆ²ä¸»é¡Œã€Œ${base}ã€ï¼Œç”Ÿæˆ 10 å¥ NPC çš„é–’èŠå°è«‡(æ¯å¥15å­—ä»¥å…§)ï¼Œ
            è¼¸å‡ºæ ¼å¼å¦‚ï¼š { "chats": ["ç¬¬ä¸€å¥", "ç¬¬äºŒå¥", ...] } 
            ç¹é«”ä¸­æ–‡ã€‚`;
            const result = await aiCall(prompt);
            if (result) setVal('txt-idle', result.chats.join('\n'));
        }

        async function aiGenerateList(type) {
            const base = getVal('theme-name');
            const prompt = `é‡å°éŠæˆ²ä¸»é¡Œã€Œ${base}ã€ï¼Œç”Ÿæˆ 15 å€‹é©åˆç”¨ä¾†éš¨æ©Ÿçµ„åˆæˆè§’è‰²æš±ç¨±çš„ ${type === 'adj' ? 'å½¢å®¹è©' : 'åè©'}ã€‚
            è¼¸å‡ºæ ¼å¼ï¼š { "list": ["è©1", "è©2", ...] }`;
            const result = await aiCall(prompt);
            if (result) setVal('txt-' + type, result.list.join('\n'));
        }

        async function aiGenerateQuestions() {
            const count = coordinates.length;
            if (count === 0) return alert("è«‹å…ˆåœ¨ä¸Šæ–¹åœ°åœ–é»æ“Šæ¨™è¨»è‡³å°‘ä¸€å€‹åœ°é»ï¼ŒAI æ‰èƒ½ç‚ºæ‚¨å–åä¸¦è£½ä½œé¡Œç›®ã€‚");

            const base = getVal('theme-name');
            const topic = document.getElementById('ai-questions-topic').value.trim();
            const topicConstraint = topic ? `\nç‰¹åˆ¥é‡å°ä»¥ä¸‹æ•™å­¸å…§å®¹æˆ–é‡é»ç”Ÿæˆï¼š\n${topic}\n` : '';

            const prompt = `ä½ æ˜¯ä¸€å€‹äº’å‹•å¼å¤§å¯Œç¿éŠæˆ²è¨­è¨ˆå°ˆå®¶ã€‚è«‹é‡å°ä¸»é¡Œã€Œ${base}ã€${topicConstraint}ï¼Œç”Ÿæˆ ${count} å€‹åœ°é»èˆ‡å°æ‡‰çš„å››é¸ä¸€å–®é¸é¡Œã€‚
            è¼¸å‡ºæ ¼å¼å¿…é ˆæ˜¯ç´” JSONï¼Œçµæ§‹å¦‚ä¸‹ï¼š
            {
                "map": [
                    {"city": "åœ°é»åç¨±1", "questionId": "q1", "isMustHit": false},
                    ... (å…± ${count} å€‹åœ°é»)
                ],
                "questions": {
                    "q1": {"text": "é¡Œç›®å…§å®¹", "options": ["é¸é …1", "é¸é …2", "é¸é …3", "é¸é …4"], "answer": 1},
                    ... (å…± ${count} å€‹é¡Œç›®, answer æ˜¯ 1-4 çš„æ•¸å­—)
                }
            }
            è«‹ç¢ºä¿å…§å®¹è±å¯Œã€æœ‰è¶£ä¸”ç¬¦åˆç¹é«”ä¸­æ–‡ç¿’æ…£ã€‚`;
            const result = await aiCall(prompt);
            if (result) {
                document.getElementById('output-questions-json').value = JSON.stringify(result, null, 2);
                alert("éŠæˆ²é¡Œç›®é›†ç”ŸæˆæˆåŠŸï¼å·²å¥—ç”¨æ–¼æœ¬åœ°èˆ‡é›²ç«¯ç™¼ä½ˆå€ã€‚");
            }
        }

        async function generateAIImage(promptSourceId, targetImgId, targetIdInputId) {
            const prompt = document.getElementById(promptSourceId).value.trim();
            if (!prompt) return alert("è«‹å…ˆç”Ÿæˆ AI æç¤ºè©ï¼");

            showLoading(true, "æ­£åœ¨ç¹ªè£½åœ–åƒ (Pollinations.ai)...");
            try {
                // Pollinations.ai ç›´æ¥ç”Ÿæˆ URL
                const seed = Math.floor(Math.random() * 10000);
                const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=1024&height=1024&seed=${seed}&nologo=true`;

                // é è¼‰åœ–ç‰‡ç¢ºèªæˆåŠŸ
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = () => {
                    if (targetImgId) document.getElementById(targetImgId).src = imageUrl;
                    if (targetIdInputId) document.getElementById(targetIdInputId).value = imageUrl;
                    showLoading(false);
                    generateAll();
                };
                img.onerror = () => {
                    throw new Error("åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œè«‹æ›å€‹æç¤ºè©å†è©¦ä¸€æ¬¡ã€‚");
                };
                img.src = imageUrl;
            } catch (err) {
                alert("ç”Ÿåœ–å¤±æ•—: " + err.message);
                showLoading(false);
            }
        }

        async function aiGeneratePrompts() {
            const base = getVal('theme-name');
            const prompt = `ä½ æ˜¯ä¸€å€‹è³‡æ·±éŠæˆ²ç¾è¡“æŒ‡å°ã€‚é‡å°å¤§å¯Œç¿éŠæˆ²ä¸»é¡Œã€Œ${base}ã€ï¼Œç”Ÿæˆä»¥ä¸‹è³‡æºçš„ AI ç¹ªåœ–/å½±ç‰‡/éŸ³æ¨‚æç¤ºè© (Prompts)ï¼š
            1. åœ°åœ–èƒŒæ™¯åœ– (Map Background): åŒ…å«è±å¯Œçš„åœ°ç†å…ƒç´ èˆ‡é¢¨æ ¼æè¿°ã€‚
            2. åš®å°è§’è‰² (Guide NPC): æè¿°è§’è‰²å¤–è§€ã€ç¥æ…‹èˆ‡æœè£ã€‚
            3. è¼‰å…¥é å½±ç‰‡å‹•ç•« (Loading Video): é‡å° Luma/Runway å½±ç‰‡ç”Ÿæˆå™¨çš„æç¤ºè©ï¼Œå¼·èª¿å‹•æ…‹æ„Ÿ(å¦‚: "cinematic slow motion, shimmering particles, character walking towards camera")ã€‚
            4. å››å€‹ä¸åŒçš„è§’è‰²é ­åƒ (4 character avatars): é‡å°é ­åƒè¨­è¨ˆã€‚
            5. èƒŒæ™¯éŸ³æ¨‚ (BGM) é¢¨æ ¼æ¨™ç±¤: çµ¦ Suno/Mubert çš„é¢¨æ ¼æ¨™ç±¤ (å¦‚: "Lo-fi, Adventurous, 8-bit, Cinematic, orchestral")ã€‚
            æç¤ºè©è«‹ä½¿ç”¨ã€Œè‹±æ–‡ã€æ’°å¯«ã€‚
            è¼¸å‡º JSON æ ¼å¼ï¼š { 
                "map": "...", 
                "npc": "...", 
                "loading": "...", 
                "avatar": "shared avatar style prompt",
                "avatars": ["p1", "p2", "p3", "p4"],
                "bgm": "BGM style tags here"
            }`;

            const result = await aiCall(prompt);
            if (result) {
                document.getElementById('prompt-map').value = result.map;
                document.getElementById('prompt-npc').value = result.npc;
                document.getElementById('prompt-loading').value = result.loading;
                document.getElementById('prompt-avatar').value = result.avatar;
                // å­˜å„²é ­åƒçµ„ä»¥ä¾¿å¾ŒçºŒä½¿ç”¨
                window.AI_AVATAR_PROMPTS = result.avatars;

                document.getElementById('ai-prompts-output').innerHTML = `
                    <div class="mb-4 text-purple-900 font-extrabold border-b border-purple-200 pb-2 text-base">âœ¨ AI ç¾è¡“ææ¡ˆå…§å®¹</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-3 bg-purple-50/50 rounded-xl"><strong class="text-[10px] text-purple-400 uppercase">Map Background</strong><p class="text-xs mt-1 italic">"${result.map}"</p></div>
                        <div class="p-3 bg-purple-50/50 rounded-xl"><strong class="text-[10px] text-purple-400 uppercase">NPC Guide</strong><p class="text-xs mt-1 italic">"${result.npc}"</p></div>
                        <div class="p-3 bg-purple-50/50 rounded-xl"><strong class="text-[10px] text-purple-400 uppercase">Loading Anim</strong><p class="text-xs mt-1 italic">"${result.loading}"</p></div>
                        <div class="p-3 bg-purple-50/50 rounded-xl"><strong class="text-[10px] text-purple-400 uppercase">Music Tags</strong><p class="text-xs mt-1 italic">"${result.bgm}"</p></div>
                    </div>
                `;
                document.getElementById('ai-prompts-output').classList.remove('hidden');
                document.getElementById('prompts-control').classList.remove('hidden');
                document.getElementById('btn-gen-map').disabled = false;
                document.getElementById('btn-gen-map').title = "æ ¹æ“šç›®å‰çš„åœ°åœ–æç¤ºè©ç”ŸæˆèƒŒæ™¯";
                alert("AI æç¤ºè©ç”Ÿæˆå®Œç•¢ï¼æ‚¨å¯ä»¥ç¹¼çºŒä¸‹ä¸€æ­¥ç”Ÿæˆåœ°åœ–ï¼Œæˆ–ç”Ÿæˆ NPC/é ­åƒã€‚");
            }
        }

        async function generateAIAvatars() {
            const basePrompt = document.getElementById('prompt-avatar').value;
            const specifics = window.AI_AVATAR_PROMPTS || [];
            if (!basePrompt || specifics.length === 0) return alert("è«‹å…ˆç”Ÿæˆ AI æç¤ºè©ï¼");

            showLoading(true, "æ­£åœ¨ç”Ÿæˆè§’è‰²é ­åƒçµ„...");
            try {
                const avatarList = document.getElementById('avatar-list');
                const existingRows = avatarList.querySelectorAll('.avatar-row').length;

                for (let i = 0; i < specifics.length; i++) {
                    const fullPrompt = `${specifics[i]}, ${basePrompt}`;
                    const seed = Math.floor(Math.random() * 100000);
                    const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(fullPrompt)}?width=512&height=512&seed=${seed}&nologo=true`;

                    // æ–°å¢ä¸€åˆ—ï¼Œç·¨è™Ÿå»¶çºŒç¾æœ‰æ•¸é‡
                    const key = `char_${existingRows + i + 1}`;
                    addAvatarRow(key, url);
                }
                alert(`âœ… æ–°å¢äº† ${specifics.length} ä½è§’è‰²ï¼ç›®å‰å…±æœ‰ ${avatarList.querySelectorAll('.avatar-row').length} ä½ã€‚`);
                generateAll();
            } catch (err) {
                alert("é ­åƒç”Ÿæˆå¤±æ•—: " + err.message);
            } finally {
                showLoading(false);
            }
        }

        async function generateAISFX(inputId, defaultText) {
            const apiKey = localStorage.getItem('ELEVENLABS_API_KEY');
            if (!apiKey) {
                alert("è«‹å…ˆè¨­å®š ElevenLabs API Keyï¼");
                document.getElementById('ai-settings-modal').classList.remove('hidden');
                return;
            }

            const themeName = getVal('theme-name') || 'fantasy game';
            const userPrompt = window.prompt(`ã€AI éŸ³æ•ˆç”Ÿæˆã€‘è«‹ä¿®æ­£æˆ–è¼¸å…¥æç¤ºè©ï¼š`, `A ${defaultText} for a ${themeName} themed game`);
            if (!userPrompt) return;

            showLoading(true, "æ­£åœ¨é€é ElevenLabs ç”ŸæˆéŸ³æ•ˆ...");
            try {
                const url = "https://api.elevenlabs.io/v1/sound-generation";
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'xi-api-key': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: userPrompt,
                        duration_seconds: 5, // æœ€é•· 30 ç§’
                        prompt_influence: 0.3
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail?.message || "ç”Ÿæˆå¤±æ•—");
                }

                const audioBlob = await response.blob();
                const tid = getVal('theme-id') || 'temp';

                // ä¸Šå‚³è‡³ Firebase Storage ç¢ºä¿ç¶²å€æ°¸ä¹…å¯ç”¨
                const downloadUrl = await uploadFile(audioBlob, `themes/${tid}/sfx`, `${inputId}_${Date.now()}.mp3`);

                document.getElementById(inputId).value = downloadUrl;
                alert("âœ… éŸ³æ•ˆç”Ÿæˆä¸¦ä¸Šå‚³æˆåŠŸï¼");
                generateAll();
            } catch (err) {
                console.error("SFX Generation Error:", err);
                alert("âŒ éŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼š" + err.message);
            } finally {
                showLoading(false);
            }
        }

        async function generateAIMusic(inputId, defaultText) {
            const apiKey = localStorage.getItem('ELEVENLABS_API_KEY');
            if (!apiKey) {
                alert("è«‹å…ˆè¨­å®š ElevenLabs API Keyï¼");
                document.getElementById('ai-settings-modal').classList.remove('hidden');
                return;
            }

            const themeName = getVal('theme-name') || 'adventure game';
            const userPrompt = window.prompt(`ã€AI éŸ³æ¨‚ç”Ÿæˆã€‘è«‹ä¿®æ­£æˆ–è¼¸å…¥éŸ³æ¨‚æè¿°ï¼š`, `${defaultText} for a ${themeName} themed board game, looped, high quality`);
            if (!userPrompt) return;

            showLoading(true, "æ­£åœ¨é€é ElevenLabs ç”ŸæˆèƒŒæ™¯éŸ³æ¨‚...");
            try {
                const url = "https://api.elevenlabs.io/v1/music";
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'xi-api-key': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: userPrompt,
                        music_length_ms: 30000 // ElevenLabs Music ä½¿ç”¨ ms
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail?.message || "ç”Ÿæˆå¤±æ•—");
                }

                const audioBlob = await response.blob();
                const tid = getVal('theme-id') || 'temp';

                // ä¸Šå‚³è‡³ Firebase Storage ç¢ºä¿ç¶²å€æ°¸ä¹…å¯ç”¨
                const downloadUrl = await uploadFile(audioBlob, `themes/${tid}/music`, `bgm_${Date.now()}.mp3`);

                document.getElementById(inputId).value = downloadUrl;
                alert("âœ… èƒŒæ™¯éŸ³æ¨‚ç”Ÿæˆä¸¦ä¸Šå‚³æˆåŠŸï¼");
                generateAll();
            } catch (err) {
                console.error("Music Generation Error:", err);
                alert("âŒ éŸ³æ¨‚ç”Ÿæˆå¤±æ•—ï¼š" + err.message);
            } finally {
                showLoading(false);
            }
        }

        window.generateAIAvatars = generateAIAvatars;
        window.generateAISFX = generateAISFX;
        window.generateAIMusic = generateAIMusic;

        // --- Firebase Helper ---
        async function uploadFile(fileOrUrl, folder, filename) {
            if (!fileOrUrl) return null;

            // å¦‚æœå·²ç¶“æ˜¯ Firebase Storage çš„é€£çµï¼Œç›´æ¥å‚³å›ï¼Œé¿å… CORS fetch å•é¡Œ
            if (typeof fileOrUrl === 'string' && fileOrUrl.includes('firebasestorage.googleapis.com')) {
                return fileOrUrl;
            }

            let blob;
            if (typeof fileOrUrl === 'string' && fileOrUrl.startsWith('http')) {
                try {
                    const res = await fetch(fileOrUrl);
                    if (!res.ok) throw new Error("Fetch failed");
                    blob = await res.blob();
                } catch (e) {
                    console.error("CORS or Fetch error:", fileOrUrl);
                    // é‡å° Pollinations ç­‰æœå‹™ï¼Œè‹¥å¤±æ•—å‰‡å‚³å›åŸç¶²å€å˜—è©¦
                    return fileOrUrl;
                }
            } else {
                blob = fileOrUrl;
            }
            const name = filename || (blob.name ? `${Date.now()}_${blob.name}` : `${Date.now()}.png`);
            const ref = storage.ref(`${folder}/${name}`);
            const snapshot = await ref.put(blob);
            return await snapshot.ref.getDownloadURL();
        }



        async function publishToCloud() {
            if (coordinates.length === 0) return alert("åœ°åœ–åº§æ¨™é»è‡³å°‘è¦æœ‰ä¸€å€‹ï¼");

            // 1. èº«ä»½é©—è­‰ (ZBP)
            const code = prompt("ã€ç®¡ç†é©—è­‰ã€‘è«‹è¼¸å…¥ç™¼ä½ˆä»£ç¢¼ä»¥ç¹¼çºŒï¼š");
            if (code !== 'ZBP') {
                alert("é©—è­‰éŒ¯èª¤ï¼Œæ‚¨æ²’æœ‰æ¬Šé™ç™¼ä½ˆè‡³é›²ç«¯ã€‚");
                return;
            }

            showLoading(true, "æ­£åœ¨æº–å‚™é›²ç«¯ç™¼ä½ˆ...");
            try {
                const tid = getVal('theme-id');
                const themeName = getVal('theme-name');

                // 1. è™•ç†æª”æ¡ˆä¸Šå‚³ (åŒ…å« Pollinations URL è½‰å­˜)
                let mapBgUrl = getVal('img-mapBg');
                const mapFile = document.getElementById('map-upload').files[0];
                if (mapFile) {
                    mapBgUrl = await uploadFile(mapFile, `themes/${tid}/images`, 'map_bg.png');
                } else if (mapBgUrl.startsWith('http')) {
                    mapBgUrl = await uploadFile(mapBgUrl, `themes/${tid}/images`, 'map_bg.png');
                }

                let npcUrl = getVal('img-guideNPC');
                if (npcUrl.startsWith('http')) {
                    npcUrl = await uploadFile(npcUrl, `themes/${tid}/images`, 'npc.png');
                }

                let loadingUrl = getVal('img-loadingGif');
                if (loadingUrl.startsWith('http')) {
                    loadingUrl = await uploadFile(loadingUrl, `themes/${tid}/images`, 'loading.gif');
                }

                // 2. è™•ç†é ­åƒä¸Šå‚³
                const avatars = {};
                const avatarRows = document.querySelectorAll('.avatar-row');
                for (const row of avatarRows) {
                    const k = row.querySelector('.avatar-key').value.trim();
                    let f = row.querySelector('.avatar-file').value.trim();
                    if (k && f) {
                        if (f.startsWith('http')) {
                            f = await uploadFile(f, `themes/${tid}/avatars`, `${k}.png`);
                        }
                        avatars[k] = f;
                    }
                }

                // 3. æº–å‚™è¨­å®šæª”
                const themeConfig = {
                    id: tid,
                    name: themeName,
                    description: getVal('theme-desc'),
                    gasUrl: getVal('gas-url'),
                    coordinates: coordinates,
                    assets: {
                        avatars: avatars,
                        images: {
                            guideNPC: npcUrl,
                            loadingGif: loadingUrl,
                            mapBg: mapBgUrl
                        },
                        text: {
                            welcome: getVal('txt-welcome'),
                            idleChats: getVal('txt-idle').split('\n').filter(x => x.trim()),
                            adj: getVal('txt-adj').split('\n').filter(x => x.trim()),
                            noun: getVal('txt-noun').split('\n').filter(x => x.trim())
                        },
                        SFX: {
                            bgm: getVal('sfx-bgm'),
                            click: getVal('sfx-click'),
                            dice: getVal('sfx-dice'),
                            move: getVal('sfx-move'),
                            success: getVal('sfx-success'),
                            fail: getVal('sfx-fail'),
                            complete: getVal('sfx-complete')
                        }
                    }
                };

                // 4. æº–å‚™é¡Œç›®æª”
                let questionsData = JSON.parse(document.getElementById('output-questions-json').value);

                // 5. å¯«å…¥ Database
                await db.ref(`themes/${tid}`).set(themeConfig);
                await db.ref(`questions/${tid}`).set(questionsData);
                await db.ref(`available_themes/${tid}`).set({
                    id: tid, name: themeName, description: getVal('theme-desc'), cover: mapBgUrl, isCloud: true
                });

                alert("âœ… é›²ç«¯å¹³å°ç™¼ä½ˆæˆåŠŸï¼");
            } catch (err) {
                console.error(err);
                alert("âŒ ç™¼ä½ˆå¤±æ•—ï¼š" + err.message);
            } finally {
                showLoading(false);
            }
        }

        // --- å…¨åŸŸæ›è¼‰ ---
        async function openCloudThemesModal() {
            const modal = document.getElementById('cloud-themes-modal');
            const list = document.getElementById('cloud-themes-list');
            modal.classList.remove('hidden');
            list.innerHTML = '<div class="text-center py-10 text-gray-400">æ­£åœ¨è®€å–é›²ç«¯æ¸…å–®...</div>';

            try {
                const snapshot = await db.ref('available_themes').get();
                if (!snapshot.exists()) {
                    list.innerHTML = '<div class="text-center py-10 text-gray-400">ç›®å‰æ²’æœ‰é›²ç«¯ä¸»é¡Œ</div>';
                    return;
                }
                const themes = snapshot.val();
                list.innerHTML = '';
                Object.values(themes).forEach(t => {
                    const item = document.createElement('div');
                    item.className = "flex items-center justify-between p-4 bg-indigo-50 rounded-2xl hover:bg-indigo-100 transition-colors cursor-pointer group";
                    item.innerHTML = `
                        <div class="flex items-center gap-4">
                            <img src="${t.cover}" class="w-12 h-12 rounded-lg object-cover bg-gray-200">
                            <div>
                                <div class="font-bold text-indigo-900">${t.name}</div>
                                <div class="text-[10px] text-gray-500">${t.id}</div>
                            </div>
                        </div>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="loadThemeFromCloud('${t.id}')" class="px-3 py-1.5 bg-indigo-600 text-white rounded-lg text-xs font-bold">è¼‰å…¥ä¿®æ”¹</button>
                            <button onclick="deleteThemeFromCloud('${t.id}', '${t.name}')" class="px-3 py-1.5 bg-red-50 text-red-600 rounded-lg text-xs font-bold hover:bg-red-100">åˆªé™¤</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (err) {
                list.innerHTML = `<div class="text-center py-10 text-red-400">è®€å–å¤±æ•—ï¼š${err.message}</div>`;
            }
        }

        async function loadThemeFromCloud(tid) {
            showLoading(true, "æ­£åœ¨å¾é›²ç«¯è¼‰å…¥è³‡æ–™...");
            try {
                const [themeSnap, qSnap] = await Promise.all([
                    db.ref(`themes/${tid}`).get(),
                    db.ref(`questions/${tid}`).get()
                ]);

                if (!themeSnap.exists()) throw new Error("æ‰¾ä¸åˆ°è©²ä¸»é¡Œçš„è¨­å®šè³‡æ–™");
                const config = themeSnap.val();
                const questions = qSnap.val();

                // å¡«å…¥åŸºæœ¬è³‡è¨Š
                setVal('theme-id', config.id);
                setVal('theme-name', config.name);
                setVal('theme-desc', config.description);
                setVal('gas-url', config.gasUrl || '');

                // å¡«å…¥åœ°åœ–èƒŒæ™¯èˆ‡ NPC
                setVal('img-mapBg', config.assets.images.mapBg);
                setVal('img-guideNPC', config.assets.images.guideNPC);
                setVal('img-loadingGif', config.assets.images.loadingGif);
                document.getElementById('map-preview').src = config.assets.images.mapBg;

                // å¡«å…¥æ–‡å­—è³‡æº
                setVal('txt-welcome', config.assets.text.welcome);
                setVal('txt-idle', (config.assets.text.idleChats || []).join('\n'));
                setVal('txt-adj', (config.assets.text.adj || []).join('\n'));
                setVal('txt-noun', (config.assets.text.noun || []).join('\n'));

                // å¡«å…¥åº§æ¨™
                coordinates = (config.coordinates || []).map(c => ({ t: c.top || c.t, l: c.left || c.l }));
                updatePoints();

                // å¡«å…¥é ­åƒ
                const avatarList = document.getElementById('avatar-list');
                avatarList.innerHTML = '';
                for (let k in (config.assets.avatars || {})) {
                    addAvatarRow(k, config.assets.avatars[k]);
                }

                // å¡«å…¥éŸ³æ•ˆèˆ‡ BGM (æ”¯æ´æ–°èˆŠ Key)
                const sfx = config.assets.SFX || config.assets.sfx || {};
                setVal('sfx-bgm', sfx.bgm || sfx['sfx-bgm'] || '');
                setVal('sfx-click', sfx.click || sfx['sfx-click'] || '');
                setVal('sfx-dice', sfx.dice || sfx['sfx-dice'] || '');
                setVal('sfx-move', sfx.move || sfx['sfx-move'] || '');
                setVal('sfx-success', sfx.success || sfx['sfx-success'] || '');
                setVal('sfx-fail', sfx.fail || sfx['sfx-fail'] || '');
                setVal('sfx-complete', sfx.complete || sfx['sfx-complete'] || '');

                // å¡«å…¥é¡Œç›®
                if (questions) {
                    document.getElementById('output-questions-json').value = JSON.stringify(questions, null, 2);
                }

                document.getElementById('cloud-themes-modal').classList.add('hidden');
                alert(`âœ… ä¸»é¡Œ ã€Œ${config.name}ã€ è¼‰å…¥æˆåŠŸï¼`);
                generateAll();
            } catch (err) {
                alert("âŒ è¼‰å…¥å¤±æ•—ï¼š" + err.message);
            } finally {
                showLoading(false);
            }
        }

        async function deleteThemeFromCloud(tid, tname) {
            const code = prompt(`ã€ç®¡ç†æˆæ¬Šã€‘å³å°‡åˆªé™¤ä¸»é¡Œã€Œ${tname} (${tid})ã€\næ­¤å‹•ä½œç„¡æ³•é‚„åŸï¼Œè«‹è¼¸å…¥ç®¡ç†ä»£ç¢¼ï¼š`);
            if (code !== 'ZBP') return alert("é©—è­‰å¤±æ•—ï¼Œå–æ¶ˆåˆªé™¤ã€‚");

            if (!confirm(`ç¢ºå®šè¦å¾¹åº•åˆªé™¤ä¸»é¡Œã€Œ${tname}ã€å—ï¼Ÿ`)) return;

            showLoading(true, "æ­£åœ¨åˆªé™¤ä¸»é¡Œ...");
            try {
                await Promise.all([
                    db.ref(`themes/${tid}`).remove(),
                    db.ref(`questions/${tid}`).remove(),
                    db.ref(`available_themes/${tid}`).remove()
                ]);
                alert("âœ… ä¸»é¡Œå·²æˆåŠŸåˆªé™¤ã€‚");
                openCloudThemesModal(); // é‡æ–°æ•´ç†æ¸…å–®
            } catch (err) {
                alert("âŒ åˆªé™¤å¤±æ•—ï¼š" + err.message);
            } finally {
                showLoading(false);
            }
        }

        window.openCloudThemesModal = openCloudThemesModal;
        window.loadThemeFromCloud = loadThemeFromCloud;
        window.deleteThemeFromCloud = deleteThemeFromCloud;
        window.publishToCloud = publishToCloud;
        window.aiCompleteInfo = aiCompleteInfo;
        window.aiGenerateChats = aiGenerateChats;
        window.aiGenerateList = aiGenerateList;
        window.aiGenerateQuestions = aiGenerateQuestions;
        window.aiGeneratePrompts = aiGeneratePrompts;
        window.generateAIImage = generateAIImage;
        window.addAvatarRow = addAvatarRow;
        window.saveAISettings = saveAISettings;

        // --- UI å°å·¥å…· ---
        function showLoading(show, text) {
            dom.overlay.classList.toggle('hidden', !show);
            if (text) dom.loadingText.textContent = text;
        }
        window.showLoading = showLoading;

        window.copyToClipboard = (id) => {
            const el = document.getElementById(id);
            el.select();
            document.execCommand('copy');
            alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
        };

        // --- åˆå§‹åŒ– ---
        function initThemeCreator() {
            // è¼‰å…¥é è¨­é ­åƒ
            defaultAvatars.forEach(a => addAvatarRow(a.key, a.file));

            // åœ°åœ–ä¸Šå‚³è™•ç†
            document.getElementById('map-upload').addEventListener('change', e => {
                const f = e.target.files[0]; if (!f) return;
                const r = new FileReader(); r.onload = ev => {
                    dom.mapImg.src = ev.target.result;
                    coordinates = []; updatePoints(); generateAll();
                }; r.readAsDataURL(f);
            });

            // åº§æ¨™é»æ“Šè™•ç†
            dom.pointsLayer.addEventListener('click', e => {
                const limit = 20;
                if (coordinates.length >= limit) return alert(`å·²é” ${limit} å€‹é»çš„ä¸Šé™`);
                const r = dom.mapContainer.getBoundingClientRect();
                const top = ((e.clientY - r.top) / r.height * 100).toFixed(1) + "%";
                const left = ((e.clientX - r.left) / r.width * 100).toFixed(1) + "%";
                coordinates.push({ t: top, l: left });
                updatePoints(); generateAll();
            });

            // å¤åŸä¸Šä¸€é»
            dom.undoBtn.onclick = () => { coordinates.pop(); updatePoints(); generateAll(); };

            // è‡ªå‹•æ›´æ–°
            document.querySelectorAll('input, textarea').forEach(el => {
                el.addEventListener('input', generateAll);
            });

            // é è¼‰ API Key
            document.getElementById('ai-api-key').value = localStorage.getItem('GEMINI_API_KEY') || '';
            document.getElementById('ai-eleven-key').value = localStorage.getItem('ELEVENLABS_API_KEY') || '';

            generateAll();
        }

        initThemeCreator();
    </script>
</body>

</html>