<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å¯Œç¿ä¸»é¡Œç”¢ç”Ÿå™¨ Pro | AI Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --glass: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1f2937;
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .input-stylish {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .input-stylish:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(to right, #6366f1, #8b5cf6);
            color: white;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4);
        }

        .map-container {
            position: relative;
            width: 100%;
            border-radius: 1rem;
            overflow: hidden;
            cursor: crosshair;
            background: #e2e8f0;
            border: 2px dashed #94a3b8;
        }

        .map-point {
            position: absolute;
            width: 28px;
            height: 28px;
            background: var(--primary);
            border: 3px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: 800;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            pointer-events: none;
            transition: all 0.2s;
        }

        .ai-glow {
            position: relative;
        }

        .ai-glow::after {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(45deg, #f06, #9f6, #06f, #f06);
            border-radius: inherit;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s;
            filter: blur(8px);
        }

        .ai-glow:hover::after {
            opacity: 0.6;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
            <div>
                <h1 class="text-5xl font-extrabold text-white drop-shadow-lg tracking-tight">å¤§å¯Œç¿ä¸»é¡Œç”¢ç”Ÿå™¨ <span
                        class="bg-clip-text text-transparent bg-gradient-to-r from-yellow-300 to-orange-400">PRO</span>
                </h1>
                <p class="text-indigo-100 text-lg mt-2 font-light italic">Powered by AI - Create your world in minutes.
                </p>
            </div>
            <div class="flex gap-4">
                <button onclick="document.getElementById('ai-settings-modal').classList.remove('hidden')"
                    class="px-5 py-3 glass-card text-indigo-900 font-bold flex items-center gap-2 hover:bg-white transition-all">
                    âš™ï¸ AI è¨­å®š
                </button>
                <button onclick="saveToProject()"
                    class="btn-primary px-8 py-3 rounded-2xl font-bold text-lg shadow-xl flex items-center gap-2">
                    ğŸš€ å„²å­˜è‡³å°ˆæ¡ˆ
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Side: Config -->
            <div class="lg:col-span-2 space-y-8">

                <!-- 1. åŸºæœ¬è³‡è¨Š -->
                <section class="glass-card p-8">
                    <div class="flex justify-between items-center mb-6 text-indigo-900 border-b pb-4 border-indigo-100">
                        <h2 class="text-2xl font-bold flex items-center gap-2">âœ¨ 1. ä¸»é¡ŒåŸºå› </h2>
                        <button onclick="aiCompleteInfo()"
                            class="ai-glow px-4 py-2 bg-white rounded-full text-sm font-bold shadow-sm flex items-center gap-2 text-indigo-600">
                            ğŸª„ AI è‡ªå‹•è£œå®Œ
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm font-bold text-gray-700">ä¸»é¡Œ ID (è‹±æ–‡+ä¸‹åº•ç·š)</label>
                            <input type="text" id="theme-id" placeholder="ä¾‹å¦‚: mars_mission"
                                class="w-full p-3 rounded-xl input-stylish" value="new_adventure">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-bold text-gray-700">ä¸»é¡Œåç¨± (é¡¯ç¤ºæ–‡å­—)</label>
                            <input type="text" id="theme-name" placeholder="ä¾‹å¦‚: ğŸš€ ç«æ˜Ÿç™»é™¸è¨ˆåŠƒ"
                                class="w-full p-3 rounded-xl input-stylish" value="æ–°ä¸–ç•Œå†’éšª">
                        </div>
                        <div class="md:col-span-2 space-y-2">
                            <label class="text-sm font-bold text-gray-700">ç°¡çŸ­æè¿°</label>
                            <textarea id="theme-desc" rows="2" class="w-full p-3 rounded-xl input-stylish"
                                placeholder="ä»‹ç´¹æ‚¨çš„æ–°å†’éšª..."></textarea>
                        </div>
                        <div class="md:col-span-2 space-y-2">
                            <label class="text-sm font-bold text-gray-700">Google App Script (GAS) ç¶²å€</label>
                            <input type="text" id="gas-url" placeholder="https://script.google.com/..."
                                class="w-full p-3 rounded-xl input-stylish font-mono text-xs">
                        </div>
                    </div>
                </section>

                <!-- 2. åœ°åœ–ä½ˆå±€ -->
                <section class="glass-card p-8">
                    <div class="flex justify-between items-center mb-6 text-indigo-900 border-b pb-4 border-indigo-100">
                        <h2 class="text-2xl font-bold flex items-center gap-2">ğŸ—ºï¸ 2. åœ°åœ–å°èˆª</h2>
                        <div class="text-sm px-4 py-1 bg-indigo-100 rounded-full font-bold">
                            ç¯€é»: <span id="point-count" class="text-indigo-600">0</span> / 20
                        </div>
                    </div>
                    <div class="mb-4 flex gap-4 items-center">
                        <input type="file" id="map-upload" accept="image/*"
                            class="flex-grow text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
                        <button id="undo-point"
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 disabled:opacity-50 transition-all"
                            disabled>â†©ï¸ å¤åŸ</button>
                    </div>
                    <div id="map-preview-container" class="map-container">
                        <img id="map-preview" class="w-full min-h-[300px] object-cover"
                            src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'><rect width='100%' height='100%' fill='%23f1f5f9'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='20' fill='%2394a3b8'>è«‹ä¸Šå‚³åœ°åœ–èƒŒæ™¯æˆ–è¼¸å…¥ AI æç¤º</text></svg>">
                        <div id="map-points-layer" class="absolute inset-0"></div>
                    </div>
                </section>

                <!-- 3. AI è¦–è¦ºä¸­å¿ƒ (New) -->
                <section class="glass-card p-8 bg-white/40">
                    <h2 class="text-2xl font-bold text-indigo-900 mb-6 flex items-center gap-2">ğŸ§  3. AI å…§å®¹ç”Ÿæˆ</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-indigo-900">
                        <!-- AI æ–‡å­— -->
                        <div class="space-y-6">
                            <div class="space-y-3">
                                <label class="block text-sm font-bold">NPC æ­¡è¿èˆ‡é–’èŠ</label>
                                <button onclick="aiGenerateChats()"
                                    class="w-full py-2 bg-indigo-50 border border-indigo-200 rounded-xl text-sm font-bold hover:bg-indigo-100 transition-colors">âœ¨
                                    ç”Ÿæˆ AI å°è©±</button>
                                <textarea id="txt-idle" rows="4" class="w-full p-3 rounded-xl input-stylish text-sm"
                                    placeholder="ä¸€è¡Œä¸€å¥..."></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-2">
                                    <label class="block text-sm font-bold">æš±ç¨±å½¢å®¹è©</label>
                                    <button onclick="aiGenerateList('adj')"
                                        class="text-xs text-indigo-600 font-bold hover:underline mb-1">AI ç”Ÿæˆ</button>
                                    <textarea id="txt-adj" rows="4"
                                        class="w-full p-2 rounded-xl input-stylish text-xs font-mono"></textarea>
                                </div>
                                <div class="space-y-2">
                                    <label class="block text-sm font-bold">æš±ç¨±åè©</label>
                                    <button onclick="aiGenerateList('noun')"
                                        class="text-xs text-indigo-600 font-bold hover:underline mb-1">AI ç”Ÿæˆ</button>
                                    <textarea id="txt-noun" rows="4"
                                        class="w-full p-2 rounded-xl input-stylish text-xs font-mono"></textarea>
                                </div>
                            </div>
                        </div>
                        <!-- AI é¡Œç›® -->
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <label class="block text-sm font-bold">AI é¡Œç›®ç”¢ç”Ÿå™¨ (JSON)</label>
                                <button onclick="aiGenerateQuestions()"
                                    class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-bold hover:bg-orange-200">ç”Ÿæˆ
                                    GAS å°ˆç”¨é¡Œç›®</button>
                            </div>
                            <div class="relative group">
                                <textarea id="output-questions-json" rows="8"
                                    class="w-full p-3 rounded-xl input-stylish text-xs font-mono bg-gray-900 text-green-400"
                                    placeholder="ç”Ÿæˆçš„é¡Œç›®å°‡é¡¯ç¤ºåœ¨æ­¤ï¼Œå¯è²¼åˆ° GAS..."></textarea>
                                <button onclick="copyToClipboard('output-questions-json')"
                                    class="absolute top-2 right-2 px-2 py-1 bg-gray-700 text-white text-[10px] rounded opacity-0 group-hover:opacity-100 transition-opacity">è¤‡è£½</button>
                            </div>
                            <!-- AI ç¹ªåœ–æŒ‡ä»¤ç”Ÿæˆ -->
                            <div class="space-y-3 pt-4 border-t border-indigo-100">
                                <label class="block text-sm font-bold">ğŸ¨ AI ç¹ªåœ–æŒ‡ä»¤ç”Ÿæˆ</label>
                                <button onclick="aiGenerateImagePrompts()"
                                    class="w-full py-2 bg-purple-50 border border-purple-200 rounded-xl text-sm font-bold text-purple-700 hover:bg-purple-100 italic transition-all active:scale-95">âœ¨
                                    ç”Ÿæˆåœ°åœ–èˆ‡ NPC æŒ‡ä»¤</button>
                                <div id="ai-img-prompts"
                                    class="text-[10px] text-gray-600 bg-white/50 p-3 rounded-xl hidden border border-purple-100 leading-relaxed">
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
            </section>
        </div>

        <!-- Right Side: Preview & Assets -->
        <div class="space-y-8">
            <!-- è³‡æºè¨­å®š -->
            <section class="glass-card p-6">
                <h2 class="text-xl font-bold text-indigo-900 mb-6 border-b pb-3 border-indigo-100">ğŸ“¦ è³‡æºé…ç½®</h2>
                <div class="space-y-6">
                    <div class="bg-indigo-50/50 p-4 rounded-xl space-y-3">
                        <h3 class="text-xs font-extrabold uppercase tracking-widest text-indigo-400">ä¸»è¦è³‡æº (img/)
                        </h3>
                        <div class="space-y-2">
                            <div class="flex flex-col"><span
                                    class="text-[10px] font-bold text-indigo-800">åœ°åœ–èƒŒæ™¯</span><input type="text"
                                    id="img-mapBg" value="map_background.png"
                                    class="w-full p-2 bg-white rounded-lg text-xs border border-indigo-100"></div>
                            <div class="flex flex-col"><span class="text-[10px] font-bold text-indigo-800">åš®å°
                                    NPC</span><input type="text" id="img-guideNPC" value="guide_bear.png"
                                    class="w-full p-2 bg-white rounded-lg text-xs border border-indigo-100"></div>
                            <div class="flex flex-col"><span
                                    class="text-[10px] font-bold text-indigo-800">è¼‰å…¥å‹•ç•«</span><input type="text"
                                    id="img-loadingGif" value="loading_bear.gif"
                                    class="w-full p-2 bg-white rounded-lg text-xs border border-indigo-100"></div>
                        </div>
                    </div>

                    <div class="bg-indigo-50/50 p-4 rounded-xl space-y-3">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xs font-extrabold uppercase tracking-widest text-indigo-400">è§’è‰²é ­åƒ</h3>
                            <button onclick="addAvatarRow()"
                                class="text-xs bg-indigo-200 px-2 py-1 rounded-md font-bold text-indigo-700 hover:bg-indigo-300">ï¼‹</button>
                        </div>
                        <div id="avatar-list" class="space-y-2 max-h-40 overflow-y-auto pr-1"></div>
                    </div>

                    <div class="bg-indigo-50/50 p-4 rounded-xl space-y-3">
                        <h3 class="text-xs font-extrabold uppercase tracking-widest text-indigo-400">éŸ³æ•ˆ (ç•™ç©ºä½¿ç”¨é è¨­)
                        </h3>
                        <div class="grid grid-cols-1 gap-2">
                            <input type="text" id="sfx-bgm" placeholder="èƒŒæ™¯éŸ³æ¨‚ BGM"
                                class="w-full p-2 bg-white rounded-lg text-xs border border-indigo-100">
                            <input type="text" id="sfx-complete" placeholder="é€šé—œéŸ³æ•ˆ Complete"
                                class="w-full p-2 bg-white rounded-lg text-xs border border-indigo-100">
                        </div>
                    </div>
                </div>
            </section>

            <!-- ç¨‹å¼ç¢¼è¼¸å‡º (æ‘ºç–Š) -->
            <section class="glass-card p-6 overflow-hidden">
                <button onclick="toggleCodeView()"
                    class="w-full flex justify-between items-center text-sm font-bold text-indigo-900 group">
                    <span>ğŸ“„ æŸ¥çœ‹åŸå§‹ç¢¼</span>
                    <span id="code-toggle-icon" class="group-hover:translate-x-1 transition-transform">â†’</span>
                </button>
                <div id="code-view" class="mt-4 space-y-4 hidden animate-in fade-in duration-300">
                    <div class="space-y-1">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">theme.js</span>
                        <textarea id="output-theme-js"
                            class="w-full h-40 p-3 bg-gray-900 text-green-400 rounded-xl text-[10px] font-mono"
                            readonly></textarea>
                    </div>
                    <div class="space-y-1">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">theme_list.js æ’å…¥ç‰‡æ®µ</span>
                        <textarea id="output-list-js"
                            class="w-full h-20 p-3 bg-gray-900 text-green-400 rounded-xl text-[10px] font-mono"
                            readonly></textarea>
                    </div>
                </div>
            </section>
        </div>
    </div>
    </div>

    <!-- AI è¨­å®š Modal -->
    <div id="ai-settings-modal"
        class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[100] hidden backdrop-blur-sm">
        <div class="glass-card bg-white p-8 w-full max-w-md shadow-2xl">
            <h3 class="text-2xl font-bold text-indigo-900 mb-6 flex items-center gap-2">ğŸ¤– AI è¨­å®š</h3>
            <div class="space-y-4">
                <div class="space-y-2">
                    <label class="text-sm font-bold">Google Gemini API Key</label>
                    <input type="password" id="ai-api-key" placeholder="è²¼ä¸Šä½ çš„ API Key"
                        class="w-full p-3 rounded-xl border border-indigo-100 bg-gray-50 focus:bg-white outline-none">
                    <p class="text-[10px] text-gray-500">é‡‘é‘°å°‡å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ (LocalStorage)ã€‚</p>
                </div>
                <div class="pt-4 flex gap-3">
                    <button onclick="document.getElementById('ai-settings-modal').classList.add('hidden')"
                        class="flex-1 py-3 bg-gray-100 rounded-xl font-bold hover:bg-gray-200 transition-colors">å–æ¶ˆ</button>
                    <button onclick="saveAISettings()"
                        class="flex-1 py-3 btn-primary rounded-xl font-bold shadow-lg">å„²å­˜è¨­å®š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay"
        class="fixed inset-0 bg-white/50 backdrop-blur-md flex flex-col items-center justify-center z-[200] hidden">
        <div class="w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <div id="loading-text" class="text-indigo-900 font-bold animate-pulse text-lg">AI æ­£åœ¨æ€è€ƒä¸­...</div>
    </div>

    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let coordinates = [];
        const dom = {
            mapContainer: document.getElementById('map-preview-container'),
            mapImg: document.getElementById('map-preview'),
            pointsLayer: document.getElementById('map-points-layer'),
            pointCountEl: document.getElementById('point-count'),
            undoBtn: document.getElementById('undo-point'),
            overlay: document.getElementById('loading-overlay'),
            loadingText: document.getElementById('loading-text')
        };
        const defaultAvatars = [
            { key: 'bear', file: 'avatar_bear.png' }, { key: 'deer', file: 'avatar_deer.png' },
            { key: 'buffalo', file: 'avatar_buffalo.png' }, { key: 'magpie', file: 'avatar_magpie.png' }
        ];

        // --- åˆå§‹åŒ– ---
        function init() {
            // è¼‰å…¥é è¨­é ­åƒ
            defaultAvatars.forEach(a => addAvatarRow(a.key, a.file));

            // åœ°åœ–ä¸Šå‚³è™•ç†
            document.getElementById('map-upload').addEventListener('change', e => {
                const f = e.target.files[0]; if (!f) return;
                const r = new FileReader(); r.onload = ev => {
                    dom.mapImg.src = ev.target.result;
                    coordinates = []; updatePoints(); generateAll();
                }; r.readAsDataURL(f);
            });

            // åº§æ¨™é»æ“Šè™•ç†
            dom.pointsLayer.addEventListener('click', e => {
                const limit = 20;
                if (coordinates.length >= limit) return alert(`å·²é” ${limit} å€‹é»çš„ä¸Šé™`);
                const r = dom.mapContainer.getBoundingClientRect();
                const top = ((e.clientY - r.top) / r.height * 100).toFixed(1) + "%";
                const left = ((e.clientX - r.left) / r.width * 100).toFixed(1) + "%";
                coordinates.push({ t: top, l: left });
                updatePoints(); generateAll();
            });

            // å¤åŸä¸Šä¸€é»
            dom.undoBtn.onclick = () => { coordinates.pop(); updatePoints(); generateAll(); };

            // è‡ªå‹•æ›´æ–°
            document.querySelectorAll('input, textarea').forEach(el => {
                el.addEventListener('input', generateAll);
            });

            // é è¼‰ API Key
            document.getElementById('ai-api-key').value = localStorage.getItem('GEMINI_API_KEY') || '';

            generateAll();
        }

        // --- åœ°åœ–åº§æ¨™ ---
        function updatePoints() {
            dom.pointsLayer.innerHTML = '';
            coordinates.forEach((c, i) => {
                const p = document.createElement('div');
                p.className = 'map-point';
                p.style.top = c.t; p.style.left = c.l;
                p.textContent = i + 1;
                dom.pointsLayer.appendChild(p);
            });
            dom.pointCountEl.textContent = coordinates.length;
            dom.undoBtn.disabled = coordinates.length === 0;
        }

        // --- è³‡æºèˆ‡é ­åƒ ---
        function addAvatarRow(k = '', f = '') {
            const div = document.createElement('div');
            div.className = 'flex gap-2 avatar-row group';
            div.innerHTML = `
                <input type="text" placeholder="key" class="w-1/3 p-1.5 bg-white border border-indigo-50 rounded-lg text-[10px] avatar-key focus:ring-1 ring-indigo-300 outline-none" value="${k}">
                <input type="text" placeholder="file" class="w-2/3 p-1.5 bg-white border border-indigo-50 rounded-lg text-[10px] avatar-file focus:ring-1 ring-indigo-300 outline-none" value="${f}">
                <button onclick="this.parentElement.remove(); generateAll();" class="text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">âœ–</button>
            `;
            div.querySelectorAll('input').forEach(i => i.addEventListener('input', generateAll));
            document.getElementById('avatar-list').appendChild(div);
        }

        // --- æ ¸å¿ƒ logic ---
        function getVal(id) { return (document.getElementById(id)?.value || '').trim(); }
        function setVal(id, val) {
            const el = document.getElementById(id);
            if (el) { el.value = val; generateAll(); }
        }
        function getList(id) { return getVal(id).split('\n').filter(x => x.trim()).map(x => `"${x.trim().replace(/"/g, '\\"')}"`).join(',\n            '); }
        function getSFX(id) {
            const v = getVal(id); if (!v) return null;
            return v.includes(',') ? `[${v.split(',').map(s => `"${"sound/" + s.trim()}"`).join(', ')}]` : `["sound/${v}"]`;
        }

        function generateAll() {
            const tid = getVal('theme-id') || 'new_theme';

            // ç”¢ç”Ÿé ­åƒå­—ä¸²
            let avStr = [];
            document.querySelectorAll('.avatar-row').forEach(r => {
                const k = r.querySelector('.avatar-key').value.trim();
                const f = r.querySelector('.avatar-file').value.trim();
                if (k && f) avStr.push(`        "${k}": "img/${f}"`);
            });

            // ç”¢ç”Ÿåº§æ¨™å­—ä¸²
            let coStr = coordinates.map(c => `        { top: "${c.t}", left: "${c.l}" }`).join(',\n');
            if (coordinates.length < 20) {
                const remain = 20 - coordinates.length;
                coStr += (coStr ? ',\n' : '') + `        // ... (é‚„éœ€è¦é»æ“Šåœ°åœ–å¢åŠ  ${remain} å€‹é»æ‰èƒ½é–‹å§‹éŠæˆ²)`;
            }

            // ç”¢ç”ŸéŸ³æ•ˆå­—ä¸²
            let sfxArr = [];
            ['click', 'dice', 'move', 'success', 'fail', 'complete', 'bgm'].forEach(k => {
                const val = getSFX('sfx-' + (k === 'bgm' ? 'bgm' : k));
                if (val) sfxArr.push(`        "${k}": ${val}`);
            });

            const themeJs = `window.CURRENT_THEME_CONFIG = {
    GAS_URL: "${getVal('gas-url')}",
    BOARD_COORDINATES: [
${coStr}
    ],
    ASSETS: {
        AVATARS: {
${avStr.join(',\n')}
        },
        IMAGES: {
            "guideNPC": "img/${getVal('img-guideNPC')}",
            "loadingGif": "img/${getVal('img-loadingGif')}",
            "mapBg": "img/${getVal('img-mapBg')}"
        },
        SFX: {
${sfxArr.join(',\n')}
        },
        TEXT: {
            NPC_WELCOME: "${getVal('txt-welcome') || 'æ­¡è¿ä¾†åˆ°æ–°ä¸–ç•Œï¼'}",
            NPC_IDLE_CHATS: [
                ${getList('txt-idle')}
            ],
            MII_ADJECTIVES: [
                ${getList('txt-adj')}
            ],
            MII_NOUNS: [
                ${getList('txt-noun')}
            ]
        }
    }
};`;

            const listEntry = `    {
        id: "${tid}",
        name: "${getVal('theme-name')}",
        description: "${getVal('theme-desc').replace(/\n/g, '\\n')}",
        cover: "img/${getVal('img-mapBg')}"
    },`;

            document.getElementById('output-theme-js').value = themeJs;
            document.getElementById('output-list-js').value = listEntry;
        }

        // --- AI åŠŸèƒ½ ---
        function saveAISettings() {
            const key = document.getElementById('ai-api-key').value.trim();
            localStorage.setItem('GEMINI_API_KEY', key);
            document.getElementById('ai-settings-modal').classList.add('hidden');
        }

        async function aiCall(prompt) {
            const apiKey = localStorage.getItem('GEMINI_API_KEY');
            if (!apiKey) {
                alert("è«‹å…ˆè¨­å®š Gemini API Keyï¼");
                document.getElementById('ai-settings-modal').classList.remove('hidden');
                return null;
            }

            showLoading(true, "AI æ­£åœ¨ç™¼æƒ³å…§å®¹...");
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { response_mime_type: "application/json" }
                    })
                });
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                return JSON.parse(text);
            } catch (err) {
                console.error(err);
                alert("AI å‘¼å«å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯ã€‚" + err.message);
                return null;
            } finally {
                showLoading(false);
            }
        }

        async function aiCompleteInfo() {
            const base = getVal('theme-name') || getVal('theme-id');
            const prompt = `ä½ æ˜¯ä¸€å€‹éŠæˆ²è¨­è¨ˆå¸«ã€‚è«‹é‡å°ä¸»é¡Œã€Œ${base}ã€æä¾›ä»¥ä¸‹ JSON è³‡è¨Šï¼š
            {
                "name": "å¸å¼•äººçš„ä¸»é¡Œåç¨±(å« Emoji)",
                "description": "ç°¡çŸ­çš„ä¸»é¡Œä»‹ç´¹(ç´„ 50 å­—)",
                "welcome": "NPC æ­¡è¿è©",
                "id": "é©ç”¨çš„è‹±æ–‡å°å¯« ID"
            } 
            è«‹ç¹é«”ä¸­æ–‡è¼¸å‡ºã€‚`;
            const result = await aiCall(prompt);
            if (result) {
                setVal('theme-name', result.name);
                setVal('theme-desc', result.description);
                setVal('theme-id', result.id);
                setVal('txt-welcome', result.welcome);
            }
        }

        async function aiGenerateChats() {
            const base = getVal('theme-name');
            const prompt = `é‡å°éŠæˆ²ä¸»é¡Œã€Œ${base}ã€ï¼Œç”Ÿæˆ 10 å¥ NPC çš„é–’èŠå°è«‡(æ¯å¥15å­—ä»¥å…§)ï¼Œ
            è¼¸å‡ºæ ¼å¼å¦‚ï¼š { "chats": ["ç¬¬ä¸€å¥", "ç¬¬äºŒå¥", ...] } 
            ç¹é«”ä¸­æ–‡ã€‚`;
            const result = await aiCall(prompt);
            if (result) setVal('txt-idle', result.chats.join('\n'));
        }

        async function aiGenerateList(type) {
            const base = getVal('theme-name');
            const prompt = `é‡å°éŠæˆ²ä¸»é¡Œã€Œ${base}ã€ï¼Œç”Ÿæˆ 15 å€‹é©åˆç”¨ä¾†éš¨æ©Ÿçµ„åˆæˆè§’è‰²æš±ç¨±çš„ ${type === 'adj' ? 'å½¢å®¹è©' : 'åè©'}ã€‚
            è¼¸å‡ºæ ¼å¼ï¼š { "list": ["è©1", "è©2", ...] }`;
            const result = await aiCall(prompt);
            if (result) setVal('txt-' + type, result.list.join('\n'));
        }

        async function aiGenerateQuestions() {
            const base = getVal('theme-name');
            const prompt = `ä½ æ˜¯ä¸€å€‹å¤§å¯Œç¿é¡Œç›®å°ˆå®¶ã€‚è«‹é‡å°ä¸»é¡Œã€Œ${base}ã€ï¼Œç”Ÿæˆ 20 å€‹é¡Œç›®èˆ‡é¸é …ã€‚
            è¼¸å‡ºæ ¼å¼å¿…é ˆæ˜¯ç´” JSONï¼Œçµæ§‹å¦‚ä¸‹ï¼š
            {
                "map": [
                    {"city": "åœ°é»åç¨±1", "questionId": "q1", "isMustHit": false},
                    ... (å…± 20 å€‹åœ°é»)
                ],
                "questions": {
                    "q1": {"text": "é¡Œç›®å…§å®¹", "options": ["é¸é …1", "é¸é …2", "é¸é …3", "é¸é …4"], "answer": 1},
                    ... (å…± 20 å€‹é¡Œç›®, answer æ˜¯ 1-4 çš„æ•¸å­—)
                }
            }
            è«‹ç¢ºä¿é¡Œç›®èˆ‡ä¸»é¡Œé«˜åº¦ç›¸é—œä¸”æœ‰è¶£ã€‚`;
            const result = await aiCall(prompt);
            if (result) {
                document.getElementById('output-questions-json').value = JSON.stringify(result, null, 2);
            }
        }

        async function aiGenerateImagePrompts() {
            const base = getVal('theme-name');
            const prompt = `é‡å°éŠæˆ²ä¸»é¡Œã€Œ${base}ã€ï¼Œç”Ÿæˆåœ°åœ–èƒŒæ™¯åœ– (map_background.png) èˆ‡ åš®å° NPC (guide_bear.png) çš„ AI ç¹ªåœ–æç¤ºè© (Prompts)ã€‚
            æç¤ºè©è«‹ä½¿ç”¨è‹±æ–‡ï¼Œä¸¦åŒ…å«é¢¨æ ¼æè¿°ï¼ˆå¦‚: vibrant, vector art, isometric, cute etc.ï¼‰ã€‚
            è¼¸å‡ºæ ¼å¼ï¼š { "mapPrompt": "...", "npcPrompt": "..." }`;
            const result = await aiCall(prompt);
            if (result) {
                const el = document.getElementById('ai-img-prompts');
                el.innerHTML = `<strong>Map:</strong> ${result.mapPrompt}<br><br><strong>NPC:</strong> ${result.npcPrompt}`;
                el.classList.remove('hidden');
            }
        }

        // --- å„²å­˜è‡³å°ˆæ¡ˆ ---
        async function saveToProject() {
            if (coordinates.length < 20) return alert("åœ°åœ–åº§æ¨™é»é‚„æ²’è¨­å®šæ»¿ 20 å€‹ï¼");

            showLoading(true, "æ­£åœ¨å„²å­˜è‡³å°ˆæ¡ˆç›®éŒ„...");
            const payload = {
                id: getVal('theme-id'),
                name: getVal('theme-name'),
                description: getVal('theme-desc'),
                themeJs: document.getElementById('output-theme-js').value,
                themeListJs: document.getElementById('output-list-js').value,
                questionsJson: document.getElementById('output-questions-json').value
            };

            try {
                const res = await fetch('/api/save-theme', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.success) {
                    alert("âœ… å„²å­˜æˆåŠŸï¼\nä¸»é¡Œå·²åŠ å…¥ modules è³‡æ–™å¤¾ï¼Œä¸¦æ›´æ–°äº† theme_list.jsã€‚\nç¾åœ¨å¯ä»¥å›ä¸»é é¢çœ‹çµæœäº†ï¼");
                } else {
                    throw new Error(data.error);
                }
            } catch (err) {
                alert("âŒ å„²å­˜å¤±æ•—ï¼š" + err.message + "\n(è«‹ç¢ºèªæ˜¯å¦æ­£å•Ÿå‹•è‘— Vite é–‹ç™¼ä¼ºæœå™¨ npm run dev)");
            } finally {
                showLoading(false);
            }
        }

        // --- UI å°å·¥å…· ---
        function showLoading(show, text) {
            dom.overlay.classList.toggle('hidden', !show);
            if (text) dom.loadingText.textContent = text;
        }

        function toggleCodeView() {
            const target = document.getElementById('code-view');
            const icon = document.getElementById('code-toggle-icon');
            target.classList.toggle('hidden');
            icon.style.transform = target.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(90deg)';
        }

        window.copyToClipboard = (id) => {
            const el = document.getElementById(id);
            el.select();
            document.execCommand('copy');
            const originalText = el.placeholder;
            alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
        };

        init();
    </script>
</body>

</html>