import{F as X,D as R}from"./global_config-vaLYm7Na.js";import{initializeApp as U}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getAuth as he,onAuthStateChanged as pe,signInAnonymously as Se}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import{getDatabase as $,ref as B,get as W,onValue as be,update as Q,serverTimestamp as Te,onDisconnect as ve}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";let w=null,c=null,D,G,V,A,ie,g={map:[],questions:{}},q={},i={nickname:null,avatar:null,currentSquare:0,score:0,squareStates:{},gameCompleted:!1,isAnswering:!1,isMoving:!1,audio:{bgm:.5,sfx:.8}},f,M,I,p={},E=null,S=1,T=0,v=0,re=0,le=0;const l=e=>document.getElementById(e),t={root:l("game-engine-root"),selector:l("theme-selector"),loading:l("loading-screen"),stage:l("game-stage"),mapBg:l("map-bg"),squaresLayer:l("board-squares-layer"),playersLayer:l("players-layer"),guideBubble:l("guide-bubble"),guideImg:l("guide-img"),diceBtn:l("dice-btn"),pInfoBar:l("player-info-bar"),pAvatarBtn:l("player-avatar-btn"),pDetails:l("player-details"),pName:l("info-name"),pScore:l("info-score"),pEditBtn:l("edit-btn"),lbPanel:l("leaderboard-panel"),lbToggle:l("leaderboard-toggle"),lbContent:l("leaderboard-content"),lbList:l("leaderboard-list"),tabLive:l("tab-live"),tabHistory:l("tab-history"),lbIcon:l("lb-icon"),startModal:l("start-modal"),nickInput:l("nickname-input"),rerollBtn:l("reroll-btn"),avatarGrid:l("avatar-grid"),startConfirm:l("start-confirm-btn"),cancelEditBtn:l("cancel-edit-btn"),qaModal:l("qa-modal"),qaCity:l("qa-city"),qaText:l("qa-text"),qaOpts:l("qa-options"),qaFeedback:l("qa-feedback"),qaCloseBtn:l("qa-close-btn"),endModal:l("end-modal"),endMsg:l("end-msg"),endTotal:l("end-total"),endCorrect:l("end-correct"),endReviewBtn:l("end-review-btn"),setModal:l("settings-modal"),setBtn:l("settings-btn"),setCloseBtn:l("settings-close-btn"),volBgm:l("vol-bgm"),volSfx:l("vol-sfx"),volBgmVal:l("vol-bgm-val"),volSfxVal:l("vol-sfx-val"),softReset:l("soft-reset-btn"),hardReset:l("hard-reset-btn"),backMenuBtn:l("back-menu-btn"),zoomIn:l("zoom-in"),zoomOut:l("zoom-out"),zoomReset:l("zoom-reset"),tooltip:l("nickname-tooltip"),startBackBtn:l("start-back-btn")};function we(){typeof UI_TEXT>"u"||(document.querySelectorAll("[data-lang]").forEach(e=>{const a=e.getAttribute("data-lang");UI_TEXT[a]&&(e.textContent=UI_TEXT[a])}),document.title=UI_TEXT.appTitle)}(function(){let a;const n=l("pwa-install-btn"),s=l("ios-install-hint");window.addEventListener("beforeinstallprompt",d=>{d.preventDefault(),a=d,n.classList.remove("hidden")}),n.addEventListener("click",async()=>{if(n.classList.add("hidden"),a){a.prompt();const{outcome:d}=await a.userChoice;console.log(`User response to the install prompt: ${d}`),a=null}});const r=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,o=window.navigator.standalone||window.matchMedia("(display-mode: standalone)").matches;r&&!o&&setTimeout(()=>s.classList.remove("hidden"),3e3)})();(async function(){we();const a=new URLSearchParams(window.location.search);w=a.get("theme");const n=a.get("cloud")==="true";if(!w)Ee();else try{await Ae(w,n),xe()}catch(s){alert(`${UI_TEXT.errThemeLoad}${s.message}
${UI_TEXT.errThemeFile.replace("{id}",w)}`),window.location.search=""}})();async function Ee(){t.selector.classList.remove("hidden");let e=[];try{const a=document.createElement("script");a.src="./modules/theme_list.js",a.onload=()=>{e=window.AVAILABLE_THEMES||[],ae(e)},document.body.appendChild(a)}catch(a){console.error("Local theme list load failed",a)}try{const a=U(X),n=$(a),s=B(n,"available_themes"),r=await W(s);if(r.exists()){const o=Object.values(r.val());ae(e,o)}}catch(a){console.error("Cloud theme list load failed",a)}}function ae(e=[],a=[]){const n=l("theme-list");n.innerHTML="";const s=[...e,...a];if(s.length===0){n.innerHTML=`<div class="col-span-full text-center text-gray-500 font-bold">${UI_TEXT.themeNoData}</div>`;return}s.forEach(r=>{const o=document.createElement("div");o.className="bg-white rounded-3xl shadow-lg hover:shadow-2xl transition-all cursor-pointer transform hover:-translate-y-2 flex flex-col overflow-hidden border border-gray-100 w-full sm:w-80 lg:w-96 group relative";const d=r.isCloud?'<div class="absolute top-4 right-4 bg-blue-500 text-white text-[10px] font-bold px-2 py-1 rounded-full z-10 shadow-sm">‚òÅÔ∏è Èõ≤Á´Ø</div>':"",u=r.isCloud?r.cover:`modules/${r.id}/${r.cover}`;o.innerHTML=`
                    ${d}
                    <div class="relative h-56 overflow-hidden bg-gray-200">
                        <img src="${u}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22%23eee%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23aaa%22>No Image</text></svg>'">
                    </div>
                    <div class="p-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2 group-hover:text-blue-600 transition-colors">${r.name}</h3>
                        <p class="text-gray-600 text-base leading-relaxed whitespace-pre-line">${r.description}</p>
                    </div>
                `,o.onclick=()=>window.location.search=`?theme=${r.id}${r.isCloud?"&cloud=true":""}`,n.appendChild(o)})}async function Ae(e,a=!1){if(a){const n=U(X),s=$(n),r=B(s,`themes/${e}`),o=await W(r);if(o.exists()){const d=o.val(),u=d.assets.SFX||d.assets.sfx||{},L={};for(let b in u){const h=b.replace(/^sfx-/,"");L[h]=u[b]}if(window.CURRENT_THEME_CONFIG={GAS_URL:d.gasUrl,BOARD_COORDINATES:d.coordinates.map(b=>({top:b.top||b.t,left:b.left||b.l})),ASSETS:{AVATARS:d.assets.avatars||{},IMAGES:d.assets.images,SFX:L,TEXT:{NPC_WELCOME:d.assets.text.welcome,NPC_IDLE_CHATS:d.assets.text.idleChats,MII_ADJECTIVES:d.assets.text.adj,MII_NOUNS:d.assets.text.noun}},isCloud:!0},c=window.CURRENT_THEME_CONFIG,typeof R<"u"){for(let b in c.ASSETS.SFX)c.ASSETS.SFX[b]||delete c.ASSETS.SFX[b];c.ASSETS.SFX={...R,...c.ASSETS.SFX}}(function(){const h=c.ASSETS,ee=m=>m&&!m.startsWith("http")&&!m.startsWith("data:")&&!m.startsWith("sound/")?"sound/"+m:m,te=m=>m&&!m.startsWith("http")&&!m.startsWith("data:")&&!m.startsWith("img/")?"img/"+m:m;for(let m in h.SFX)Array.isArray(h.SFX[m])?h.SFX[m]=h.SFX[m].map(ee):h.SFX[m]=ee(h.SFX[m]);for(let m in h.IMAGES)h.IMAGES[m]=te(h.IMAGES[m]);for(let m in h.AVATARS)h.AVATARS[m]=te(h.AVATARS[m])})(),console.log("Theme Loaded (Cloud):",c);return}else throw new Error("Êâæ‰∏çÂà∞Èõ≤Á´Ø‰∏ªÈ°åË®≠ÂÆö")}return new Promise((n,s)=>{const r=document.createElement("script");r.src=`./modules/${e}/theme.js`,r.onload=()=>{if(window.CURRENT_THEME_CONFIG){if(c=window.CURRENT_THEME_CONFIG,ye(c.ASSETS,e),typeof R<"u"){for(let u in c.ASSETS.SFX)c.ASSETS.SFX[u]||delete c.ASSETS.SFX[u];c.ASSETS.SFX={...R,...c.ASSETS.SFX};const o=c.ASSETS,d=u=>u&&!u.startsWith("http")&&!u.startsWith("data:")&&!u.startsWith("sound/")&&!u.startsWith("modules/")?"sound/"+u:u;for(let u in o.SFX)Array.isArray(o.SFX[u])?o.SFX[u]=o.SFX[u].map(d):o.SFX[u]=d(o.SFX[u])}console.log("Theme Loaded (Local):",c),n()}else s(new Error(UI_TEXT.errConfig))},r.onerror=()=>s(new Error(UI_TEXT.errThemeFile)),document.head.appendChild(r)})}function ye(e,a){const n=`modules/${a}/`;for(let s in e.AVATARS)e.AVATARS[s]=n+e.AVATARS[s];for(let s in e.IMAGES){let r=e.IMAGES[s];!r.startsWith("http")&&!r.startsWith("data:")&&(r.startsWith("img/")?e.IMAGES[s]=n+r:e.IMAGES[s]=n+"img/"+r)}for(let s in e.SFX){const r=o=>o.startsWith("http")||o.startsWith("data:")?o:o.startsWith("sound/")?n+o:n+"sound/"+o;Array.isArray(e.SFX[s])?e.SFX[s]=e.SFX[s].map(r):e.SFX[s]=r(e.SFX[s])}}async function xe(){t.selector.classList.add("hidden"),t.root.classList.remove("hidden"),t.loading.querySelector("img").src=c.ASSETS.IMAGES.loadingGif,t.mapBg.onload=()=>Y(),t.mapBg.src=c.ASSETS.IMAGES.mapBg,t.guideImg.src=c.ASSETS.IMAGES.guideNPC,Ne(),Ie(),Ce(),Oe(),await Me(),Y(),i.nickname&&!i.isAnswering||i.nickname&&i.isAnswering?z():(t.loading.classList.add("hidden"),ue(!1))}function Ce(){if(typeof X>"u")return alert(UI_TEXT.errFirebase);const e=U(X);D=$(e),G=he(e),pe(G,a=>{if(a){V=a.uid;const n=`theme_data/${w}/players`;A=B(D,`${n}/${V}`),ie=B(D,n),Le(),i.nickname&&_()}}),Se(G).catch(a=>console.error("Firebase ÁôªÂÖ•Â§±Êïó",a))}function Le(){be(ie,e=>{q=e.val()||{},i.nickname&&(Re(),j())})}function _(){!A||!i.nickname||(Q(A,{nickname:i.nickname,avatar:i.avatar,currentSquare:i.currentSquare,currentScore:i.score,isOnline:!0,lastSeen:Te()}),ve(A).update({isOnline:!1}))}async function Me(){try{let e;if(c.isCloud){const a=U(X),n=$(a),s=B(n,`questions/${w}`),r=await W(s);if(r.exists())e=r.val();else throw new Error("Êâæ‰∏çÂà∞Èõ≤Á´ØÈ°åÁõÆË≥áÊñôÂ∫´")}else if(c.GAS_URL&&c.GAS_URL.startsWith("http"))e=await(await fetch(c.GAS_URL)).json();else{const a=`./modules/${w}/questions.json`,n=await fetch(a);if(!n.ok)throw new Error("Êâæ‰∏çÂà∞Êú¨Âú∞È°åÁõÆÊ™î questions.json Êàñ GAS Á∂≤ÂùÄÁÑ°Êïà");e=await n.json()}if(e.error)throw new Error(e.error);g=e}catch(e){alert(UI_TEXT.errGas+e.message)}}function Ie(){window.AudioContext=window.AudioContext||window.webkitAudioContext,f=new AudioContext,M=f.createGain(),I=f.createGain(),M.connect(f.destination),I.connect(f.destination),P();for(let e in c.ASSETS.SFX){const a=c.ASSETS.SFX[e];Array.isArray(a)?a.forEach(n=>ne(e,n)):ne(e,a)}}async function ne(e,a){try{if(!a)return;const n=String(a).trim();if(n.startsWith("http")){const d=new Audio;d.crossOrigin="anonymous",d.src=n,d.preload="auto";const u=f.createMediaElementSource(d),L=e==="bgm"?M:I;u.connect(L),p[e]||(p[e]=[]),p[e].push({type:"element",data:d,src:n,sourceNode:u});return}const r=await(await fetch(n)).arrayBuffer(),o=await f.decodeAudioData(r);p[e]||(p[e]=[]),p[e].push({type:"buffer",data:o})}catch(n){console.warn("Èü≥ÊïàËºâÂÖ•Â§±Êïó",a,n)}}function x(e){if(!f||!p[e]||p[e].length===0)return;f.state==="suspended"&&f.resume();const a=p[e][Math.floor(Math.random()*p[e].length)];if(a.type==="buffer"){const n=f.createBufferSource();n.buffer=a.data,n.connect(I),n.start(0)}else a.type==="element"&&(a.data.currentTime=0,a.data.play().catch(n=>console.warn("Audio element play failed",n)))}function ke(){if(!f||!p.bgm||E)return;const e=p.bgm[0];e.type==="buffer"?(E=f.createBufferSource(),E.buffer=e.data,E.loop=!0,E.connect(M),E.start(0)):e.type==="element"&&(E=e.data,E.loop=!0,E.play().catch(a=>console.warn("BGM element play failed",a)))}function P(){M&&(M.gain.value=i.audio.bgm),I&&(I.gain.value=i.audio.sfx),t.volBgmVal&&(t.volBgmVal.textContent=Math.round(i.audio.bgm*100)+"%"),t.volSfxVal&&(t.volSfxVal.textContent=Math.round(i.audio.sfx*100)+"%"),t.volBgm.style.backgroundSize=`${i.audio.bgm*100}% 100%`,t.volSfx.style.backgroundSize=`${i.audio.sfx*100}% 100%`,t.volBgm.value=i.audio.bgm,t.volSfx.value=i.audio.sfx}function z(){t.loading.classList.add("hidden"),ke(),_(),de(),Z(),K(),t.diceBtn.disabled=i.gameCompleted||i.isAnswering||i.isMoving,i.isAnswering?ce(i.currentSquare):O(c.ASSETS.TEXT.NPC_WELCOME)}async function qe(){if(i.gameCompleted||i.isAnswering||i.isMoving)return;i.isMoving=!0,t.diceBtn.disabled=!0,x("dice");const e=document.createElement("div");e.className="dice-anim",t.root.appendChild(e);let a=1;for(let n=0;n<10;n++)a=Math.floor(Math.random()*6)+1,e.textContent=a,await new Promise(s=>setTimeout(s,80));await new Promise(n=>setTimeout(n,500)),e.remove(),F(a)}async function F(e){i.isMoving=!0,t.diceBtn.disabled=!0;let a=i.currentSquare,n=c.BOARD_COORDINATES.length,s=(a+e)%n;for(let r=1;r<=e;r++){let o=(a+r)%n;if(g.map[o]?.isMustHit&&g.map[o]?.isVisible!==!1){s=o;break}}for(t.playersLayer.querySelector(".player-piece")?.classList.add("moving");a!==s;)a=(a+1)%n,g.map[a]?.isVisible!==!1&&(i.currentSquare=a,K(),x("move"),await new Promise(r=>setTimeout(r,300)));t.playersLayer.querySelector(".player-piece")?.classList.remove("moving"),C(),_(),Xe(s)}function Xe(e){const a=i.squareStates[e]?.status;a==="success"||a==="failed"||g.map[e]?.isVisible===!1?setTimeout(()=>F(1),500):(i.isMoving=!1,ce(e))}function ce(e){t.diceBtn.disabled=!0;const a=g.map[e];if(!a)return F(1);const n=g.questions[a.questionId];if(!n)return F(1);i.isAnswering=!0,C(),t.qaCity.textContent=a.city,t.qaText.textContent=n.text,t.qaFeedback.textContent="",t.qaCloseBtn.classList.add("hidden"),t.qaOpts.innerHTML="",n.options.map((r,o)=>({t:r,idx:o+1})).sort(()=>Math.random()-.5).forEach(r=>{const o=document.createElement("button");o.className="w-full p-4 bg-blue-50 hover:bg-blue-100 text-blue-900 font-bold rounded-xl border-2 border-blue-200 text-lg text-left transition-all active:scale-95",o.textContent=r.t,o.onclick=()=>Be(e,r.idx,n.answer),t.qaOpts.appendChild(o)}),t.qaModal.classList.remove("hidden")}function Be(e,a,n){i.isAnswering=!1;const s=a===n,r=i.squareStates[e]?.isSecondTry;if(i.squareStates[e]={...i.squareStates[e],selectedOption:a},Array.from(t.qaOpts.children).forEach(o=>o.disabled=!0),s)x("success"),t.qaFeedback.textContent=UI_TEXT.feedbackCorrect,t.qaFeedback.className="text-center text-lg font-bold h-8 text-green-600",i.score++,i.squareStates[e].status="success",setTimeout(oe,1500);else if(x("fail"),t.qaFeedback.textContent=UI_TEXT.feedbackWrong,t.qaFeedback.className="text-center text-lg font-bold h-8 text-red-600",!r)i.squareStates[e].isSecondTry=!0,setTimeout(()=>{t.qaFeedback.textContent=UI_TEXT.feedbackRetry,Array.from(t.qaOpts.children).forEach(o=>o.disabled=!1)},1e3);else{i.squareStates[e].status="failed";const o=g.questions[g.map[e].questionId].options;let d=-1;Array.from(t.qaOpts.children).forEach((u,L)=>{u.textContent===o[n-1]&&(u.classList.add("bg-green-200","border-green-500"),d=L+1)}),O(UI_TEXT.feedbackCorrectIs.replace("{n}",d)),setTimeout(oe,2500)}C(),Z()}function oe(){t.qaModal.classList.add("hidden"),de(),_(),_e(),i.gameCompleted||(t.diceBtn.disabled=!1)}function _e(){if(i.gameCompleted)return;const e=c.BOARD_COORDINATES.length;let a=0,n=0;for(let s=0;s<e;s++)g.map[s]?.isVisible!==!1&&(n++,i.squareStates[s]?.status&&a++);a===n&&n>0&&(x("complete"),i.gameCompleted=!0,C(),A&&W(A).then(s=>{const r=s.val()?.highScore||0;i.score>r&&Q(A,{highScore:i.score})}),t.endMsg.textContent=UI_TEXT.endMsg.replace("{name}",i.nickname),t.endTotal.textContent=n,t.endCorrect.textContent=i.score,t.endModal.classList.remove("hidden"))}function Y(){const e=()=>{const a=t.stage.parentElement.offsetWidth,n=t.stage.parentElement.offsetHeight,s=t.mapBg.naturalWidth||1024,r=t.mapBg.naturalHeight||1366;re=s,le=r;const o=Math.min(a/s,n/r)*.95;t.stage.style.width=s+"px",t.stage.style.height=r+"px",S=o,T=(a-s*o)/2,v=(n-r*o)/2,N()};e(),new ResizeObserver(e).observe(t.stage.parentElement)}function N(){t.stage.style.transform=`translate(${T}px, ${v}px) scale(${S})`}function de(){t.squaresLayer.innerHTML="",c.BOARD_COORDINATES.forEach((e,a)=>{if(g.map[a]?.isVisible===!1)return;const n=document.createElement("div");n.className=`game-square ${g.map[a]?.isMustHit?"must-hit":""}`,n.style.top=e.top,n.style.left=e.left,n.innerHTML=`<span>${g.map[a]?.city||a+1}</span>`;const s=i.squareStates[a]?.status;s==="success"?n.classList.add("square-success"):s==="failed"&&n.classList.add("square-failed"),n.onclick=()=>{i.gameCompleted&&Fe(a)},t.squaresLayer.appendChild(n)})}function K(){let e=t.playersLayer.querySelector("#p-self");e||(e=document.createElement("div"),e.id="p-self",e.className="player-piece",t.playersLayer.appendChild(e)),e.innerHTML=`<img src="${c.ASSETS.AVATARS[i.avatar]}">`;const a=c.BOARD_COORDINATES[i.currentSquare];a&&(e.style.top=a.top,e.style.left=a.left)}function Re(){t.playersLayer.querySelectorAll(".shadow-avatar").forEach(e=>e.remove());for(let e in q){if(e===V||!q[e].isOnline)continue;const a=q[e],n=c.BOARD_COORDINATES[a.currentSquare];if(n){const s=document.createElement("div");s.className="shadow-avatar",s.style.top=n.top,s.style.left=n.left;const r=parseInt(e.substr(0,2),36)%20-10;s.style.transform=`translate(-50%, -50%) translate(${r}px, 20px)`,s.innerHTML=`<img src="${c.ASSETS.AVATARS[a.avatar]||"./avatar_bear.png"}" onerror="this.src='./avatar_bear.png'">`,s.onclick=o=>{o.stopPropagation(),fe(o,a.nickname)},t.playersLayer.appendChild(s)}}}function O(e){t.guideBubble.dataset.busy!=="true"&&(t.guideBubble.textContent=e,t.guideBubble.classList.remove("hidden","opacity-0"),t.guideBubble.classList.add("opacity-100"),clearTimeout(t.guideBubble.timer),t.guideBubble.timer=setTimeout(()=>{t.guideBubble.classList.remove("opacity-100"),t.guideBubble.classList.add("opacity-0"),setTimeout(()=>t.guideBubble.classList.add("hidden"),300)},4e3))}function ue(e){t.nickInput.value=e?i.nickname:ge(),me(),t.cancelEditBtn.classList.toggle("hidden",!e),t.startBackBtn.classList.toggle("hidden",e),t.startModal.classList.remove("hidden"),t.startConfirm.onclick=()=>{const a=t.nickInput.value.trim();if(!a)return H(UI_TEXT.alertNickname,null,null,()=>{});if(!i.avatar)return H(UI_TEXT.alertAvatar,null,null,()=>{});i.nickname=a,C(),t.startModal.classList.add("hidden"),e?(Z(),K(),_()):z()},t.cancelEditBtn.onclick=()=>t.startModal.classList.add("hidden")}function me(){t.avatarGrid.innerHTML="";for(let e in c.ASSETS.AVATARS){const a=document.createElement("button");a.className=`w-16 h-16 rounded-full p-0.5 ring-offset-2 transition-all ${i.avatar===e?"ring-4 ring-blue-500 scale-110":"ring-2 ring-transparent hover:scale-105"}`,a.innerHTML=`<img src="${c.ASSETS.AVATARS[e]}" class="w-full h-full object-cover rounded-full bg-gray-200">`,a.onclick=()=>{x("click"),i.avatar=e,me()},t.avatarGrid.appendChild(a)}}function Z(){t.pName.textContent=i.nickname,t.pScore.textContent=i.score,t.pAvatarBtn.innerHTML=`<img src="${c.ASSETS.AVATARS[i.avatar]}" class="w-full h-full object-cover">`}let y="live";function j(){t.lbList.innerHTML="",Object.values(q).filter(a=>y==="live"?a.isOnline:a.highScore!=null).sort((a,n)=>y==="live"?(n.currentScore||0)-(a.currentScore||0):(n.highScore||0)-(a.highScore||0)).forEach(a=>{const n=document.createElement("li");n.className=`flex items-center p-1.5 rounded-lg ${a.nickname===i.nickname?"bg-blue-100":""}`,n.innerHTML=`<img src="${c.ASSETS.AVATARS[a.avatar]}" class="w-6 h-6 rounded-full mr-2 border bg-gray-200"><span class="truncate flex-1 font-bold text-gray-700 cursor-pointer" title="${a.nickname}">${a.nickname}</span><span class="font-extrabold ${y==="live"?"text-blue-600":"text-yellow-600"}">${y==="live"?a.currentScore||0:a.highScore||0}</span>`,n.onclick=s=>fe(s,a.nickname),t.lbList.appendChild(n)})}function fe(e,a){t.tooltip.textContent=a,t.tooltip.classList.remove("hidden"),t.tooltip.style.opacity=1;const n=t.tooltip.getBoundingClientRect();let s=e.clientY-n.height-10,r=e.clientX-n.width/2;s<0&&(s=e.clientY+20),r<0&&(r=0),r+n.width>window.innerWidth&&(r=window.innerWidth-n.width),t.tooltip.style.top=s+"px",t.tooltip.style.left=r+"px",setTimeout(()=>{t.tooltip.style.opacity=0,setTimeout(()=>t.tooltip.classList.add("hidden"),300)},2e3)}function Fe(e){const a=g.map[e],n=g.questions[a.questionId],s=i.squareStates[e];t.qaCity.textContent=a.city+UI_TEXT.reviewTitleSuffix,t.qaText.textContent=n.text,t.qaFeedback.textContent="",t.qaCloseBtn.classList.remove("hidden"),t.qaOpts.innerHTML="",n.options.forEach((r,o)=>{const d=document.createElement("div");d.className=`w-full p-3 rounded-xl border-2 text-lg font-bold mb-2 ${o+1===n.answer?"bg-green-100 border-green-500 text-green-900":s?.selectedOption===o+1?"bg-red-100 border-red-500 text-red-900":"bg-gray-50 border-gray-200 text-gray-400"}`,d.textContent=r+(o+1===n.answer?UI_TEXT.tagCorrect:s?.selectedOption===o+1?UI_TEXT.tagWrong:""),t.qaOpts.appendChild(d)}),t.qaModal.classList.remove("hidden")}function H(e,a,n,s){l("custom-modal-title").textContent=e||"ÊèêÁ§∫",l("custom-modal-msg").textContent=a,l("custom-modal-confirm").onclick=()=>{l("custom-modal").classList.add("hidden"),n&&n()},l("custom-modal-cancel").onclick=()=>{l("custom-modal").classList.add("hidden"),s&&s()},l("custom-modal-cancel").classList.toggle("hidden",!s),l("custom-modal").classList.remove("hidden"),setTimeout(()=>l("custom-modal-content").classList.remove("scale-95","opacity-0"),10)}function Ne(){const e=localStorage.getItem("TM_"+w);e&&(i={...i,...JSON.parse(e)})}function C(){localStorage.setItem("TM_"+w,JSON.stringify(i))}function ge(){const e=c.ASSETS.TEXT.MII_ADJECTIVES,a=c.ASSETS.TEXT.MII_NOUNS;return e[Math.floor(Math.random()*e.length)]+a[Math.floor(Math.random()*a.length)]}function Oe(){document.addEventListener("click",o=>{f&&f.state==="suspended"&&f.resume(),(o.target.tagName==="BUTTON"||o.target.closest("button")||o.target.classList.contains("game-square"))&&x("click")});let e=!1,a,n,s=0;const r=o=>o.closest(".ui-element")||o.closest(".modal-container");t.root.addEventListener("mousedown",o=>{r(o.target)||(e=!0,a=o.clientX-T,n=o.clientY-v,t.stage.style.cursor="grabbing")}),window.addEventListener("mousemove",o=>{e&&(T=o.clientX-a,v=o.clientY-n,J(),N())}),window.addEventListener("mouseup",()=>{e=!1,t.stage.style.cursor="grab"}),t.root.addEventListener("wheel",o=>{r(o.target)||(o.preventDefault(),k(o.deltaY>0?.9:1.1,o.clientX,o.clientY))},{passive:!1}),t.root.addEventListener("dblclick",o=>{r(o.target)||k(S>1.5?1/S*He():2,o.clientX,o.clientY)}),t.root.addEventListener("touchstart",o=>{r(o.target)||(o.touches.length===2?s=Math.hypot(o.touches[0].clientX-o.touches[1].clientX,o.touches[0].clientY-o.touches[1].clientY):o.touches.length===1&&(e=!0,a=o.touches[0].clientX-T,n=o.touches[0].clientY-v))}),t.root.addEventListener("touchmove",o=>{if(o.touches.length===2){const d=Math.hypot(o.touches[0].clientX-o.touches[1].clientX,o.touches[0].clientY-o.touches[1].clientY);k(d/s,(o.touches[0].clientX+o.touches[1].clientX)/2,(o.touches[0].clientY+o.touches[1].clientY)/2),s=d}else e&&o.touches.length===1&&(T=o.touches[0].clientX-a,v=o.touches[0].clientY-n,J(),N())}),t.root.addEventListener("touchend",()=>e=!1),t.rerollBtn.onclick=()=>t.nickInput.value=ge(),t.pAvatarBtn.onclick=()=>{const o=t.pDetails.classList.contains("scale-0");t.pDetails.classList.toggle("scale-0",!o),t.pDetails.classList.toggle("opacity-0",!o),t.pDetails.classList.toggle("pointer-events-none",!o)},t.pEditBtn.onclick=()=>ue(!0),t.lbToggle.onclick=()=>{const o=t.lbContent.classList.contains("scale-0");t.lbContent.classList.toggle("scale-0",!o),t.lbContent.classList.toggle("opacity-0",!o),t.lbIcon.textContent=o?"‚úñÔ∏è":"üèÜ"},t.tabLive.onclick=()=>{y="live",se(),j()},t.tabHistory.onclick=()=>{y="history",se(),j()},t.setBtn.onclick=()=>t.setModal.classList.remove("hidden"),t.setCloseBtn.onclick=()=>{t.setModal.classList.add("hidden"),C()},t.volBgm.oninput=o=>{i.audio.bgm=o.target.value,P()},t.volSfx.oninput=o=>{i.audio.sfx=o.target.value,P()},t.startBackBtn.onclick=()=>window.location.search="",t.softReset.onclick=()=>H(UI_TEXT.alertSoftResetTitle,UI_TEXT.alertSoftResetMsg,()=>{i.currentSquare=0,i.score=0,i.squareStates={},i.gameCompleted=!1,i.isAnswering=!1,C(),window.location.reload()},()=>{}),t.hardReset.onclick=()=>H(UI_TEXT.alertHardResetTitle,UI_TEXT.alertHardResetMsg,async()=>{A&&await Q(A,{isOnline:!1}),localStorage.removeItem("TM_"+w),window.location.reload()},()=>{}),t.backMenuBtn.onclick=()=>window.location.search="",t.qaCloseBtn.onclick=()=>t.qaModal.classList.add("hidden"),t.endReviewBtn.onclick=()=>{t.endModal.classList.add("hidden"),O(UI_TEXT.guideReviewMode)},t.zoomIn.onclick=()=>k(1.2,window.innerWidth/2,window.innerHeight/2),t.zoomOut.onclick=()=>k(.8,window.innerWidth/2,window.innerHeight/2),t.zoomReset.onclick=Y,t.guideImg.onclick=()=>O(c.ASSETS.TEXT.NPC_IDLE_CHATS[Math.floor(Math.random()*c.ASSETS.TEXT.NPC_IDLE_CHATS.length)]),t.diceBtn.onclick=qe}function He(){const e=t.stage.parentElement.offsetWidth,a=t.stage.parentElement.offsetHeight,n=t.mapBg.naturalWidth||1024,s=t.mapBg.naturalHeight||1366;return Math.min(e/n,a/s)*.95}function k(e,a,n){const s=S;S*=e,S=Math.max(.5,Math.min(S,5)),T=a-(a-T)*(S/s),v=n-(n-v)*(S/s),J(),N()}function J(){const e=re*S,a=le*S,n=window.innerWidth,s=window.innerHeight;e<=n?T=(n-e)/2:T=Math.min(0,Math.max(T,n-e)),a<=s?v=(s-a)/2:v=Math.min(0,Math.max(v,s-a))}function se(){t.tabLive.className=`flex-1 py-1 px-2 text-sm font-bold rounded-lg mr-1 ${y==="live"?"bg-blue-500 text-white":"bg-gray-200 text-gray-600"}`,t.tabHistory.className=`flex-1 py-1 px-2 text-sm font-bold rounded-lg ml-1 ${y==="history"?"bg-blue-500 text-white":"bg-gray-200 text-gray-600"}`}
