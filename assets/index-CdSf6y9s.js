import{initializeApp as U}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getAuth as me,onAuthStateChanged as fe,signInAnonymously as pe}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import{getDatabase as H,ref as L,get as F,onValue as ge,remove as he,update as te,serverTimestamp as be,onDisconnect as Se}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const d of o.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&s(d)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();const M={apiKey:"AIzaSyCtygC4r9KJaUt9KSXUNtGEPy50yCL_MHk",authDomain:"monopolygame-36a8f.firebaseapp.com",databaseURL:"https://monopolygame-36a8f-default-rtdb.firebaseio.com",projectId:"monopolygame-36a8f",storageBucket:"monopolygame-36a8f.firebasestorage.app",messagingSenderId:"781810728105",appId:"1:781810728105:web:a8c80dbe7b67c16f903db8"},_={click:["./sound/click1.mp3","./sound/click2.mp3","./sound/click3.mp3"],dice:["./sound/dice1.mp3","./sound/dice2.mp3"],move:["./sound/move1.mp3","./sound/move2.mp3","./sound/move3.mp3"],success:["./sound/success.mp3"],fail:["./sound/fail.mp3"],complete:["./sound/complete.mp3"]};let S=null,c=null,$,D,G,T,ae,m={map:[],questions:{}},C={},r={nickname:null,avatar:null,currentSquare:0,score:0,squareStates:{},gameCompleted:!1,isAnswering:!1,isMoving:!1,audio:{bgm:.5,sfx:.8}},u,I,q,p={},f=null,g=1,h=0,b=0,ne=0,oe=0;const l=e=>document.getElementById(e),t={root:l("game-engine-root"),selector:l("theme-selector"),loading:l("loading-screen"),stage:l("game-stage"),mapBg:l("map-bg"),squaresLayer:l("board-squares-layer"),playersLayer:l("players-layer"),guideBubble:l("guide-bubble"),guideImg:l("guide-img"),diceBtn:l("dice-btn"),pInfoBar:l("player-info-bar"),pAvatarBtn:l("player-avatar-btn"),pDetails:l("player-details"),pName:l("info-name"),pScore:l("info-score"),pEditBtn:l("edit-btn"),lbPanel:l("leaderboard-panel"),lbToggle:l("leaderboard-toggle"),lbContent:l("leaderboard-content"),lbList:l("leaderboard-list"),tabLive:l("tab-live"),tabHistory:l("tab-history"),lbIcon:l("lb-icon"),startModal:l("start-modal"),nickInput:l("nickname-input"),rerollBtn:l("reroll-btn"),avatarGrid:l("avatar-grid"),startConfirm:l("start-confirm-btn"),cancelEditBtn:l("cancel-edit-btn"),qaModal:l("qa-modal"),qaCity:l("qa-city"),qaText:l("qa-text"),qaOpts:l("qa-options"),qaFeedback:l("qa-feedback"),qaCloseBtn:l("qa-close-btn"),endModal:l("end-modal"),endMsg:l("end-msg"),endTotal:l("end-total"),endCorrect:l("end-correct"),endReviewBtn:l("end-review-btn"),setModal:l("settings-modal"),setBtn:l("settings-btn"),setCloseBtn:l("settings-close-btn"),volBgm:l("vol-bgm"),volSfx:l("vol-sfx"),volBgmVal:l("vol-bgm-val"),volSfxVal:l("vol-sfx-val"),softReset:l("soft-reset-btn"),hardReset:l("hard-reset-btn"),backMenuBtn:l("back-menu-btn"),zoomIn:l("zoom-in"),zoomOut:l("zoom-out"),zoomReset:l("zoom-reset"),tooltip:l("nickname-tooltip"),startBackBtn:l("start-back-btn")};function Te(){typeof UI_TEXT>"u"||(document.querySelectorAll("[data-lang]").forEach(e=>{const a=e.getAttribute("data-lang");UI_TEXT[a]&&(e.textContent=UI_TEXT[a])}),document.title=UI_TEXT.appTitle)}(async function(){Te();const a=new URLSearchParams(window.location.search);S=a.get("theme");const n=a.get("cloud")==="true";if(!S)ve();else try{await ye(S,n),Ee()}catch(s){alert(`${UI_TEXT.errThemeLoad}${s.message}
${UI_TEXT.errThemeFile.replace("{id}",S)}`),window.location.search=""}})();async function ve(){t.selector.classList.remove("hidden");let e=[];try{const a=document.createElement("script");a.src="./modules/theme_list.js",a.onload=()=>{e=window.AVAILABLE_THEMES||[],K(e)},document.body.appendChild(a)}catch(a){console.error("Local theme list load failed",a)}try{const a=U(M),n=H(a),s=L(n,"available_themes"),i=await F(s);if(i.exists()){const o=Object.values(i.val());K(e,o)}}catch(a){console.error("Cloud theme list load failed",a)}}function K(e=[],a=[]){const n=l("theme-list");n.innerHTML="";const s=[...e,...a];if(s.length===0){n.innerHTML=`<div class="col-span-full text-center text-gray-500 font-bold">${UI_TEXT.themeNoData}</div>`;return}s.forEach(i=>{const o=document.createElement("div");o.className="bg-white rounded-3xl shadow-lg hover:shadow-2xl transition-all cursor-pointer transform hover:-translate-y-2 flex flex-col overflow-hidden border border-gray-100 w-full sm:w-80 lg:w-96 group relative";const d=i.isCloud?'<div class="absolute top-4 right-4 bg-blue-500 text-white text-[10px] font-bold px-2 py-1 rounded-full z-10 shadow-sm">‚òÅÔ∏è Èõ≤Á´Ø</div>':"",y=i.isCloud?i.cover:`modules/${i.id}/${i.cover}`;o.innerHTML=`
                    ${d}
                    <div class="relative h-56 overflow-hidden bg-gray-200">
                        <img src="${y}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22%23eee%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23aaa%22>No Image</text></svg>'">
                    </div>
                    <div class="p-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2 group-hover:text-blue-600 transition-colors">${i.name}</h3>
                        <p class="text-gray-600 text-base leading-relaxed whitespace-pre-line">${i.description}</p>
                    </div>
                `,o.onclick=()=>window.location.search=`?theme=${i.id}${i.isCloud?"&cloud=true":""}`,n.appendChild(o)})}async function ye(e,a=!1){if(a){const n=U(M),s=H(n),i=L(s,`themes/${e}`),o=await F(i);if(o.exists()){const d=o.val(),y=d.assets.SFX||d.assets.sfx||{},B={};for(let w in y){const ue=w.replace(/^sfx-/,"");B[ue]=y[w]}window.CURRENT_THEME_CONFIG={GAS_URL:d.gasUrl,BOARD_COORDINATES:d.coordinates.map(w=>({top:w.top||w.t,left:w.left||w.l})),ASSETS:{AVATARS:d.assets.avatars||{},IMAGES:d.assets.images,SFX:B,TEXT:{NPC_WELCOME:d.assets.text.welcome,NPC_IDLE_CHATS:d.assets.text.idleChats,MII_ADJECTIVES:d.assets.text.adj,MII_NOUNS:d.assets.text.noun}},isCloud:!0},c=window.CURRENT_THEME_CONFIG,typeof _<"u"&&(c.ASSETS.SFX={..._,...c.ASSETS.SFX});return}else throw new Error("Êâæ‰∏çÂà∞Èõ≤Á´Ø‰∏ªÈ°åË®≠ÂÆö")}return new Promise((n,s)=>{const i=document.createElement("script");i.src=`./modules/${e}/theme.js`,i.onload=()=>{window.CURRENT_THEME_CONFIG?(c=window.CURRENT_THEME_CONFIG,we(c.ASSETS,e),typeof _<"u"&&(c.ASSETS.SFX={..._,...c.ASSETS.SFX}),n()):s(new Error(UI_TEXT.errConfig))},i.onerror=()=>s(new Error(UI_TEXT.errThemeFile)),document.head.appendChild(i)})}function we(e,a){const n=`modules/${a}/`;for(let s in e.AVATARS)e.AVATARS[s]=n+e.AVATARS[s];for(let s in e.IMAGES)e.IMAGES[s].startsWith("http")||(e.IMAGES[s]=n+e.IMAGES[s]);for(let s in e.SFX)Array.isArray(e.SFX[s])?e.SFX[s]=e.SFX[s].map(i=>i.startsWith("http")?i:n+i):e.SFX[s].startsWith("http")||(e.SFX[s]=n+e.SFX[s])}async function Ee(){t.selector.classList.add("hidden"),t.root.classList.remove("hidden"),t.loading.querySelector("img").src=c.ASSETS.IMAGES.loadingGif,t.mapBg.onload=()=>W(),t.mapBg.src=c.ASSETS.IMAGES.mapBg,t.guideImg.src=c.ASSETS.IMAGES.guideNPC,Re(),Le(),Ae(),Oe(),await Ce(),W(),r.nickname&&!r.isAnswering||r.nickname&&r.isAnswering?P():(t.loading.classList.add("hidden"),re(!1))}function Ae(){if(typeof M>"u")return alert(UI_TEXT.errFirebase);const e=U(M);$=H(e),D=me(e),fe(D,a=>{if(a){G=a.uid;const n=`theme_data/${S}/players`;T=L($,`${n}/${G}`),ae=L($,n),xe(),r.nickname&&k()}}),pe(D).catch(a=>console.error("Firebase ÁôªÂÖ•Â§±Êïó",a))}function xe(){ge(ae,e=>{C=e.val()||{},r.nickname&&(_e(),z())})}function k(){!T||!r.nickname||(te(T,{nickname:r.nickname,avatar:r.avatar,currentSquare:r.currentSquare,currentScore:r.score,isOnline:!0,lastSeen:be()}),Se(T).update({isOnline:!1}))}async function Ce(){try{let e;if(c.isCloud){const a=U(M),n=H(a),s=L(n,`questions/${S}`),i=await F(s);if(i.exists())e=i.val();else throw new Error("Êâæ‰∏çÂà∞Èõ≤Á´ØÈ°åÁõÆË≥áÊñôÂ∫´")}else if(c.GAS_URL&&c.GAS_URL.startsWith("http"))e=await(await fetch(c.GAS_URL)).json();else{const a=`./modules/${S}/questions.json`,n=await fetch(a);if(!n.ok)throw new Error("Êâæ‰∏çÂà∞Êú¨Âú∞È°åÁõÆÊ™î questions.json Êàñ GAS Á∂≤ÂùÄÁÑ°Êïà");e=await n.json()}if(e.error)throw new Error(e.error);m=e}catch(e){alert(UI_TEXT.errGas+e.message)}}function Le(){window.AudioContext=window.AudioContext||window.webkitAudioContext,u=new AudioContext,I=u.createGain(),q=u.createGain(),I.connect(u.destination),q.connect(u.destination),V();for(let e in c.ASSETS.SFX){const a=c.ASSETS.SFX[e];Array.isArray(a)?a.forEach(n=>Q(e,n)):Q(e,a)}}async function Q(e,a){try{if(!a)return;const n=String(a).trim();if(n.startsWith("http")){const d=new Audio;d.crossOrigin="anonymous",d.src=n,d.preload="auto",p[e]||(p[e]=[]),p[e].push({type:"element",data:d,src:n});return}const i=await(await fetch(n)).arrayBuffer(),o=await u.decodeAudioData(i);p[e]||(p[e]=[]),p[e].push({type:"buffer",data:o})}catch(n){console.warn("Èü≥ÊïàËºâÂÖ•Â§±Êïó",a,n)}}function E(e){if(!u||!p[e]||p[e].length===0)return;u.state==="suspended"&&u.resume();const a=p[e][Math.floor(Math.random()*p[e].length)];if(a.type==="buffer"){const n=u.createBufferSource();n.buffer=a.data,n.connect(q),n.start(0)}else if(a.type==="element"){const n=new Audio(a.src);n.volume=r.audio.sfx,n.play().catch(s=>console.warn("Audio element play failed",s))}}function Me(){if(!u||!p.bgm||f)return;const e=p.bgm[0];e.type==="buffer"?(f=u.createBufferSource(),f.buffer=e.data,f.loop=!0,f.connect(I),f.start(0)):e.type==="element"&&(f=e.data,f.loop=!0,f.volume=r.audio.bgm,f.play().catch(a=>console.warn("BGM element play failed",a)))}function V(){I&&(I.gain.value=r.audio.bgm),q&&(q.gain.value=r.audio.sfx),f&&f.tagName==="AUDIO"&&(f.volume=r.audio.bgm),t.volBgmVal&&(t.volBgmVal.textContent=Math.round(r.audio.bgm*100)+"%"),t.volSfxVal&&(t.volSfxVal.textContent=Math.round(r.audio.sfx*100)+"%"),t.volBgm.style.backgroundSize=`${r.audio.bgm*100}% 100%`,t.volSfx.style.backgroundSize=`${r.audio.sfx*100}% 100%`,t.volBgm.value=r.audio.bgm,t.volSfx.value=r.audio.sfx}function P(){t.loading.classList.add("hidden"),Me(),k(),ie(),J(),j(),t.diceBtn.disabled=r.gameCompleted||r.isAnswering||r.isMoving,r.isAnswering?se(r.currentSquare):O(c.ASSETS.TEXT.NPC_WELCOME)}async function Ie(){if(r.gameCompleted||r.isAnswering||r.isMoving)return;r.isMoving=!0,t.diceBtn.disabled=!0,E("dice");const e=document.createElement("div");e.className="dice-anim",t.root.appendChild(e);let a=1;for(let n=0;n<10;n++)a=Math.floor(Math.random()*6)+1,e.textContent=a,await new Promise(s=>setTimeout(s,80));await new Promise(n=>setTimeout(n,500)),e.remove(),X(a)}async function X(e){r.isMoving=!0,t.diceBtn.disabled=!0;let a=r.currentSquare,n=c.BOARD_COORDINATES.length,s=(a+e)%n;for(let i=1;i<=e;i++){let o=(a+i)%n;if(m.map[o]?.isMustHit&&m.map[o]?.isVisible!==!1){s=o;break}}for(t.playersLayer.querySelector(".player-piece")?.classList.add("moving");a!==s;)a=(a+1)%n,m.map[a]?.isVisible!==!1&&(r.currentSquare=a,j(),E("move"),await new Promise(i=>setTimeout(i,300)));t.playersLayer.querySelector(".player-piece")?.classList.remove("moving"),A(),k(),qe(s)}function qe(e){const a=r.squareStates[e]?.status;a==="success"||a==="failed"||m.map[e]?.isVisible===!1?setTimeout(()=>X(1),500):(r.isMoving=!1,se(e))}function se(e){t.diceBtn.disabled=!0;const a=m.map[e];if(!a)return X(1);const n=m.questions[a.questionId];if(!n)return X(1);r.isAnswering=!0,A(),t.qaCity.textContent=a.city,t.qaText.textContent=n.text,t.qaFeedback.textContent="",t.qaCloseBtn.classList.add("hidden"),t.qaOpts.innerHTML="",n.options.map((i,o)=>({t:i,idx:o+1})).sort(()=>Math.random()-.5).forEach(i=>{const o=document.createElement("button");o.className="w-full p-4 bg-blue-50 hover:bg-blue-100 text-blue-900 font-bold rounded-xl border-2 border-blue-200 text-lg text-left transition-all active:scale-95",o.textContent=i.t,o.onclick=()=>ke(e,i.idx,n.answer),t.qaOpts.appendChild(o)}),t.qaModal.classList.remove("hidden")}function ke(e,a,n){r.isAnswering=!1;const s=a===n,i=r.squareStates[e]?.isSecondTry;if(r.squareStates[e]={...r.squareStates[e],selectedOption:a},Array.from(t.qaOpts.children).forEach(o=>o.disabled=!0),s)E("success"),t.qaFeedback.textContent=UI_TEXT.feedbackCorrect,t.qaFeedback.className="text-center text-lg font-bold h-8 text-green-600",r.score++,r.squareStates[e].status="success",setTimeout(Z,1500);else if(E("fail"),t.qaFeedback.textContent=UI_TEXT.feedbackWrong,t.qaFeedback.className="text-center text-lg font-bold h-8 text-red-600",!i)r.squareStates[e].isSecondTry=!0,setTimeout(()=>{t.qaFeedback.textContent=UI_TEXT.feedbackRetry,Array.from(t.qaOpts.children).forEach(o=>o.disabled=!1)},1e3);else{r.squareStates[e].status="failed";const o=m.questions[m.map[e].questionId].options;let d=-1;Array.from(t.qaOpts.children).forEach((y,B)=>{y.textContent===o[n-1]&&(y.classList.add("bg-green-200","border-green-500"),d=B+1)}),O(UI_TEXT.feedbackCorrectIs.replace("{n}",d)),setTimeout(Z,2500)}A(),J()}function Z(){t.qaModal.classList.add("hidden"),ie(),k(),Be(),r.gameCompleted||(t.diceBtn.disabled=!1)}function Be(){if(r.gameCompleted)return;const e=c.BOARD_COORDINATES.length;let a=0,n=0;for(let s=0;s<e;s++)m.map[s]?.isVisible!==!1&&(n++,r.squareStates[s]?.status&&a++);a===n&&n>0&&(E("complete"),r.gameCompleted=!0,A(),T&&F(T).then(s=>{const i=s.val()?.highScore||0;r.score>i&&te(T,{highScore:r.score})}),t.endMsg.textContent=UI_TEXT.endMsg.replace("{name}",r.nickname),t.endTotal.textContent=n,t.endCorrect.textContent=r.score,t.endModal.classList.remove("hidden"))}function W(){const e=()=>{const a=t.stage.parentElement.offsetWidth,n=t.stage.parentElement.offsetHeight,s=t.mapBg.naturalWidth||1024,i=t.mapBg.naturalHeight||1366;ne=s,oe=i;const o=Math.min(a/s,n/i)*.95;t.stage.style.width=s+"px",t.stage.style.height=i+"px",g=o,h=(a-s*o)/2,b=(n-i*o)/2,R()};e(),new ResizeObserver(e).observe(t.stage.parentElement)}function R(){t.stage.style.transform=`translate(${h}px, ${b}px) scale(${g})`}function ie(){t.squaresLayer.innerHTML="",c.BOARD_COORDINATES.forEach((e,a)=>{if(m.map[a]?.isVisible===!1)return;const n=document.createElement("div");n.className=`game-square ${m.map[a]?.isMustHit?"must-hit":""}`,n.style.top=e.top,n.style.left=e.left,n.innerHTML=`<span>${m.map[a]?.city||a+1}</span>`;const s=r.squareStates[a]?.status;s==="success"?n.classList.add("square-success"):s==="failed"&&n.classList.add("square-failed"),n.onclick=()=>{r.gameCompleted&&Xe(a)},t.squaresLayer.appendChild(n)})}function j(){let e=t.playersLayer.querySelector("#p-self");e||(e=document.createElement("div"),e.id="p-self",e.className="player-piece",t.playersLayer.appendChild(e)),e.innerHTML=`<img src="${c.ASSETS.AVATARS[r.avatar]}">`;const a=c.BOARD_COORDINATES[r.currentSquare];a&&(e.style.top=a.top,e.style.left=a.left)}function _e(){t.playersLayer.querySelectorAll(".shadow-avatar").forEach(e=>e.remove());for(let e in C){if(e===G||!C[e].isOnline)continue;const a=C[e],n=c.BOARD_COORDINATES[a.currentSquare];if(n){const s=document.createElement("div");s.className="shadow-avatar",s.style.top=n.top,s.style.left=n.left;const i=parseInt(e.substr(0,2),36)%20-10;s.style.transform=`translate(-50%, -50%) translate(${i}px, 20px)`,s.innerHTML=`<img src="${c.ASSETS.AVATARS[a.avatar]||"./avatar_bear.png"}" onerror="this.src='./avatar_bear.png'">`,s.onclick=o=>{o.stopPropagation(),ce(o,a.nickname)},t.playersLayer.appendChild(s)}}}function O(e){t.guideBubble.dataset.busy!=="true"&&(t.guideBubble.textContent=e,t.guideBubble.classList.remove("hidden","opacity-0"),t.guideBubble.classList.add("opacity-100"),clearTimeout(t.guideBubble.timer),t.guideBubble.timer=setTimeout(()=>{t.guideBubble.classList.remove("opacity-100"),t.guideBubble.classList.add("opacity-0"),setTimeout(()=>t.guideBubble.classList.add("hidden"),300)},4e3))}function re(e){t.nickInput.value=e?r.nickname:de(),le(),t.cancelEditBtn.classList.toggle("hidden",!e),t.startBackBtn.classList.toggle("hidden",e),t.startModal.classList.remove("hidden"),t.startConfirm.onclick=()=>{const a=t.nickInput.value.trim();if(!a)return N(UI_TEXT.alertNickname,null,null,()=>{});if(!r.avatar)return N(UI_TEXT.alertAvatar,null,null,()=>{});r.nickname=a,A(),t.startModal.classList.add("hidden"),e?(J(),j(),k()):P()},t.cancelEditBtn.onclick=()=>t.startModal.classList.add("hidden")}function le(){t.avatarGrid.innerHTML="";for(let e in c.ASSETS.AVATARS){const a=document.createElement("button");a.className=`w-16 h-16 rounded-full p-0.5 ring-offset-2 transition-all ${r.avatar===e?"ring-4 ring-blue-500 scale-110":"ring-2 ring-transparent hover:scale-105"}`,a.innerHTML=`<img src="${c.ASSETS.AVATARS[e]}" class="w-full h-full object-cover rounded-full bg-gray-200">`,a.onclick=()=>{E("click"),r.avatar=e,le()},t.avatarGrid.appendChild(a)}}function J(){t.pName.textContent=r.nickname,t.pScore.textContent=r.score,t.pAvatarBtn.innerHTML=`<img src="${c.ASSETS.AVATARS[r.avatar]}" class="w-full h-full object-cover">`}let v="live";function z(){t.lbList.innerHTML="",Object.values(C).filter(a=>v==="live"?a.isOnline:a.highScore!=null).sort((a,n)=>v==="live"?(n.currentScore||0)-(a.currentScore||0):(n.highScore||0)-(a.highScore||0)).forEach(a=>{const n=document.createElement("li");n.className=`flex items-center p-1.5 rounded-lg ${a.nickname===r.nickname?"bg-blue-100":""}`,n.innerHTML=`<img src="${c.ASSETS.AVATARS[a.avatar]}" class="w-6 h-6 rounded-full mr-2 border bg-gray-200"><span class="truncate flex-1 font-bold text-gray-700 cursor-pointer" title="${a.nickname}">${a.nickname}</span><span class="font-extrabold ${v==="live"?"text-blue-600":"text-yellow-600"}">${v==="live"?a.currentScore||0:a.highScore||0}</span>`,n.onclick=s=>ce(s,a.nickname),t.lbList.appendChild(n)})}function ce(e,a){t.tooltip.textContent=a,t.tooltip.classList.remove("hidden"),t.tooltip.style.opacity=1;const n=t.tooltip.getBoundingClientRect();let s=e.clientY-n.height-10,i=e.clientX-n.width/2;s<0&&(s=e.clientY+20),i<0&&(i=0),i+n.width>window.innerWidth&&(i=window.innerWidth-n.width),t.tooltip.style.top=s+"px",t.tooltip.style.left=i+"px",setTimeout(()=>{t.tooltip.style.opacity=0,setTimeout(()=>t.tooltip.classList.add("hidden"),300)},2e3)}function Xe(e){const a=m.map[e],n=m.questions[a.questionId],s=r.squareStates[e];t.qaCity.textContent=a.city+UI_TEXT.reviewTitleSuffix,t.qaText.textContent=n.text,t.qaFeedback.textContent="",t.qaCloseBtn.classList.remove("hidden"),t.qaOpts.innerHTML="",n.options.forEach((i,o)=>{const d=document.createElement("div");d.className=`w-full p-3 rounded-xl border-2 text-lg font-bold mb-2 ${o+1===n.answer?"bg-green-100 border-green-500 text-green-900":s?.selectedOption===o+1?"bg-red-100 border-red-500 text-red-900":"bg-gray-50 border-gray-200 text-gray-400"}`,d.textContent=i+(o+1===n.answer?UI_TEXT.tagCorrect:s?.selectedOption===o+1?UI_TEXT.tagWrong:""),t.qaOpts.appendChild(d)}),t.qaModal.classList.remove("hidden")}function N(e,a,n,s){l("custom-modal-title").textContent=e||"ÊèêÁ§∫",l("custom-modal-msg").textContent=a,l("custom-modal-confirm").onclick=()=>{l("custom-modal").classList.add("hidden"),n&&n()},l("custom-modal-cancel").onclick=()=>{l("custom-modal").classList.add("hidden"),s&&s()},l("custom-modal-cancel").classList.toggle("hidden",!s),l("custom-modal").classList.remove("hidden"),setTimeout(()=>l("custom-modal-content").classList.remove("scale-95","opacity-0"),10)}function Re(){const e=localStorage.getItem("TM_"+S);e&&(r={...r,...JSON.parse(e)})}function A(){localStorage.setItem("TM_"+S,JSON.stringify(r))}function de(){const e=c.ASSETS.TEXT.MII_ADJECTIVES,a=c.ASSETS.TEXT.MII_NOUNS;return e[Math.floor(Math.random()*e.length)]+a[Math.floor(Math.random()*a.length)]}function Oe(){document.addEventListener("click",o=>{u&&u.state==="suspended"&&u.resume(),(o.target.tagName==="BUTTON"||o.target.closest("button")||o.target.classList.contains("game-square"))&&E("click")});let e=!1,a,n,s=0;const i=o=>o.closest(".ui-element")||o.closest(".modal-container");t.root.addEventListener("mousedown",o=>{i(o.target)||(e=!0,a=o.clientX-h,n=o.clientY-b,t.stage.style.cursor="grabbing")}),window.addEventListener("mousemove",o=>{e&&(h=o.clientX-a,b=o.clientY-n,Y(),R())}),window.addEventListener("mouseup",()=>{e=!1,t.stage.style.cursor="grab"}),t.root.addEventListener("wheel",o=>{i(o.target)||(o.preventDefault(),x(o.deltaY>0?.9:1.1,o.clientX,o.clientY))},{passive:!1}),t.root.addEventListener("dblclick",o=>{i(o.target)||x(g>1.5?1/g*Ne():2,o.clientX,o.clientY)}),t.root.addEventListener("touchstart",o=>{i(o.target)||(o.touches.length===2?s=Math.hypot(o.touches[0].clientX-o.touches[1].clientX,o.touches[0].clientY-o.touches[1].clientY):o.touches.length===1&&(e=!0,a=o.touches[0].clientX-h,n=o.touches[0].clientY-b))}),t.root.addEventListener("touchmove",o=>{if(o.touches.length===2){const d=Math.hypot(o.touches[0].clientX-o.touches[1].clientX,o.touches[0].clientY-o.touches[1].clientY);x(d/s,(o.touches[0].clientX+o.touches[1].clientX)/2,(o.touches[0].clientY+o.touches[1].clientY)/2),s=d}else e&&o.touches.length===1&&(h=o.touches[0].clientX-a,b=o.touches[0].clientY-n,Y(),R())}),t.root.addEventListener("touchend",()=>e=!1),t.rerollBtn.onclick=()=>t.nickInput.value=de(),t.pAvatarBtn.onclick=()=>{const o=t.pDetails.classList.contains("scale-0");t.pDetails.classList.toggle("scale-0",!o),t.pDetails.classList.toggle("opacity-0",!o),t.pDetails.classList.toggle("pointer-events-none",!o)},t.pEditBtn.onclick=()=>re(!0),t.lbToggle.onclick=()=>{const o=t.lbContent.classList.contains("scale-0");t.lbContent.classList.toggle("scale-0",!o),t.lbContent.classList.toggle("opacity-0",!o),t.lbIcon.textContent=o?"‚úñÔ∏è":"üèÜ"},t.tabLive.onclick=()=>{v="live",ee(),z()},t.tabHistory.onclick=()=>{v="history",ee(),z()},t.setBtn.onclick=()=>t.setModal.classList.remove("hidden"),t.setCloseBtn.onclick=()=>{t.setModal.classList.add("hidden"),A()},t.volBgm.oninput=o=>{r.audio.bgm=o.target.value,V()},t.volSfx.oninput=o=>{r.audio.sfx=o.target.value,V()},t.startBackBtn.onclick=()=>window.location.search="",t.softReset.onclick=()=>N(UI_TEXT.alertSoftResetTitle,UI_TEXT.alertSoftResetMsg,()=>{r.currentSquare=0,r.score=0,r.squareStates={},r.gameCompleted=!1,r.isAnswering=!1,A(),window.location.reload()},()=>{}),t.hardReset.onclick=()=>N(UI_TEXT.alertHardResetTitle,UI_TEXT.alertHardResetMsg,()=>{T&&he(T),localStorage.removeItem("TM_"+S),window.location.reload()},()=>{}),t.backMenuBtn.onclick=()=>window.location.search="",t.qaCloseBtn.onclick=()=>t.qaModal.classList.add("hidden"),t.endReviewBtn.onclick=()=>{t.endModal.classList.add("hidden"),O(UI_TEXT.guideReviewMode)},t.zoomIn.onclick=()=>x(1.2,window.innerWidth/2,window.innerHeight/2),t.zoomOut.onclick=()=>x(.8,window.innerWidth/2,window.innerHeight/2),t.zoomReset.onclick=W,t.guideImg.onclick=()=>O(c.ASSETS.TEXT.NPC_IDLE_CHATS[Math.floor(Math.random()*c.ASSETS.TEXT.NPC_IDLE_CHATS.length)]),t.diceBtn.onclick=Ie}function Ne(){const e=t.stage.parentElement.offsetWidth,a=t.stage.parentElement.offsetHeight,n=t.mapBg.naturalWidth||1024,s=t.mapBg.naturalHeight||1366;return Math.min(e/n,a/s)*.95}function x(e,a,n){const s=g;g*=e,g=Math.max(.5,Math.min(g,5)),h=a-(a-h)*(g/s),b=n-(n-b)*(g/s),Y(),R()}function Y(){const e=ne*g,a=oe*g,n=window.innerWidth,s=window.innerHeight;e<=n?h=(n-e)/2:h=Math.min(0,Math.max(h,n-e)),a<=s?b=(s-a)/2:b=Math.min(0,Math.max(b,s-a))}function ee(){t.tabLive.className=`flex-1 py-1 px-2 text-sm font-bold rounded-lg mr-1 ${v==="live"?"bg-blue-500 text-white":"bg-gray-200 text-gray-600"}`,t.tabHistory.className=`flex-1 py-1 px-2 text-sm font-bold rounded-lg ml-1 ${v==="history"?"bg-blue-500 text-white":"bg-gray-200 text-gray-600"}`}
