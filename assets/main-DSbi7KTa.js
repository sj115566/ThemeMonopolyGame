import{F as L,D as X}from"./global_config-Dy5ozYKv.js";import{initializeApp as F}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getAuth as me,onAuthStateChanged as fe,signInAnonymously as ge}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import{getDatabase as U,ref as M,get as H,onValue as he,remove as pe,update as te,serverTimestamp as Se,onDisconnect as be}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";let T=null,c=null,$,D,G,v,ae,m={map:[],questions:{}},C={},i={nickname:null,avatar:null,currentSquare:0,score:0,squareStates:{},gameCompleted:!1,isAnswering:!1,isMoving:!1,audio:{bgm:.5,sfx:.8}},u,I,k,g={},f=null,h=1,p=0,S=0,ne=0,oe=0;const r=e=>document.getElementById(e),t={root:r("game-engine-root"),selector:r("theme-selector"),loading:r("loading-screen"),stage:r("game-stage"),mapBg:r("map-bg"),squaresLayer:r("board-squares-layer"),playersLayer:r("players-layer"),guideBubble:r("guide-bubble"),guideImg:r("guide-img"),diceBtn:r("dice-btn"),pInfoBar:r("player-info-bar"),pAvatarBtn:r("player-avatar-btn"),pDetails:r("player-details"),pName:r("info-name"),pScore:r("info-score"),pEditBtn:r("edit-btn"),lbPanel:r("leaderboard-panel"),lbToggle:r("leaderboard-toggle"),lbContent:r("leaderboard-content"),lbList:r("leaderboard-list"),tabLive:r("tab-live"),tabHistory:r("tab-history"),lbIcon:r("lb-icon"),startModal:r("start-modal"),nickInput:r("nickname-input"),rerollBtn:r("reroll-btn"),avatarGrid:r("avatar-grid"),startConfirm:r("start-confirm-btn"),cancelEditBtn:r("cancel-edit-btn"),qaModal:r("qa-modal"),qaCity:r("qa-city"),qaText:r("qa-text"),qaOpts:r("qa-options"),qaFeedback:r("qa-feedback"),qaCloseBtn:r("qa-close-btn"),endModal:r("end-modal"),endMsg:r("end-msg"),endTotal:r("end-total"),endCorrect:r("end-correct"),endReviewBtn:r("end-review-btn"),setModal:r("settings-modal"),setBtn:r("settings-btn"),setCloseBtn:r("settings-close-btn"),volBgm:r("vol-bgm"),volSfx:r("vol-sfx"),volBgmVal:r("vol-bgm-val"),volSfxVal:r("vol-sfx-val"),softReset:r("soft-reset-btn"),hardReset:r("hard-reset-btn"),backMenuBtn:r("back-menu-btn"),zoomIn:r("zoom-in"),zoomOut:r("zoom-out"),zoomReset:r("zoom-reset"),tooltip:r("nickname-tooltip"),startBackBtn:r("start-back-btn")};function Te(){typeof UI_TEXT>"u"||(document.querySelectorAll("[data-lang]").forEach(e=>{const a=e.getAttribute("data-lang");UI_TEXT[a]&&(e.textContent=UI_TEXT[a])}),document.title=UI_TEXT.appTitle)}(async function(){Te();const a=new URLSearchParams(window.location.search);T=a.get("theme");const n=a.get("cloud")==="true";if(!T)ve();else try{await Ee(T,n),ye()}catch(s){alert(`${UI_TEXT.errThemeLoad}${s.message}
${UI_TEXT.errThemeFile.replace("{id}",T)}`),window.location.search=""}})();async function ve(){t.selector.classList.remove("hidden");let e=[];try{const a=document.createElement("script");a.src="./modules/theme_list.js",a.onload=()=>{e=window.AVAILABLE_THEMES||[],Q(e)},document.body.appendChild(a)}catch(a){console.error("Local theme list load failed",a)}try{const a=F(L),n=U(a),s=M(n,"available_themes"),l=await H(s);if(l.exists()){const o=Object.values(l.val());Q(e,o)}}catch(a){console.error("Cloud theme list load failed",a)}}function Q(e=[],a=[]){const n=r("theme-list");n.innerHTML="";const s=[...e,...a];if(s.length===0){n.innerHTML=`<div class="col-span-full text-center text-gray-500 font-bold">${UI_TEXT.themeNoData}</div>`;return}s.forEach(l=>{const o=document.createElement("div");o.className="bg-white rounded-3xl shadow-lg hover:shadow-2xl transition-all cursor-pointer transform hover:-translate-y-2 flex flex-col overflow-hidden border border-gray-100 w-full sm:w-80 lg:w-96 group relative";const d=l.isCloud?'<div class="absolute top-4 right-4 bg-blue-500 text-white text-[10px] font-bold px-2 py-1 rounded-full z-10 shadow-sm">‚òÅÔ∏è Èõ≤Á´Ø</div>':"",w=l.isCloud?l.cover:`modules/${l.id}/${l.cover}`;o.innerHTML=`
                    ${d}
                    <div class="relative h-56 overflow-hidden bg-gray-200">
                        <img src="${w}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22%23eee%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23aaa%22>No Image</text></svg>'">
                    </div>
                    <div class="p-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2 group-hover:text-blue-600 transition-colors">${l.name}</h3>
                        <p class="text-gray-600 text-base leading-relaxed whitespace-pre-line">${l.description}</p>
                    </div>
                `,o.onclick=()=>window.location.search=`?theme=${l.id}${l.isCloud?"&cloud=true":""}`,n.appendChild(o)})}async function Ee(e,a=!1){if(a){const n=F(L),s=U(n),l=M(s,`themes/${e}`),o=await H(l);if(o.exists()){const d=o.val(),w=d.assets.SFX||d.assets.sfx||{},B={};for(let b in w){const ue=b.replace(/^sfx-/,"");B[ue]=w[b]}if(window.CURRENT_THEME_CONFIG={GAS_URL:d.gasUrl,BOARD_COORDINATES:d.coordinates.map(b=>({top:b.top||b.t,left:b.left||b.l})),ASSETS:{AVATARS:d.assets.avatars||{},IMAGES:d.assets.images,SFX:B,TEXT:{NPC_WELCOME:d.assets.text.welcome,NPC_IDLE_CHATS:d.assets.text.idleChats,MII_ADJECTIVES:d.assets.text.adj,MII_NOUNS:d.assets.text.noun}},isCloud:!0},c=window.CURRENT_THEME_CONFIG,typeof X<"u"){for(let b in c.ASSETS.SFX)c.ASSETS.SFX[b]||delete c.ASSETS.SFX[b];c.ASSETS.SFX={...X,...c.ASSETS.SFX}}return}else throw new Error("Êâæ‰∏çÂà∞Èõ≤Á´Ø‰∏ªÈ°åË®≠ÂÆö")}return new Promise((n,s)=>{const l=document.createElement("script");l.src=`./modules/${e}/theme.js`,l.onload=()=>{if(window.CURRENT_THEME_CONFIG){if(c=window.CURRENT_THEME_CONFIG,we(c.ASSETS,e),typeof X<"u"){for(let o in c.ASSETS.SFX)c.ASSETS.SFX[o]||delete c.ASSETS.SFX[o];c.ASSETS.SFX={...X,...c.ASSETS.SFX}}n()}else s(new Error(UI_TEXT.errConfig))},l.onerror=()=>s(new Error(UI_TEXT.errThemeFile)),document.head.appendChild(l)})}function we(e,a){const n=`modules/${a}/`;for(let s in e.AVATARS)e.AVATARS[s]=n+e.AVATARS[s];for(let s in e.IMAGES)e.IMAGES[s].startsWith("http")||(e.IMAGES[s]=n+e.IMAGES[s]);for(let s in e.SFX)Array.isArray(e.SFX[s])?e.SFX[s]=e.SFX[s].map(l=>l.startsWith("http")?l:n+l):e.SFX[s].startsWith("http")||(e.SFX[s]=n+e.SFX[s])}async function ye(){t.selector.classList.add("hidden"),t.root.classList.remove("hidden"),t.loading.querySelector("img").src=c.ASSETS.IMAGES.loadingGif,t.mapBg.onload=()=>P(),t.mapBg.src=c.ASSETS.IMAGES.mapBg,t.guideImg.src=c.ASSETS.IMAGES.guideNPC,Re(),Le(),Ae(),Ne(),await Ce(),P(),i.nickname&&!i.isAnswering||i.nickname&&i.isAnswering?W():(t.loading.classList.add("hidden"),re(!1))}function Ae(){if(typeof L>"u")return alert(UI_TEXT.errFirebase);const e=F(L);$=U(e),D=me(e),fe(D,a=>{if(a){G=a.uid;const n=`theme_data/${T}/players`;v=M($,`${n}/${G}`),ae=M($,n),xe(),i.nickname&&q()}}),ge(D).catch(a=>console.error("Firebase ÁôªÂÖ•Â§±Êïó",a))}function xe(){he(ae,e=>{C=e.val()||{},i.nickname&&(Xe(),Y())})}function q(){!v||!i.nickname||(te(v,{nickname:i.nickname,avatar:i.avatar,currentSquare:i.currentSquare,currentScore:i.score,isOnline:!0,lastSeen:Se()}),be(v).update({isOnline:!1}))}async function Ce(){try{let e;if(c.isCloud){const a=F(L),n=U(a),s=M(n,`questions/${T}`),l=await H(s);if(l.exists())e=l.val();else throw new Error("Êâæ‰∏çÂà∞Èõ≤Á´ØÈ°åÁõÆË≥áÊñôÂ∫´")}else if(c.GAS_URL&&c.GAS_URL.startsWith("http"))e=await(await fetch(c.GAS_URL)).json();else{const a=`./modules/${T}/questions.json`,n=await fetch(a);if(!n.ok)throw new Error("Êâæ‰∏çÂà∞Êú¨Âú∞È°åÁõÆÊ™î questions.json Êàñ GAS Á∂≤ÂùÄÁÑ°Êïà");e=await n.json()}if(e.error)throw new Error(e.error);m=e}catch(e){alert(UI_TEXT.errGas+e.message)}}function Le(){window.AudioContext=window.AudioContext||window.webkitAudioContext,u=new AudioContext,I=u.createGain(),k=u.createGain(),I.connect(u.destination),k.connect(u.destination),V();for(let e in c.ASSETS.SFX){const a=c.ASSETS.SFX[e];Array.isArray(a)?a.forEach(n=>K(e,n)):K(e,a)}}async function K(e,a){try{if(!a)return;const n=String(a).trim();if(n.startsWith("http")){const d=new Audio;d.crossOrigin="anonymous",d.src=n,d.preload="auto",g[e]||(g[e]=[]),g[e].push({type:"element",data:d,src:n});return}const l=await(await fetch(n)).arrayBuffer(),o=await u.decodeAudioData(l);g[e]||(g[e]=[]),g[e].push({type:"buffer",data:o})}catch(n){console.warn("Èü≥ÊïàËºâÂÖ•Â§±Êïó",a,n)}}function y(e){if(!u||!g[e]||g[e].length===0)return;u.state==="suspended"&&u.resume();const a=g[e][Math.floor(Math.random()*g[e].length)];if(a.type==="buffer"){const n=u.createBufferSource();n.buffer=a.data,n.connect(k),n.start(0)}else if(a.type==="element"){const n=new Audio(a.src);n.volume=i.audio.sfx,n.play().catch(s=>console.warn("Audio element play failed",s))}}function Me(){if(!u||!g.bgm||f)return;const e=g.bgm[0];e.type==="buffer"?(f=u.createBufferSource(),f.buffer=e.data,f.loop=!0,f.connect(I),f.start(0)):e.type==="element"&&(f=e.data,f.loop=!0,f.volume=i.audio.bgm,f.play().catch(a=>console.warn("BGM element play failed",a)))}function V(){I&&(I.gain.value=i.audio.bgm),k&&(k.gain.value=i.audio.sfx),f&&f.tagName==="AUDIO"&&(f.volume=i.audio.bgm),t.volBgmVal&&(t.volBgmVal.textContent=Math.round(i.audio.bgm*100)+"%"),t.volSfxVal&&(t.volSfxVal.textContent=Math.round(i.audio.sfx*100)+"%"),t.volBgm.style.backgroundSize=`${i.audio.bgm*100}% 100%`,t.volSfx.style.backgroundSize=`${i.audio.sfx*100}% 100%`,t.volBgm.value=i.audio.bgm,t.volSfx.value=i.audio.sfx}function W(){t.loading.classList.add("hidden"),Me(),q(),ie(),J(),j(),t.diceBtn.disabled=i.gameCompleted||i.isAnswering||i.isMoving,i.isAnswering?se(i.currentSquare):N(c.ASSETS.TEXT.NPC_WELCOME)}async function Ie(){if(i.gameCompleted||i.isAnswering||i.isMoving)return;i.isMoving=!0,t.diceBtn.disabled=!0,y("dice");const e=document.createElement("div");e.className="dice-anim",t.root.appendChild(e);let a=1;for(let n=0;n<10;n++)a=Math.floor(Math.random()*6)+1,e.textContent=a,await new Promise(s=>setTimeout(s,80));await new Promise(n=>setTimeout(n,500)),e.remove(),_(a)}async function _(e){i.isMoving=!0,t.diceBtn.disabled=!0;let a=i.currentSquare,n=c.BOARD_COORDINATES.length,s=(a+e)%n;for(let l=1;l<=e;l++){let o=(a+l)%n;if(m.map[o]?.isMustHit&&m.map[o]?.isVisible!==!1){s=o;break}}for(t.playersLayer.querySelector(".player-piece")?.classList.add("moving");a!==s;)a=(a+1)%n,m.map[a]?.isVisible!==!1&&(i.currentSquare=a,j(),y("move"),await new Promise(l=>setTimeout(l,300)));t.playersLayer.querySelector(".player-piece")?.classList.remove("moving"),A(),q(),ke(s)}function ke(e){const a=i.squareStates[e]?.status;a==="success"||a==="failed"||m.map[e]?.isVisible===!1?setTimeout(()=>_(1),500):(i.isMoving=!1,se(e))}function se(e){t.diceBtn.disabled=!0;const a=m.map[e];if(!a)return _(1);const n=m.questions[a.questionId];if(!n)return _(1);i.isAnswering=!0,A(),t.qaCity.textContent=a.city,t.qaText.textContent=n.text,t.qaFeedback.textContent="",t.qaCloseBtn.classList.add("hidden"),t.qaOpts.innerHTML="",n.options.map((l,o)=>({t:l,idx:o+1})).sort(()=>Math.random()-.5).forEach(l=>{const o=document.createElement("button");o.className="w-full p-4 bg-blue-50 hover:bg-blue-100 text-blue-900 font-bold rounded-xl border-2 border-blue-200 text-lg text-left transition-all active:scale-95",o.textContent=l.t,o.onclick=()=>qe(e,l.idx,n.answer),t.qaOpts.appendChild(o)}),t.qaModal.classList.remove("hidden")}function qe(e,a,n){i.isAnswering=!1;const s=a===n,l=i.squareStates[e]?.isSecondTry;if(i.squareStates[e]={...i.squareStates[e],selectedOption:a},Array.from(t.qaOpts.children).forEach(o=>o.disabled=!0),s)y("success"),t.qaFeedback.textContent=UI_TEXT.feedbackCorrect,t.qaFeedback.className="text-center text-lg font-bold h-8 text-green-600",i.score++,i.squareStates[e].status="success",setTimeout(Z,1500);else if(y("fail"),t.qaFeedback.textContent=UI_TEXT.feedbackWrong,t.qaFeedback.className="text-center text-lg font-bold h-8 text-red-600",!l)i.squareStates[e].isSecondTry=!0,setTimeout(()=>{t.qaFeedback.textContent=UI_TEXT.feedbackRetry,Array.from(t.qaOpts.children).forEach(o=>o.disabled=!1)},1e3);else{i.squareStates[e].status="failed";const o=m.questions[m.map[e].questionId].options;let d=-1;Array.from(t.qaOpts.children).forEach((w,B)=>{w.textContent===o[n-1]&&(w.classList.add("bg-green-200","border-green-500"),d=B+1)}),N(UI_TEXT.feedbackCorrectIs.replace("{n}",d)),setTimeout(Z,2500)}A(),J()}function Z(){t.qaModal.classList.add("hidden"),ie(),q(),Be(),i.gameCompleted||(t.diceBtn.disabled=!1)}function Be(){if(i.gameCompleted)return;const e=c.BOARD_COORDINATES.length;let a=0,n=0;for(let s=0;s<e;s++)m.map[s]?.isVisible!==!1&&(n++,i.squareStates[s]?.status&&a++);a===n&&n>0&&(y("complete"),i.gameCompleted=!0,A(),v&&H(v).then(s=>{const l=s.val()?.highScore||0;i.score>l&&te(v,{highScore:i.score})}),t.endMsg.textContent=UI_TEXT.endMsg.replace("{name}",i.nickname),t.endTotal.textContent=n,t.endCorrect.textContent=i.score,t.endModal.classList.remove("hidden"))}function P(){const e=()=>{const a=t.stage.parentElement.offsetWidth,n=t.stage.parentElement.offsetHeight,s=t.mapBg.naturalWidth||1024,l=t.mapBg.naturalHeight||1366;ne=s,oe=l;const o=Math.min(a/s,n/l)*.95;t.stage.style.width=s+"px",t.stage.style.height=l+"px",h=o,p=(a-s*o)/2,S=(n-l*o)/2,R()};e(),new ResizeObserver(e).observe(t.stage.parentElement)}function R(){t.stage.style.transform=`translate(${p}px, ${S}px) scale(${h})`}function ie(){t.squaresLayer.innerHTML="",c.BOARD_COORDINATES.forEach((e,a)=>{if(m.map[a]?.isVisible===!1)return;const n=document.createElement("div");n.className=`game-square ${m.map[a]?.isMustHit?"must-hit":""}`,n.style.top=e.top,n.style.left=e.left,n.innerHTML=`<span>${m.map[a]?.city||a+1}</span>`;const s=i.squareStates[a]?.status;s==="success"?n.classList.add("square-success"):s==="failed"&&n.classList.add("square-failed"),n.onclick=()=>{i.gameCompleted&&_e(a)},t.squaresLayer.appendChild(n)})}function j(){let e=t.playersLayer.querySelector("#p-self");e||(e=document.createElement("div"),e.id="p-self",e.className="player-piece",t.playersLayer.appendChild(e)),e.innerHTML=`<img src="${c.ASSETS.AVATARS[i.avatar]}">`;const a=c.BOARD_COORDINATES[i.currentSquare];a&&(e.style.top=a.top,e.style.left=a.left)}function Xe(){t.playersLayer.querySelectorAll(".shadow-avatar").forEach(e=>e.remove());for(let e in C){if(e===G||!C[e].isOnline)continue;const a=C[e],n=c.BOARD_COORDINATES[a.currentSquare];if(n){const s=document.createElement("div");s.className="shadow-avatar",s.style.top=n.top,s.style.left=n.left;const l=parseInt(e.substr(0,2),36)%20-10;s.style.transform=`translate(-50%, -50%) translate(${l}px, 20px)`,s.innerHTML=`<img src="${c.ASSETS.AVATARS[a.avatar]||"./avatar_bear.png"}" onerror="this.src='./avatar_bear.png'">`,s.onclick=o=>{o.stopPropagation(),ce(o,a.nickname)},t.playersLayer.appendChild(s)}}}function N(e){t.guideBubble.dataset.busy!=="true"&&(t.guideBubble.textContent=e,t.guideBubble.classList.remove("hidden","opacity-0"),t.guideBubble.classList.add("opacity-100"),clearTimeout(t.guideBubble.timer),t.guideBubble.timer=setTimeout(()=>{t.guideBubble.classList.remove("opacity-100"),t.guideBubble.classList.add("opacity-0"),setTimeout(()=>t.guideBubble.classList.add("hidden"),300)},4e3))}function re(e){t.nickInput.value=e?i.nickname:de(),le(),t.cancelEditBtn.classList.toggle("hidden",!e),t.startBackBtn.classList.toggle("hidden",e),t.startModal.classList.remove("hidden"),t.startConfirm.onclick=()=>{const a=t.nickInput.value.trim();if(!a)return O(UI_TEXT.alertNickname,null,null,()=>{});if(!i.avatar)return O(UI_TEXT.alertAvatar,null,null,()=>{});i.nickname=a,A(),t.startModal.classList.add("hidden"),e?(J(),j(),q()):W()},t.cancelEditBtn.onclick=()=>t.startModal.classList.add("hidden")}function le(){t.avatarGrid.innerHTML="";for(let e in c.ASSETS.AVATARS){const a=document.createElement("button");a.className=`w-16 h-16 rounded-full p-0.5 ring-offset-2 transition-all ${i.avatar===e?"ring-4 ring-blue-500 scale-110":"ring-2 ring-transparent hover:scale-105"}`,a.innerHTML=`<img src="${c.ASSETS.AVATARS[e]}" class="w-full h-full object-cover rounded-full bg-gray-200">`,a.onclick=()=>{y("click"),i.avatar=e,le()},t.avatarGrid.appendChild(a)}}function J(){t.pName.textContent=i.nickname,t.pScore.textContent=i.score,t.pAvatarBtn.innerHTML=`<img src="${c.ASSETS.AVATARS[i.avatar]}" class="w-full h-full object-cover">`}let E="live";function Y(){t.lbList.innerHTML="",Object.values(C).filter(a=>E==="live"?a.isOnline:a.highScore!=null).sort((a,n)=>E==="live"?(n.currentScore||0)-(a.currentScore||0):(n.highScore||0)-(a.highScore||0)).forEach(a=>{const n=document.createElement("li");n.className=`flex items-center p-1.5 rounded-lg ${a.nickname===i.nickname?"bg-blue-100":""}`,n.innerHTML=`<img src="${c.ASSETS.AVATARS[a.avatar]}" class="w-6 h-6 rounded-full mr-2 border bg-gray-200"><span class="truncate flex-1 font-bold text-gray-700 cursor-pointer" title="${a.nickname}">${a.nickname}</span><span class="font-extrabold ${E==="live"?"text-blue-600":"text-yellow-600"}">${E==="live"?a.currentScore||0:a.highScore||0}</span>`,n.onclick=s=>ce(s,a.nickname),t.lbList.appendChild(n)})}function ce(e,a){t.tooltip.textContent=a,t.tooltip.classList.remove("hidden"),t.tooltip.style.opacity=1;const n=t.tooltip.getBoundingClientRect();let s=e.clientY-n.height-10,l=e.clientX-n.width/2;s<0&&(s=e.clientY+20),l<0&&(l=0),l+n.width>window.innerWidth&&(l=window.innerWidth-n.width),t.tooltip.style.top=s+"px",t.tooltip.style.left=l+"px",setTimeout(()=>{t.tooltip.style.opacity=0,setTimeout(()=>t.tooltip.classList.add("hidden"),300)},2e3)}function _e(e){const a=m.map[e],n=m.questions[a.questionId],s=i.squareStates[e];t.qaCity.textContent=a.city+UI_TEXT.reviewTitleSuffix,t.qaText.textContent=n.text,t.qaFeedback.textContent="",t.qaCloseBtn.classList.remove("hidden"),t.qaOpts.innerHTML="",n.options.forEach((l,o)=>{const d=document.createElement("div");d.className=`w-full p-3 rounded-xl border-2 text-lg font-bold mb-2 ${o+1===n.answer?"bg-green-100 border-green-500 text-green-900":s?.selectedOption===o+1?"bg-red-100 border-red-500 text-red-900":"bg-gray-50 border-gray-200 text-gray-400"}`,d.textContent=l+(o+1===n.answer?UI_TEXT.tagCorrect:s?.selectedOption===o+1?UI_TEXT.tagWrong:""),t.qaOpts.appendChild(d)}),t.qaModal.classList.remove("hidden")}function O(e,a,n,s){r("custom-modal-title").textContent=e||"ÊèêÁ§∫",r("custom-modal-msg").textContent=a,r("custom-modal-confirm").onclick=()=>{r("custom-modal").classList.add("hidden"),n&&n()},r("custom-modal-cancel").onclick=()=>{r("custom-modal").classList.add("hidden"),s&&s()},r("custom-modal-cancel").classList.toggle("hidden",!s),r("custom-modal").classList.remove("hidden"),setTimeout(()=>r("custom-modal-content").classList.remove("scale-95","opacity-0"),10)}function Re(){const e=localStorage.getItem("TM_"+T);e&&(i={...i,...JSON.parse(e)})}function A(){localStorage.setItem("TM_"+T,JSON.stringify(i))}function de(){const e=c.ASSETS.TEXT.MII_ADJECTIVES,a=c.ASSETS.TEXT.MII_NOUNS;return e[Math.floor(Math.random()*e.length)]+a[Math.floor(Math.random()*a.length)]}function Ne(){document.addEventListener("click",o=>{u&&u.state==="suspended"&&u.resume(),(o.target.tagName==="BUTTON"||o.target.closest("button")||o.target.classList.contains("game-square"))&&y("click")});let e=!1,a,n,s=0;const l=o=>o.closest(".ui-element")||o.closest(".modal-container");t.root.addEventListener("mousedown",o=>{l(o.target)||(e=!0,a=o.clientX-p,n=o.clientY-S,t.stage.style.cursor="grabbing")}),window.addEventListener("mousemove",o=>{e&&(p=o.clientX-a,S=o.clientY-n,z(),R())}),window.addEventListener("mouseup",()=>{e=!1,t.stage.style.cursor="grab"}),t.root.addEventListener("wheel",o=>{l(o.target)||(o.preventDefault(),x(o.deltaY>0?.9:1.1,o.clientX,o.clientY))},{passive:!1}),t.root.addEventListener("dblclick",o=>{l(o.target)||x(h>1.5?1/h*Oe():2,o.clientX,o.clientY)}),t.root.addEventListener("touchstart",o=>{l(o.target)||(o.touches.length===2?s=Math.hypot(o.touches[0].clientX-o.touches[1].clientX,o.touches[0].clientY-o.touches[1].clientY):o.touches.length===1&&(e=!0,a=o.touches[0].clientX-p,n=o.touches[0].clientY-S))}),t.root.addEventListener("touchmove",o=>{if(o.touches.length===2){const d=Math.hypot(o.touches[0].clientX-o.touches[1].clientX,o.touches[0].clientY-o.touches[1].clientY);x(d/s,(o.touches[0].clientX+o.touches[1].clientX)/2,(o.touches[0].clientY+o.touches[1].clientY)/2),s=d}else e&&o.touches.length===1&&(p=o.touches[0].clientX-a,S=o.touches[0].clientY-n,z(),R())}),t.root.addEventListener("touchend",()=>e=!1),t.rerollBtn.onclick=()=>t.nickInput.value=de(),t.pAvatarBtn.onclick=()=>{const o=t.pDetails.classList.contains("scale-0");t.pDetails.classList.toggle("scale-0",!o),t.pDetails.classList.toggle("opacity-0",!o),t.pDetails.classList.toggle("pointer-events-none",!o)},t.pEditBtn.onclick=()=>re(!0),t.lbToggle.onclick=()=>{const o=t.lbContent.classList.contains("scale-0");t.lbContent.classList.toggle("scale-0",!o),t.lbContent.classList.toggle("opacity-0",!o),t.lbIcon.textContent=o?"‚úñÔ∏è":"üèÜ"},t.tabLive.onclick=()=>{E="live",ee(),Y()},t.tabHistory.onclick=()=>{E="history",ee(),Y()},t.setBtn.onclick=()=>t.setModal.classList.remove("hidden"),t.setCloseBtn.onclick=()=>{t.setModal.classList.add("hidden"),A()},t.volBgm.oninput=o=>{i.audio.bgm=o.target.value,V()},t.volSfx.oninput=o=>{i.audio.sfx=o.target.value,V()},t.startBackBtn.onclick=()=>window.location.search="",t.softReset.onclick=()=>O(UI_TEXT.alertSoftResetTitle,UI_TEXT.alertSoftResetMsg,()=>{i.currentSquare=0,i.score=0,i.squareStates={},i.gameCompleted=!1,i.isAnswering=!1,A(),window.location.reload()},()=>{}),t.hardReset.onclick=()=>O(UI_TEXT.alertHardResetTitle,UI_TEXT.alertHardResetMsg,()=>{v&&pe(v),localStorage.removeItem("TM_"+T),window.location.reload()},()=>{}),t.backMenuBtn.onclick=()=>window.location.search="",t.qaCloseBtn.onclick=()=>t.qaModal.classList.add("hidden"),t.endReviewBtn.onclick=()=>{t.endModal.classList.add("hidden"),N(UI_TEXT.guideReviewMode)},t.zoomIn.onclick=()=>x(1.2,window.innerWidth/2,window.innerHeight/2),t.zoomOut.onclick=()=>x(.8,window.innerWidth/2,window.innerHeight/2),t.zoomReset.onclick=P,t.guideImg.onclick=()=>N(c.ASSETS.TEXT.NPC_IDLE_CHATS[Math.floor(Math.random()*c.ASSETS.TEXT.NPC_IDLE_CHATS.length)]),t.diceBtn.onclick=Ie}function Oe(){const e=t.stage.parentElement.offsetWidth,a=t.stage.parentElement.offsetHeight,n=t.mapBg.naturalWidth||1024,s=t.mapBg.naturalHeight||1366;return Math.min(e/n,a/s)*.95}function x(e,a,n){const s=h;h*=e,h=Math.max(.5,Math.min(h,5)),p=a-(a-p)*(h/s),S=n-(n-S)*(h/s),z(),R()}function z(){const e=ne*h,a=oe*h,n=window.innerWidth,s=window.innerHeight;e<=n?p=(n-e)/2:p=Math.min(0,Math.max(p,n-e)),a<=s?S=(s-a)/2:S=Math.min(0,Math.max(S,s-a))}function ee(){t.tabLive.className=`flex-1 py-1 px-2 text-sm font-bold rounded-lg mr-1 ${E==="live"?"bg-blue-500 text-white":"bg-gray-200 text-gray-600"}`,t.tabHistory.className=`flex-1 py-1 px-2 text-sm font-bold rounded-lg ml-1 ${E==="history"?"bg-blue-500 text-white":"bg-gray-200 text-gray-600"}`}
