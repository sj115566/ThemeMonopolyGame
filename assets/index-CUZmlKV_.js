import{initializeApp as ie}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getAuth as re,onAuthStateChanged as le,signInAnonymously as ce}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import{getDatabase as de,ref as G,onValue as ue,remove as me,update as j,serverTimestamp as fe,onDisconnect as ge,get as pe}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))s(l);new MutationObserver(l=>{for(const a of l)if(a.type==="childList")for(const m of a.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&s(m)}).observe(document,{childList:!0,subtree:!0});function o(l){const a={};return l.integrity&&(a.integrity=l.integrity),l.referrerPolicy&&(a.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?a.credentials="include":l.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(l){if(l.ep)return;l.ep=!0;const a=o(l);fetch(l.href,a)}})();const P={apiKey:"AIzaSyCtygC4r9KJaUt9KSXUNtGEPy50yCL_MHk",authDomain:"monopolygame-36a8f.firebaseapp.com",databaseURL:"https://monopolygame-36a8f-default-rtdb.firebaseio.com",projectId:"monopolygame-36a8f",storageBucket:"monopolygame-36a8f.firebasestorage.app",messagingSenderId:"781810728105",appId:"1:781810728105:web:a8c80dbe7b67c16f903db8"},W={click:["./sound/click1.mp3","./sound/click2.mp3","./sound/click3.mp3"],dice:["./sound/dice1.mp3","./sound/dice2.mp3"],move:["./sound/move1.mp3","./sound/move2.mp3","./sound/move3.mp3"],success:["./sound/success.mp3"],fail:["./sound/fail.mp3"],complete:["./sound/complete.mp3"]};let h=null,c=null,B,_,X,S,J,u={map:[],questions:{}},A={},r={nickname:null,avatar:null,currentSquare:0,score:0,squareStates:{},gameCompleted:!1,isAnswering:!1,audio:{bgm:.5,sfx:.8}},d,L,x,b={},v=null,f=1,g=0,p=0,K=0,Q=0;const i=e=>document.getElementById(e),t={root:i("game-engine-root"),selector:i("theme-selector"),loading:i("loading-screen"),stage:i("game-stage"),mapBg:i("map-bg"),squaresLayer:i("board-squares-layer"),playersLayer:i("players-layer"),guideBubble:i("guide-bubble"),guideImg:i("guide-img"),diceBtn:i("dice-btn"),pInfoBar:i("player-info-bar"),pAvatarBtn:i("player-avatar-btn"),pDetails:i("player-details"),pName:i("info-name"),pScore:i("info-score"),pEditBtn:i("edit-btn"),lbPanel:i("leaderboard-panel"),lbToggle:i("leaderboard-toggle"),lbContent:i("leaderboard-content"),lbList:i("leaderboard-list"),tabLive:i("tab-live"),tabHistory:i("tab-history"),lbIcon:i("lb-icon"),startModal:i("start-modal"),nickInput:i("nickname-input"),rerollBtn:i("reroll-btn"),avatarGrid:i("avatar-grid"),startConfirm:i("start-confirm-btn"),cancelEditBtn:i("cancel-edit-btn"),qaModal:i("qa-modal"),qaCity:i("qa-city"),qaText:i("qa-text"),qaOpts:i("qa-options"),qaFeedback:i("qa-feedback"),qaCloseBtn:i("qa-close-btn"),endModal:i("end-modal"),endMsg:i("end-msg"),endTotal:i("end-total"),endCorrect:i("end-correct"),endReviewBtn:i("end-review-btn"),setModal:i("settings-modal"),setBtn:i("settings-btn"),setCloseBtn:i("settings-close-btn"),volBgm:i("vol-bgm"),volSfx:i("vol-sfx"),softReset:i("soft-reset-btn"),hardReset:i("hard-reset-btn"),backMenuBtn:i("back-menu-btn"),zoomIn:i("zoom-in"),zoomOut:i("zoom-out"),zoomReset:i("zoom-reset"),tooltip:i("nickname-tooltip"),startBackBtn:i("start-back-btn"),themeBackBtn:i("theme-back-btn")};function he(){typeof UI_TEXT>"u"||(document.querySelectorAll("[data-lang]").forEach(e=>{const n=e.getAttribute("data-lang");UI_TEXT[n]&&(e.textContent=UI_TEXT[n])}),document.title=UI_TEXT.appTitle)}(async function(){if(he(),h=new URLSearchParams(window.location.search).get("theme"),!h)be();else try{await Se(h),ye()}catch(o){alert(`${UI_TEXT.errThemeLoad}${o.message}
${UI_TEXT.errThemeFile.replace("{id}",h)}`),window.location.search=""}})();function be(){t.selector.classList.remove("hidden");const e=document.createElement("script");e.src="./modules/theme_list.js",e.onload=()=>{const n=window.AVAILABLE_THEMES||[],o=i("theme-list");if(o.innerHTML="",n.length===0){o.innerHTML=`<div class="col-span-full text-center text-gray-500 font-bold">${UI_TEXT.themeNoData}</div>`;return}n.forEach(s=>{const l=document.createElement("div");l.className="bg-white rounded-3xl shadow-lg hover:shadow-2xl transition-all cursor-pointer transform hover:-translate-y-2 flex flex-col overflow-hidden border border-gray-100 w-full sm:w-80 lg:w-96 group",l.innerHTML=`
                        <div class="relative h-56 overflow-hidden bg-gray-200">
                            <img src="modules/${s.id}/${s.cover}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22%23eee%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23aaa%22>No Image</text></svg>'">
                        </div>
                        <div class="p-6">
                            <h3 class="text-2xl font-bold text-gray-800 mb-2 group-hover:text-blue-600 transition-colors">${s.name}</h3>
                            <p class="text-gray-600 text-base leading-relaxed whitespace-pre-line">${s.description}</p>
                        </div>
                    `,l.onclick=()=>window.location.search=`?theme=${s.id}`,o.appendChild(l)})},e.onerror=()=>i("theme-list").innerHTML=`<div class="col-span-full text-center text-red-500 font-bold">${UI_TEXT.themeReadError}</div>`,document.body.appendChild(e)}function Se(e){return new Promise((n,o)=>{const s=document.createElement("script");s.src=`./modules/${e}/theme.js`,s.onload=()=>{window.CURRENT_THEME_CONFIG?(c=window.CURRENT_THEME_CONFIG,Te(c.ASSETS,e),typeof W<"u"&&(c.ASSETS.SFX={...W,...c.ASSETS.SFX}),n()):o(new Error(UI_TEXT.errConfig))},s.onerror=()=>o(new Error(UI_TEXT.errThemeFile)),document.head.appendChild(s)})}function Te(e,n){const o=`modules/${n}/`;for(let s in e.AVATARS)e.AVATARS[s]=o+e.AVATARS[s];for(let s in e.IMAGES)e.IMAGES[s]=o+e.IMAGES[s];for(let s in e.SFX)Array.isArray(e.SFX[s])?e.SFX[s]=e.SFX[s].map(l=>o+l):e.SFX[s]=o+e.SFX[s]}async function ye(){t.selector.classList.add("hidden"),t.root.classList.remove("hidden"),t.loading.querySelector("img").src=c.ASSETS.IMAGES.loadingGif,t.mapBg.onload=()=>N(),t.mapBg.src=c.ASSETS.IMAGES.mapBg,t.guideImg.src=c.ASSETS.IMAGES.guideNPC,Be(),Ae(),we(),_e(),await Ee(),N(),r.nickname&&!r.isAnswering||r.nickname&&r.isAnswering?O():(t.loading.classList.add("hidden"),te(!1))}function we(){if(typeof P>"u")return alert(UI_TEXT.errFirebase);const e=ie(P);B=de(e),_=re(e),le(_,n=>{if(n){X=n.uid;const o=`theme_data/${h}/players`;S=G(B,`${o}/${X}`),J=G(B,o),ve(),r.nickname&&C()}}),ce(_).catch(n=>console.error("Firebase ç™»å…¥å¤±æ•—",n))}function ve(){ue(J,e=>{A=e.val()||{},r.nickname&&(Ie(),H())})}function C(){!S||!r.nickname||(j(S,{nickname:r.nickname,avatar:r.avatar,currentSquare:r.currentSquare,currentScore:r.score,isOnline:!0,lastSeen:fe()}),ge(S).update({isOnline:!1}))}async function Ee(){try{let e;if(c.GAS_URL&&c.GAS_URL.startsWith("http"))e=await(await fetch(c.GAS_URL)).json();else{const n=`./modules/${h}/questions.json`,o=await fetch(n);if(!o.ok)throw new Error("æ‰¾ä¸åˆ°æœ¬åœ°é¡Œç›®æª” questions.json æˆ– GAS ç¶²å€ç„¡æ•ˆ");e=await o.json()}if(e.error)throw new Error(e.error);u=e}catch(e){alert(UI_TEXT.errGas+e.message)}}function Ae(){window.AudioContext=window.AudioContext||window.webkitAudioContext,d=new AudioContext,L=d.createGain(),x=d.createGain(),L.connect(d.destination),x.connect(d.destination),R();for(let e in c.ASSETS.SFX){const n=c.ASSETS.SFX[e];Array.isArray(n)?n.forEach(o=>V(e,o)):V(e,n)}}async function V(e,n){try{const s=await(await fetch(n)).arrayBuffer(),l=await d.decodeAudioData(s);b[e]||(b[e]=[]),b[e].push(l)}catch{console.warn("éŸ³æ•ˆè¼‰å…¥å¤±æ•—",n)}}function y(e){if(!d||!b[e]||b[e].length===0)return;d.state==="suspended"&&d.resume();const n=d.createBufferSource();n.buffer=b[e][Math.floor(Math.random()*b[e].length)],n.connect(x),n.start(0)}function Le(){!d||!b.bgm||v||(v=d.createBufferSource(),v.buffer=b.bgm[0],v.loop=!0,v.connect(L),v.start(0))}function R(){L&&(L.gain.value=r.audio.bgm),x&&(x.gain.value=r.audio.sfx),t.volBgm.style.backgroundSize=`${r.audio.bgm*100}% 100%`,t.volSfx.style.backgroundSize=`${r.audio.sfx*100}% 100%`}function O(){t.loading.classList.add("hidden"),Le(),C(),ee(),F(),$(),r.isAnswering?Z(r.currentSquare):I(c.ASSETS.TEXT.NPC_WELCOME)}async function xe(){if(r.gameCompleted||r.isAnswering)return;t.diceBtn.disabled=!0,y("dice");const e=document.createElement("div");e.className="dice-anim",t.root.appendChild(e);let n=1;for(let o=0;o<10;o++)n=Math.floor(Math.random()*6)+1,e.textContent=n,await new Promise(s=>setTimeout(s,80));await new Promise(o=>setTimeout(o,500)),e.remove(),k(n)}async function k(e){let n=r.currentSquare,o=c.BOARD_COORDINATES.length,s=(n+e)%o;for(let l=1;l<=e;l++){let a=(n+l)%o;if(u.map[a]?.isMustHit&&u.map[a]?.isVisible!==!1){s=a;break}}for(t.playersLayer.querySelector(".player-piece")?.classList.add("moving");n!==s;)n=(n+1)%o,u.map[n]?.isVisible!==!1&&(r.currentSquare=n,$(),y("move"),await new Promise(l=>setTimeout(l,300)));t.playersLayer.querySelector(".player-piece")?.classList.remove("moving"),w(),C(),t.diceBtn.disabled=!1,Ce(s)}function Ce(e){const n=r.squareStates[e]?.status;n==="success"||n==="failed"||u.map[e]?.isVisible===!1?setTimeout(()=>k(1),500):Z(e)}function Z(e){const n=u.map[e];if(!n)return k(1);const o=u.questions[n.questionId];if(!o)return k(1);r.isAnswering=!0,w(),t.qaCity.textContent=n.city,t.qaText.textContent=o.text,t.qaFeedback.textContent="",t.qaCloseBtn.classList.add("hidden"),t.qaOpts.innerHTML="",o.options.map((l,a)=>({t:l,idx:a+1})).sort(()=>Math.random()-.5).forEach(l=>{const a=document.createElement("button");a.className="w-full p-4 bg-blue-50 hover:bg-blue-100 text-blue-900 font-bold rounded-xl border-2 border-blue-200 text-lg text-left transition-all active:scale-95",a.textContent=l.t,a.onclick=()=>ke(e,l.idx,o.answer),t.qaOpts.appendChild(a)}),t.qaModal.classList.remove("hidden")}function ke(e,n,o){r.isAnswering=!1;const s=n===o,l=r.squareStates[e]?.isSecondTry;if(r.squareStates[e]={...r.squareStates[e],selectedOption:n},Array.from(t.qaOpts.children).forEach(a=>a.disabled=!0),s)y("success"),t.qaFeedback.textContent=UI_TEXT.feedbackCorrect,t.qaFeedback.className="text-center text-lg font-bold h-8 text-green-600",r.score++,r.squareStates[e].status="success",setTimeout(Y,1500);else if(y("fail"),t.qaFeedback.textContent=UI_TEXT.feedbackWrong,t.qaFeedback.className="text-center text-lg font-bold h-8 text-red-600",!l)r.squareStates[e].isSecondTry=!0,setTimeout(()=>{t.qaFeedback.textContent=UI_TEXT.feedbackRetry,Array.from(t.qaOpts.children).forEach(a=>a.disabled=!1)},1e3);else{r.squareStates[e].status="failed";const a=u.questions[u.map[e].questionId].options;let m=-1;Array.from(t.qaOpts.children).forEach((D,se)=>{D.textContent===a[o-1]&&(D.classList.add("bg-green-200","border-green-500"),m=se+1)}),I(UI_TEXT.feedbackCorrectIs.replace("{n}",m)),setTimeout(Y,2500)}w(),F()}function Y(){t.qaModal.classList.add("hidden"),ee(),C(),qe()}function qe(){if(r.gameCompleted)return;const e=c.BOARD_COORDINATES.length;let n=0,o=0;for(let s=0;s<e;s++)u.map[s]?.isVisible!==!1&&(o++,r.squareStates[s]?.status&&n++);n===o&&o>0&&(y("complete"),r.gameCompleted=!0,w(),S&&pe(S).then(s=>{const l=s.val()?.highScore||0;r.score>l&&j(S,{highScore:r.score})}),t.endMsg.textContent=UI_TEXT.endMsg.replace("{name}",r.nickname),t.endTotal.textContent=o,t.endCorrect.textContent=r.score,t.endModal.classList.remove("hidden"))}function N(){const e=()=>{const n=t.stage.parentElement.offsetWidth,o=t.stage.parentElement.offsetHeight,s=t.mapBg.naturalWidth||1024,l=t.mapBg.naturalHeight||1366;K=s,Q=l;const a=Math.min(n/s,o/l)*.95;t.stage.style.width=s+"px",t.stage.style.height=l+"px",f=a,g=(n-s*a)/2,p=(o-l*a)/2,q()};e(),new ResizeObserver(e).observe(t.stage.parentElement)}function q(){t.stage.style.transform=`translate(${g}px, ${p}px) scale(${f})`}function ee(){t.squaresLayer.innerHTML="",c.BOARD_COORDINATES.forEach((e,n)=>{if(u.map[n]?.isVisible===!1)return;const o=document.createElement("div");o.className=`game-square ${u.map[n]?.isMustHit?"must-hit":""}`,o.style.top=e.top,o.style.left=e.left,o.innerHTML=`<span>${u.map[n]?.city||n+1}</span>`;const s=r.squareStates[n]?.status;s==="success"?o.classList.add("square-success"):s==="failed"&&o.classList.add("square-failed"),o.onclick=()=>{r.gameCompleted&&Me(n)},t.squaresLayer.appendChild(o)})}function $(){let e=t.playersLayer.querySelector("#p-self");e||(e=document.createElement("div"),e.id="p-self",e.className="player-piece",t.playersLayer.appendChild(e)),e.innerHTML=`<img src="${c.ASSETS.AVATARS[r.avatar]}">`;const n=c.BOARD_COORDINATES[r.currentSquare];n&&(e.style.top=n.top,e.style.left=n.left)}function Ie(){t.playersLayer.querySelectorAll(".shadow-avatar").forEach(e=>e.remove());for(let e in A){if(e===X||!A[e].isOnline)continue;const n=A[e],o=c.BOARD_COORDINATES[n.currentSquare];if(o){const s=document.createElement("div");s.className="shadow-avatar",s.style.top=o.top,s.style.left=o.left;const l=parseInt(e.substr(0,2),36)%20-10;s.style.transform=`translate(-50%, -50%) translate(${l}px, 20px)`,s.innerHTML=`<img src="${c.ASSETS.AVATARS[n.avatar]||"./avatar_bear.png"}" onerror="this.src='./avatar_bear.png'">`,s.onclick=a=>{a.stopPropagation(),ae(a,n.nickname)},t.playersLayer.appendChild(s)}}}function I(e){t.guideBubble.dataset.busy!=="true"&&(t.guideBubble.textContent=e,t.guideBubble.classList.remove("hidden","opacity-0"),t.guideBubble.classList.add("opacity-100"),clearTimeout(t.guideBubble.timer),t.guideBubble.timer=setTimeout(()=>{t.guideBubble.classList.remove("opacity-100"),t.guideBubble.classList.add("opacity-0"),setTimeout(()=>t.guideBubble.classList.add("hidden"),300)},4e3))}function te(e){t.nickInput.value=e?r.nickname:oe(),ne(),t.cancelEditBtn.classList.toggle("hidden",!e),t.startBackBtn.classList.toggle("hidden",e),t.startModal.classList.remove("hidden"),t.startConfirm.onclick=()=>{const n=t.nickInput.value.trim();if(!n)return M(UI_TEXT.alertNickname,null,null,()=>{});if(!r.avatar)return M(UI_TEXT.alertAvatar,null,null,()=>{});r.nickname=n,w(),t.startModal.classList.add("hidden"),e?(F(),$(),C()):O()},t.cancelEditBtn.onclick=()=>t.startModal.classList.add("hidden")}function ne(){t.avatarGrid.innerHTML="";for(let e in c.ASSETS.AVATARS){const n=document.createElement("button");n.className=`w-16 h-16 rounded-full p-0.5 ring-offset-2 transition-all ${r.avatar===e?"ring-4 ring-blue-500 scale-110":"ring-2 ring-transparent hover:scale-105"}`,n.innerHTML=`<img src="${c.ASSETS.AVATARS[e]}" class="w-full h-full object-cover rounded-full bg-gray-200">`,n.onclick=()=>{y("click"),r.avatar=e,ne()},t.avatarGrid.appendChild(n)}}function F(){t.pName.textContent=r.nickname,t.pScore.textContent=r.score,t.pAvatarBtn.innerHTML=`<img src="${c.ASSETS.AVATARS[r.avatar]}" class="w-full h-full object-cover">`}let T="live";function H(){t.lbList.innerHTML="",Object.values(A).filter(n=>T==="live"?n.isOnline:n.highScore!=null).sort((n,o)=>T==="live"?(o.currentScore||0)-(n.currentScore||0):(o.highScore||0)-(n.highScore||0)).slice(0,10).forEach(n=>{const o=document.createElement("li");o.className=`flex items-center p-1.5 rounded-lg ${n.nickname===r.nickname?"bg-blue-100":""}`,o.innerHTML=`<img src="${c.ASSETS.AVATARS[n.avatar]}" class="w-6 h-6 rounded-full mr-2 border bg-gray-200"><span class="truncate flex-1 font-bold text-gray-700 cursor-pointer" title="${n.nickname}">${n.nickname}</span><span class="font-extrabold ${T==="live"?"text-blue-600":"text-yellow-600"}">${T==="live"?n.currentScore||0:n.highScore||0}</span>`,o.onclick=s=>ae(s,n.nickname),t.lbList.appendChild(o)})}function ae(e,n){t.tooltip.textContent=n,t.tooltip.classList.remove("hidden"),t.tooltip.style.opacity=1;const o=t.tooltip.getBoundingClientRect();let s=e.clientY-o.height-10,l=e.clientX-o.width/2;s<0&&(s=e.clientY+20),l<0&&(l=0),l+o.width>window.innerWidth&&(l=window.innerWidth-o.width),t.tooltip.style.top=s+"px",t.tooltip.style.left=l+"px",setTimeout(()=>{t.tooltip.style.opacity=0,setTimeout(()=>t.tooltip.classList.add("hidden"),300)},2e3)}function Me(e){const n=u.map[e],o=u.questions[n.questionId],s=r.squareStates[e];t.qaCity.textContent=n.city+UI_TEXT.reviewTitleSuffix,t.qaText.textContent=o.text,t.qaFeedback.textContent="",t.qaCloseBtn.classList.remove("hidden"),t.qaOpts.innerHTML="",o.options.forEach((l,a)=>{const m=document.createElement("div");m.className=`w-full p-3 rounded-xl border-2 text-lg font-bold mb-2 ${a+1===o.answer?"bg-green-100 border-green-500 text-green-900":s?.selectedOption===a+1?"bg-red-100 border-red-500 text-red-900":"bg-gray-50 border-gray-200 text-gray-400"}`,m.textContent=l+(a+1===o.answer?UI_TEXT.tagCorrect:s?.selectedOption===a+1?UI_TEXT.tagWrong:""),t.qaOpts.appendChild(m)}),t.qaModal.classList.remove("hidden")}function M(e,n,o,s){i("custom-modal-title").textContent=e||"æç¤º",i("custom-modal-msg").textContent=n,i("custom-modal-confirm").onclick=()=>{i("custom-modal").classList.add("hidden"),o&&o()},i("custom-modal-cancel").onclick=()=>{i("custom-modal").classList.add("hidden"),s&&s()},i("custom-modal-cancel").classList.toggle("hidden",!s),i("custom-modal").classList.remove("hidden"),setTimeout(()=>i("custom-modal-content").classList.remove("scale-95","opacity-0"),10)}function Be(){const e=localStorage.getItem("TM_"+h);e&&(r={...r,...JSON.parse(e)})}function w(){localStorage.setItem("TM_"+h,JSON.stringify(r))}function oe(){const e=c.ASSETS.TEXT.MII_ADJECTIVES,n=c.ASSETS.TEXT.MII_NOUNS;return e[Math.floor(Math.random()*e.length)]+n[Math.floor(Math.random()*n.length)]}function _e(){document.addEventListener("click",a=>{d&&d.state==="suspended"&&d.resume(),(a.target.tagName==="BUTTON"||a.target.closest("button")||a.target.classList.contains("game-square"))&&y("click")});let e=!1,n,o,s=0;const l=a=>a.closest(".ui-element")||a.closest(".modal-container");t.root.addEventListener("mousedown",a=>{l(a.target)||(e=!0,n=a.clientX-g,o=a.clientY-p,t.stage.style.cursor="grabbing")}),window.addEventListener("mousemove",a=>{e&&(g=a.clientX-n,p=a.clientY-o,U(),q())}),window.addEventListener("mouseup",()=>{e=!1,t.stage.style.cursor="grab"}),t.root.addEventListener("wheel",a=>{l(a.target)||(a.preventDefault(),E(a.deltaY>0?.9:1.1,a.clientX,a.clientY))},{passive:!1}),t.root.addEventListener("dblclick",a=>{l(a.target)||E(f>1.5?1/f*Xe():2,a.clientX,a.clientY)}),t.root.addEventListener("touchstart",a=>{l(a.target)||(a.touches.length===2?s=Math.hypot(a.touches[0].clientX-a.touches[1].clientX,a.touches[0].clientY-a.touches[1].clientY):a.touches.length===1&&(e=!0,n=a.touches[0].clientX-g,o=a.touches[0].clientY-p))}),t.root.addEventListener("touchmove",a=>{if(a.touches.length===2){const m=Math.hypot(a.touches[0].clientX-a.touches[1].clientX,a.touches[0].clientY-a.touches[1].clientY);E(m/s,(a.touches[0].clientX+a.touches[1].clientX)/2,(a.touches[0].clientY+a.touches[1].clientY)/2),s=m}else e&&a.touches.length===1&&(g=a.touches[0].clientX-n,p=a.touches[0].clientY-o,U(),q())}),t.root.addEventListener("touchend",()=>e=!1),t.rerollBtn.onclick=()=>t.nickInput.value=oe(),t.pAvatarBtn.onclick=()=>{const a=t.pDetails.classList.contains("scale-0");t.pDetails.classList.toggle("scale-0",!a),t.pDetails.classList.toggle("opacity-0",!a),t.pDetails.classList.toggle("pointer-events-none",!a)},t.pEditBtn.onclick=()=>te(!0),t.lbToggle.onclick=()=>{const a=t.lbContent.classList.contains("scale-0");t.lbContent.classList.toggle("scale-0",!a),t.lbContent.classList.toggle("opacity-0",!a),t.lbIcon.textContent=a?"âœ–ï¸":"ðŸ†"},t.tabLive.onclick=()=>{T="live",z(),H()},t.tabHistory.onclick=()=>{T="history",z(),H()},t.setBtn.onclick=()=>t.setModal.classList.remove("hidden"),t.setCloseBtn.onclick=()=>{t.setModal.classList.add("hidden"),w()},t.volBgm.oninput=a=>{r.audio.bgm=a.target.value,R()},t.volSfx.oninput=a=>{r.audio.sfx=a.target.value,R()},t.startBackBtn.onclick=()=>window.location.search="",t.themeBackBtn.onclick=()=>{window.history.length>1?window.history.back():window.location.href="/"},t.softReset.onclick=()=>M(UI_TEXT.alertSoftResetTitle,UI_TEXT.alertSoftResetMsg,()=>{r.currentSquare=0,r.score=0,r.squareStates={},r.gameCompleted=!1,r.isAnswering=!1,w(),window.location.reload()},()=>{}),t.hardReset.onclick=()=>M(UI_TEXT.alertHardResetTitle,UI_TEXT.alertHardResetMsg,()=>{S&&me(S),localStorage.removeItem("TM_"+h),window.location.reload()},()=>{}),t.backMenuBtn.onclick=()=>window.location.search="",t.qaCloseBtn.onclick=()=>t.qaModal.classList.add("hidden"),t.endReviewBtn.onclick=()=>{t.endModal.classList.add("hidden"),I(UI_TEXT.guideReviewMode)},t.zoomIn.onclick=()=>E(1.2,window.innerWidth/2,window.innerHeight/2),t.zoomOut.onclick=()=>E(.8,window.innerWidth/2,window.innerHeight/2),t.zoomReset.onclick=N,t.guideImg.onclick=()=>I(c.ASSETS.TEXT.NPC_IDLE_CHATS[Math.floor(Math.random()*c.ASSETS.TEXT.NPC_IDLE_CHATS.length)]),t.diceBtn.onclick=xe}function Xe(){const e=t.stage.parentElement.offsetWidth,n=t.stage.parentElement.offsetHeight,o=t.mapBg.naturalWidth||1024,s=t.mapBg.naturalHeight||1366;return Math.min(e/o,n/s)*.95}function E(e,n,o){const s=f;f*=e,f=Math.max(.5,Math.min(f,5)),g=n-(n-g)*(f/s),p=o-(o-p)*(f/s),U(),q()}function U(){const e=K*f,n=Q*f,o=window.innerWidth,s=window.innerHeight;e<=o?g=(o-e)/2:g=Math.min(0,Math.max(g,o-e)),n<=s?p=(s-n)/2:p=Math.min(0,Math.max(p,s-n))}function z(){t.tabLive.className=`flex-1 py-1 px-2 text-sm font-bold rounded-lg mr-1 ${T==="live"?"bg-blue-500 text-white":"bg-gray-200 text-gray-600"}`,t.tabHistory.className=`flex-1 py-1 px-2 text-sm font-bold rounded-lg ml-1 ${T==="history"?"bg-blue-500 text-white":"bg-gray-200 text-gray-600"}`}
